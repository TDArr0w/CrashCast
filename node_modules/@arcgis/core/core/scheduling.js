/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{nextTick as e}from"./nextTick.js";import t from"./PerformanceSampler.js";import n from"./PooledArray.js";import{createResolver as r,isAborted as s,createAbortError as o}from"./promiseUtils.js";import{Milliseconds as a}from"./time.js";class i{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}}class c{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}}let m=0,u=0;const l={time:a(0),deltaTime:a(0),elapsedFrameTime:a(0),frameDuration:a(0)},p=["prepare","preRender","render","postRender","update","finish"],f=[],h=new n;class d{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1,k()}}function w(){null!=T&&(cancelAnimationFrame(T),T=requestAnimationFrame(D))}function k(){null==T&&(m=performance.now(),T=requestAnimationFrame(D))}const v={frameTasks:h,willDispatch:!1,clearFrameTasks:j,dispatch:y,executeFrameTasks:q,reschedule:w};function A(t){const n=new c(t);return f.push(n),v.willDispatch||(v.willDispatch=!0,e(y)),n}function F(e){const t=new i(e);return h.push(t),k(),new d(t)}let T=null;function j(e=!1){h.forAll(e=>{e.removed=!0}),e&&b()}function x(e){u=Math.max(0,e)}function D(){const e=performance.now();T=null;const t=h.some(e=>!e.paused&&!e.removed);T=t?requestAnimationFrame(D):null,v.executeFrameTasks(e)}function q(e){const t=a(e-m);m=e;const n=u>0?u:1e3/60,r=Math.max(0,t-n);l.time=e,l.frameDuration=a(n-r);for(let s=0;s<p.length;s++){const n=performance.now(),r=p[s];h.forAll(n=>{if(n.paused||n.removed)return;0===s&&n.ticks++;n.phases[r]&&(l.elapsedFrameTime=a(performance.now()-e),l.deltaTime=0===n.ticks?a(0):t,n.phases[r]?.call(n,l))}),S[s].push(performance.now()-n)}b(),z.push(performance.now()-e)}const _=new n;function b(){h.forAll(e=>{e.removed&&_.push(e)}),h.removeUnorderedMany(_.data,_.length),_.clear()}function g(){h.prune(),_.prune()}function y(){for(;f.length;){const e=f.shift();e.isActive&&e.callback()}v.willDispatch=!1}function M(t=1,n){const a=r(),i=()=>{s(n)?a.reject(o()):0===t?a():(--t,e(()=>i()))};return i(),a.promise}function P(e){return M(1,e)}function R(){const e=r(),t=F({postRender:()=>{t.remove(),A(e)}});return e.promise}async function U(e){await P(e),await new Promise(t=>requestAnimationFrame(()=>{e?.aborted||t()}))}const S=p.map(e=>new t(e)),z=new t("total");export{d as FrameTaskHandle,F as addFrameTask,g as cleanupScheduling,v as debug,S as performanceInfo,z as performanceTotal,A as schedule,x as setFrameDuration,U as waitAnimationFrame,R as waitRender,P as waitTick,M as waitTicks};
