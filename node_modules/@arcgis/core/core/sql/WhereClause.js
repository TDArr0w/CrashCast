/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import has from"../has.js";import{isAggregate as e,aggregateFunction as t}from"./AggregateFunctions.js";import{DateOnly as r}from"./DateOnly.js";import{SqlError as a}from"./errorSupport.js";import{sqlCalculateFunction as s}from"./sqlArithmeticUtils.js";import{sqlCompare as n,isDateOrTimeValue as i}from"./sqlCompareUtils.js";import{isDateTime as o,isTimestampOffset as u,isTimeOnly as l,isDateOnly as c,parseTime as p,parseTimestamp as m,parseDate as h,convertToExecutingTimeZone as d}from"./sqlDateParsingUtils.js";import{SqlInterval as f}from"./SqlInterval.js";import{SqlTimeStampOffset as _}from"./SqlTimestampOffset.js";import{evaluateFunction as N,isStandardized as g}from"./StandardizedFunctions.js";import{TimeOnly as v}from"./TimeOnly.js";import{WhereGrammar as y,visitAll as S}from"./WhereGrammar.js";import{isDate as T}from"../../support/guards.js";import{DateTime as w,FixedOffsetZone as D}from"luxon";const I=new Set(["current_timestamp","current_date","current_time"]);class x{constructor(e){this.staticData=e}makeBool(e){return R(e)}featureValue(e,t,r,a){return Y(e,t,r,a)}equalsNull(e){return null===e}applyLike(e,t,r){return H(e,t,r)}ensureArray(e){return Z(e)}applyIn(e,t){return M(e,t)}currentTimestamp(e){return W(e)}currentDate(e){return G(e)}currentTime(e){return K(e)}makeSqlInterval(e,t,r){return f.createFromValueAndQualifier(e,t,r)}convertInterval(e){return f.isInterval(e)?e.valueInMilliseconds():e}compare(e,t,r){return n(t,r,e)}calculate(e,t,r,a){return s(e,t,r,a)}evaluateTime(e){return p(e)}evaluateTimestamp(e,t,r){return m(e,t,r)}evaluateDate(e,t){return h(e,t)}evaluateFunction(e,t,r){return N(e,t,r)}lookup(e,t){const r=t[e];return void 0===r?null:r}between(e,t){return null==e||null==t[0]||null==t[1]?null:n(e,t[0],">=")&&n(e,t[1],"<=")}notbetween(e,t){return null==e||null==t[0]||null==t[1]?null:n(e,t[0],"<")||n(e,t[1],">")}ternaryNot(e){return z(e)}ternaryAnd(e,t){return J(e,t)}ternaryOr(e,t){return B(e,t)}}function $(e,...t){return`this.${e}(${t.join(", ")})`}function F(e){return void 0===e?"void 0":JSON.stringify(e)}function E({type:e,start:t,end:r}){return`{type: ${F(e)}, start: ${b(t)}, end: ${b(r)}}`}function b({type:e,period:t,precision:r,secondary:a}){return JSON.stringify({type:e,period:t,precision:r,secondary:a})}function A({type:e,size:t,withtimezone:r}){return JSON.stringify({type:e,size:t,withtimezone:r})}const O="feature",k="lookups",U="attributeAdapter",V="fieldsIndex",j="timeZone",q="currentUser";class C{constructor(e){this._parseTree=e,this._staticData=Object.create(null),this._nextStaticDataId=0,this._tempVars=new Set,this._nextTempVarId=0}compile(){const e=this._compileNode(this._parseTree),t=`\n      ${this._tempVars.size>0?`var ${Array.from(this._tempVars).join(", ")};`:""}\n      return this.convertInterval(${e});\n    `;return new Function(O,k,U,V,j,q,t).bind(new x(this._staticData))}_storeStaticData(e){const t="static$"+this._nextStaticDataId++;return this._staticData[t]=e,t}_compileRefStaticData(e){return`this.staticData[${F(e)}]`}_generateTempVar(){const e="temp$"+this._nextTempVarId++;return this._tempVars.add(e),e}_compileSimpleCase(e){const t=this._compileNode(e.operand),r=this._generateTempVar(),a=[];for(const s of e.clauses){const e=$("compare",F("="),r,this._compileNode(s.operand)),t=this._compileNode(s.value);a.push(`${e} ? (${t}) :`)}return null!=e.else?a.push(this._compileNode(e.else)):a.push(F(null)),`(${r} = ${t}, ${a.join(" ")})`}_compileSearchedCase(e){const t=[];for(const r of e.clauses){const e=$("makeBool",this._compileNode(r.operand)),a=this._compileNode(r.value);t.push(`${e} ? (${a}) :`)}return null!=e.else?t.push(this._compileNode(e.else)):t.push(F(null)),t.join(" ")}_compileInExpr(e,t){const r=new Set,a=[];for(const i of t.value)"number"===i.type||"string"===i.type?r.add(i.value):a.push(i);const s=this._compileNode(e),n=$("ensureArray",this._compileNode({type:"expression-list",location:t.location,value:a}));if(r.size>0){const e=this._compileRefStaticData(this._storeStaticData(r)),t=this._generateTempVar();return a.length>0?`(${t} = ${s}, ${e}.has(${t}) || ${$("applyIn",t,n)})`:`(${t} = ${s}, ${t} == null ? null : ${e}.has(${t}))`}return $("applyIn",s,n)}_compileNode(e){switch(e.type){case"interval":return $("makeSqlInterval",this._compileNode(e.value),"interval-qualifier"===e.qualifier.type?E(e.qualifier):b(e.qualifier),F(e.op));case"case-expression":return"simple"===e.format?this._compileSimpleCase(e):this._compileSearchedCase(e);case"parameter":return $("lookup",F(e.value.toLowerCase()),k);case"expression-list":return`[${e.value.map(e=>this._compileNode(e)).join(", ")}]`;case"unary-expression":return $("ternaryNot",this._compileNode(e.expr));case"binary-expression":switch(e.operator){case"AND":return $("ternaryAnd",this._compileNode(e.left),this._compileNode(e.right));case"OR":return $("ternaryOr",this._compileNode(e.left),this._compileNode(e.right));case"IS":if("null"!==e.right.type)throw new a("UnsupportedIsRhs");return $("equalsNull",this._compileNode(e.left));case"ISNOT":if("null"!==e.right.type)throw new a("UnsupportedIsRhs");return`!${$("equalsNull",this._compileNode(e.left))}`;case"IN":return this._compileInExpr(e.left,e.right);case"NOT IN":return $("ternaryNot",this._compileInExpr(e.left,e.right));case"BETWEEN":return $("between",this._compileNode(e.left),this._compileNode(e.right));case"NOTBETWEEN":return $("notbetween",this._compileNode(e.left),this._compileNode(e.right));case"LIKE":return $("applyLike",this._compileNode(e.left),this._compileNode(e.right),F(e.escape));case"NOT LIKE":return $("ternaryNot",$("applyLike",this._compileNode(e.left),this._compileNode(e.right),F(e.escape)));case"<>":case"<":case">":case">=":case"<=":case"=":return $("compare",F(e.operator),this._compileNode(e.left),this._compileNode(e.right));case"*":case"-":case"+":case"/":case"||":return $("calculate",F(e.operator),this._compileNode(e.left),this._compileNode(e.right),j);default:throw new a("UnsupportedOperator",{operator:e.operator})}case"null":case"boolean":case"string":case"number":return F(e.value);case"time":try{return this._compileRefStaticData(this._storeStaticData(p(e.value)))}catch{return $("evaluateTime",F(e.value))}case"date":try{return this._compileRefStaticData(this._storeStaticData(h(e.value,"unknown")))}catch{return $("evaluateDate",F(e.value),F("unknown"))}case"timestamp":try{return this._compileRefStaticData(this._storeStaticData(m(e.value,"unknown")))}catch{return $("evaluateTimestamp",F(e.value),F("unknown"))}case"current-time":return"date"===e.mode?$("currentDate",j):"time"===e.mode?$("currentTime",j):$("currentTimestamp",j);case"current-user":return q;case"column-reference":return $("featureValue",O,F(e.column),V,U);case"data-type":return A(e.value);case"function":return $("evaluateFunction",F(e.name),this._compileNode(e.args),j)}throw new a("UnsupportedSyntax",{node:e.type})}}class L{static create(e,t={}){return new L(e,t.fieldsIndex,t.timeZone??void 0,t.currentUser)}constructor(e,t,r="UTC",a=null){this.fieldsIndex=t,this.timeZone=r,this.currentUser=a,this.parameters={},this._compiledExecutor=null,this._hasDateFunctions=void 0,this.parseTree=y.parse(e);const{isStandardized:s,isAggregate:n,currentUserRequired:i,referencedFieldNames:o}=this._extractExpressionInfo(t);this._referencedFieldNames=o,this.isStandardized=s,this.isAggregate=n,this.currentUserRequired=i}static convertValueToStorageFormat(e,t=null){if(null===t)return T(e)?e.getTime():o(e)?e.toMillis():u(e)?e.toStorageFormat():l(e)?e.toStorageString():c(e)?e.toStorageFormat():e;switch(t){case"date":return T(e)?e.getTime():o(e)?e.toMillis():u(e)?e.toMilliseconds():c(e)?e.toNumber():e;case"date-only":return T(e)?r.fromDateJS(e).toString():u(e)?r.fromSqlTimeStampOffset(e).toString():o(e)?r.fromDateTime(e).toString():e;case"time-only":return T(e)?v.fromDateJS(e).toStorageString():o(e)?v.fromDateTime(e).toStorageString():u(e)?v.fromSqlTimeStampOffset(e).toStorageString():l(e)?e.toStorageString():e;case"timestamp-offset":if(T(e))return _.fromJSDate(e).toStorageFormat();if(o(e))return _.fromDateTime(e).toStorageFormat();if(u(e))return e.toStorageFormat()}return e}get fieldNames(){return this._referencedFieldNames}testSet(e,t=ee,r=this.currentUser){return!!this._evaluateNode(this.parseTree,null,t,e,r)}calculateValue(e,t=ee,r=this.currentUser){const a=this._evaluateNode(this.parseTree,e,t,null,r);return f.isInterval(a)?a.valueInMilliseconds()/864e5:a}tryGetCompiledExecutor(){if(null!=this._compiledExecutor)return this._compiledExecutor;if(has("esri-csp-restrictions"))return null;const e=new C(this.parseTree);return this._compiledExecutor=e.compile(),this._compiledExecutor}calculateValueCompiled(e,t=ee,r=this.currentUser){const a=this.tryGetCompiledExecutor();return null==a?this.calculateValue(e,t):a(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}testFeature(e,t=ee,r=this.currentUser){return!!this._evaluateNode(this.parseTree,e,t,null,r)}testFeatureCompiled(e,t=ee,r=this.currentUser){const a=this.tryGetCompiledExecutor();return null==a?this.testFeature(e,t):!!a(e,this.parameters,t,this.fieldsIndex,this.timeZone,r??null)}get hasDateFunctions(){return null!=this._hasDateFunctions||(this._hasDateFunctions=!1,S(this.parseTree,e=>{"current-time"===e.type?this._hasDateFunctions=!0:"function"===e.type&&(this._hasDateFunctions=this._hasDateFunctions||I.has(e.name.toLowerCase()))})),this._hasDateFunctions}getFunctions(){const e=new Set;return S(this.parseTree,t=>{"function"===t.type&&e.add(t.name.toLowerCase())}),Array.from(e)}getExpressions(){const e=new Map;return S(this.parseTree,t=>{if("function"===t.type){const r=t.name.toLowerCase(),a=t.args.value[0];if("column-reference"===a.type){const t=a.column,s=`${r}-${t}`;e.has(s)||e.set(s,{aggregateType:r,field:t})}}}),[...e.values()]}getVariables(){const e=new Set;return S(this.parseTree,t=>{"parameter"===t.type&&e.add(t.value.toLowerCase())}),Array.from(e)}_extractExpressionInfo(t){const r=[],a=new Set;let s=!0,n=!1,i=!1;return S(this.parseTree,o=>{switch(o.type){case"column-reference":{const e=t?.get(o.column);let s,n;e?s=n=e.name??"":(n=o.column,s=n.toLowerCase()),a.has(s)||(a.add(s),r.push(n)),o.column=n;break}case"current-user":i=!0;break;case"function":{const{name:t,args:r}=o,a=r.value.length;s&&(s=g(t,a)),!1===n&&(n=e(t,a));break}}}),{referencedFieldNames:Array.from(r),isStandardized:s,isAggregate:n,currentUserRequired:i}}_evaluateNode(r,i,o,u,l){let c;switch(r.type){case"interval":{const e=this._evaluateNode(r.value,i,o,u,l);return f.createFromValueAndQualifier(e,r.qualifier,r.op)}case"case-expression":if("simple"===r.format){const e=this._evaluateNode(r.operand,i,o,u,l);for(let t=0;t<r.clauses.length;t++)if(n(e,this._evaluateNode(r.clauses[t].operand,i,o,u,l),"="))return this._evaluateNode(r.clauses[t].value,i,o,u,l);if(null!==r.else)return this._evaluateNode(r.else,i,o,u,l)}else{for(let e=0;e<r.clauses.length;e++)if(R(this._evaluateNode(r.clauses[e].operand,i,o,u,l)))return this._evaluateNode(r.clauses[e].value,i,o,u,l);if(null!==r.else)return this._evaluateNode(r.else,i,o,u,l)}return null;case"parameter":return c=this.parameters[r.value.toLowerCase()],T(c)?w.fromJSDate(c):null!=c&&"object"==typeof c&&"toDateTime"in c?c.toDateTime():c;case"expression-list":{const e=[];for(const t of r.value)e.push(this._evaluateNode(t,i,o,u,l));return e}case"unary-expression":return z(this._evaluateNode(r.expr,i,o,u,l));case"binary-expression":switch(r.operator){case"AND":return J(this._evaluateNode(r.left,i,o,u,l),this._evaluateNode(r.right,i,o,u,l));case"OR":return B(this._evaluateNode(r.left,i,o,u,l),this._evaluateNode(r.right,i,o,u,l));case"IS":if("null"!==r.right.type)throw new a("UnsupportedIsRhs");return null===this._evaluateNode(r.left,i,o,u,l);case"ISNOT":if("null"!==r.right.type)throw new a("UnsupportedIsRhs");return null!==this._evaluateNode(r.left,i,o,u,l);case"IN":{const e=Z(this._evaluateNode(r.right,i,o,u,l));return M(this._evaluateNode(r.left,i,o,u,l),e)}case"NOT IN":{const e=Z(this._evaluateNode(r.right,i,o,u,l));return z(M(this._evaluateNode(r.left,i,o,u,l),e))}case"BETWEEN":{const e=this._evaluateNode(r.left,i,o,u,l),t=this._evaluateNode(r.right,i,o,u,l);return null==e||null==t[0]||null==t[1]?null:n(e,t[0],">=")&&n(e,t[1],"<=")}case"NOTBETWEEN":{const e=this._evaluateNode(r.left,i,o,u,l),t=this._evaluateNode(r.right,i,o,u,l);return null==e||null==t[0]||null==t[1]?null:n(e,t[0],"<")||n(e,t[1],">")}case"LIKE":return H(this._evaluateNode(r.left,i,o,u,l),this._evaluateNode(r.right,i,o,u,l),r.escape);case"NOT LIKE":return z(H(this._evaluateNode(r.left,i,o,u,l),this._evaluateNode(r.right,i,o,u,l),r.escape));case"<>":case"<":case">":case">=":case"<=":case"=":return n(this._evaluateNode(r.left,i,o,u,l),this._evaluateNode(r.right,i,o,u,l),r.operator);case"-":case"+":case"*":case"/":case"||":return s(r.operator,this._evaluateNode(r.left,i,o,u,l),this._evaluateNode(r.right,i,o,u,l),this.timeZone)}case"null":case"boolean":case"string":case"number":return r.value;case"date":return r.parsedValue??=h(r.value,"unknown"),r.parsedValue;case"timestamp":return r.parsedValue??=m(r.value,"unknown"),r.parsedValue;case"time":return p(r.value);case"current-time":return"date"===r.mode?G(this.timeZone):"time"===r.mode?K(this.timeZone):W(this.timeZone);case"current-user":return l??null;case"column-reference":return Y(i,r.column,this.fieldsIndex,o);case"data-type":return r.value;case"function":{if(this.isAggregate&&e(r.name,r.args.value.length)){const e=[];for(const t of r.args?.value||[]){const r=[];for(const e of u||[])r.push(this._evaluateNode(t,e,o,null,l));e.push(r)}return t(r.name,e)}const a=this._evaluateNode(r.args,i,o,u,l);return N(r.name,a,this.timeZone)}}throw new a("UnsupportedSyntax",{node:r.type})}}function R(e){return!0===e}function Z(e){return Array.isArray(e)?e:[e]}function z(e){return null!==e?!0!==e:null}function J(e,t){return null!=e&&null!=t?!0===e&&!0===t:!1!==e&&!1!==t&&null}function B(e,t){return null!=e&&null!=t?!0===e||!0===t:!0===e||!0===t||null}function M(e,t){if(null==e)return null;let r=!1;for(const a of t)if(null==a)r=null;else{if(e===a){r=!0;break}if(i(e)&&i(a)&&(r=n(e,a,"="),r))break}return r}function W(e){return d(new Date,e)}function G(e){return r.fromNow(e)}function K(e){const t=d(new Date,e);return v.fromDateTime(t)}const Q="-[]/{}()*+?.\\^$|";function P(e,t){const r=t;let a="",s=0;for(let n=0;n<e.length;n++){const t=e.charAt(n);switch(s){case 0:t===r?s=1:Q.includes(t)?a+="\\"+t:a+="%"===t?".*":"_"===t?".":t;break;case 1:Q.includes(t)?a+="\\"+t:a+=t,s=0}}return new RegExp("^"+a+"$","m")}function H(e,t,r){if(null==e)return null;return P(t,r).test(e)}function X(e){return e&&"object"==typeof e.attributes}function Y(e,t,a,s){if("getAttributeSQL"in s)return s.getAttributeSQL(e,t);const n=s.getAttribute(e,t);if(null==n)return n;const i=a?.get(t);switch(i?.type){case"esriFieldTypeDate":case"date":return d(new Date(n),a?.getLuxonTimeZone(i.name)??D.utcInstance);case"esriFieldTypeDateOnly":case"date-only":return r.fromReader(n);case"esriFieldTypeTimeOnly":case"time-only":return v.fromReader(n);case"esriFieldTypeTimestampOffset":case"timestamp-offset":return new _(n)}return n}const ee={getAttribute:(e,t)=>(X(e)?e.attributes:e)[t]};export{L as default};
