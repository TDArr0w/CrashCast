/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../../../request.js";import{urlToObject as r,join as n}from"../../../core/urlUtils.js";import{normalizeCentralMeridian as e}from"../../../geometry/support/normalizeUtils.js";import{mapParameters as o}from"../../operations/urlUtils.js";import{parsePBFFeatureQuery as u}from"./pbfQueryUtils.js";import{queryLikeToQueryStringParameters as s}from"./queryUtils.js";import{applyFeatureSetZUnitScaling as i}from"./queryZScale.js";const a="Layer does not support extent calculation.";function l(t,r,n){return s(t,r,n)}async function y(t,r,n,e,o){const u=r.timeExtent?.isEmpty?{data:{features:[]}}:await j(t,r,"json",e,void 0,o);return i(r,n,u.data),u}async function f(t,r,n,e,o){if(r.timeExtent?.isEmpty)return{data:n.createFeatureResult()};const s=await c(t,r,e,o),i=s;return i.data=u(s.data,n),i}function c(t,r,n,e){return j(t,r,"pbf",n,void 0,e)}function m(t,r,n,e){return r.timeExtent?.isEmpty?Promise.resolve({data:{objectIds:[]}}):j(t,r,"json",n,{returnIdsOnly:!0},e)}function p(t,r,n,e){return r.timeExtent?.isEmpty?Promise.resolve({data:{count:0}}):j(t,r,"json",n,{returnIdsOnly:!0,returnCountOnly:!0},e)}async function d(t,r,n){if(r.timeExtent?.isEmpty)return{data:{count:0,extent:null}};const e=await j(t,r,"json",n,{returnExtentOnly:!0,returnCountOnly:!0}),o=e.data;if(o.hasOwnProperty("extent"))return e;if(o.features)throw new Error(a);if(o.hasOwnProperty("count"))throw new Error(a);return e}function O(t,r){if(!t.returnIdsOnly||!r.uniqueIdFields)return t;const n={...t,returnUniqueIdsOnly:!0};return delete n.returnIdsOnly,n}async function j(u,s,i,a={},y={},f={}){const c="string"==typeof u?r(u):u,m=s.geometry?[s.geometry]:[],p=await e(m,null,{signal:a.signal}),d=p?.[0];null!=d&&((s=s.clone()).geometry=d);const j=o({...c.query,f:i,...O(y,f),...l(s,y,f)});return t(n(c.path,E(s,y)?"query3d":"query"),{...a,responseType:"pbf"===i?"array-buffer":"json",query:{...j,...a.query}})}function E(t,r){return null!=t.formatOf3DObjects&&!(r.returnCountOnly||r.returnExtentOnly||r.returnIdsOnly)}export{y as executeQuery,p as executeQueryForCount,d as executeQueryForExtent,m as executeQueryForIds,f as executeQueryPBF,c as executeQueryPBFBuffer,l as queryToQueryStringParameters,j as runQuery};
