/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../../core/Logger.js";import{animationDebugFlags as n}from"./animationDebugFlags.js";import{defaultCIMValues as e}from"./defaultCIMValues.js";import{getExtent as o}from"./SDFHelper.js";import{getProcessParam as i,hasProcessParam as r,getSize as a,getValue as s}from"./utils.js";function m(t,n,e){return{transform:b(t,n,e.transform),fromColor:I(t,n,e.fromColor),toColor:T(t,n,e.toColor),colorMix:k(t,n,e.colorMix),toOpacity:v(t,n,e.toOpacity),opacityMix:O(t,n,e.opacityMix),shift:x(t,n,e.shift),hasAnimations:e.hasAnimations||c(n),hasShiftAnimation:e.hasShiftAnimation||l(n),hasMotionAnimations:e.hasMotionAnimations||p(n)}}function c(t){return!!t.animations&&t.animations.length>0}function l(t){return!!t.animations&&t.animations.some(t=>"CIMSymbolAnimationMoveAlongLine"===t.type)}const f=new Set(["CIMSymbolAnimationOffset","CIMSymbolAnimationRotation","CIMSymbolAnimationSize","CIMSymbolAnimationScale"]);function p(t){return!!t.animations&&t.animations.some(t=>f.has(t.type))}function u(t){return!n.forceStaticPath&&(n.forceAnimatedPath||t.hasAnimations)}function y(n,e,o){if("CIMCharacterMarker"===e.type)return t.getLogger("animationUtils").error("#handleMarker()","CIM character markers do not support animations"),o;const r=i(n,e,"OffsetX"),a=i(n,e,"OffsetY");if("CIMPictureMarker"===e.type)return{...o,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!0,translation:z([r,a]),rotation:z(0),scale:z(i(n,e,"Size")),parent:o.transform}};const s=e.frame,m=s.ymax-s.ymin;return{...o,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:z([r,a]),rotation:z(0),scale:z({type:"Process",op:"Divide",left:i(n,e,"Size"),right:m}),parent:o.transform}}}function d(t,n){let e=0,o=0;const i="Absolute"!==t.anchorPointUnits;return t.anchorPoint&&(e=-t.anchorPoint.x,o=-t.anchorPoint.y),{...n,transform:{type:"AnimatedTransform",relativeTranslation:i,absoluteScale:!1,translation:z([e,o]),rotation:z(0),scale:z(1),parent:n.transform}}}function S(t,n){return"Absolute"===t.anchorPointUnits?n:d(t,n)}function M(t,n){return"Absolute"!==t.anchorPointUnits?n:d(t,n)}function A(t,n,e){return{...t,transform:{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:z([n,e]),rotation:z(0),scale:z(1),parent:t.transform}}}function C(t,n){const e=n?.5*-(n.xmin+n.xmax):0,i=n?.5*-(n.ymin+n.ymax):0;let r=0,a=0;if("x"in t&&"y"in t)r=t.x+e,a=t.y+i;else{const n=o(t);if(n){r=(n[0]+n[2])/2+e,a=(n[1]+n[3])/2+i}}return[r,a]}function g(t,n){switch(n.type){case"CIMPictureMarker":case"CIMVectorMarker":return i(t,n,"Rotation")}return 0}function h(t,n){switch(n.type){case"CIMPictureMarker":case"CIMVectorMarker":return i(t,n,"RotateClockwise")}return 0}function P(t,n){switch(n.type){case"CIMPointSymbol":case"CIMVectorMarker":return[1,1,1,1];case"CIMSolidStroke":case"CIMSolidFill":return i(t,n,"Color");case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":return i(t,n,"TintColor")}return[1,1,1,1]}function b(t,n,e){return{type:"AnimatedTransform",relativeTranslation:!1,absoluteScale:!1,translation:R(t,n),rotation:w(t,n),scale:L(t,n),parent:e}}function I(t,n,e){return{type:"AnimatedColor",color:z(P(t,n)),opacity:z(1),parent:e}}function T(t,n,e){const{animations:o}=n;let r=P(t,n);const a=o?.find(t=>"CIMSymbolAnimationColor"===t.type);return a&&(r=i(t,a,"ToColor")),{type:"AnimatedColor",color:z(r),opacity:z(1),parent:e}}function k(t,n,e){const{animations:o}=n,i=o?.find(t=>"CIMSymbolAnimationColor"===t.type);return i?{type:"AnimatedColor",color:z([1,1,1,1]),opacity:{from:0,to:1,timing:D(t,i?.animatedSymbolProperties)},parent:[1,1,1,1]}:e}function v(t,n,e){const{animations:o}=n;let r=z(1);const a=o?.find(t=>"CIMSymbolAnimationTransparency"===t.type);if(a){r=z({type:"Process",op:"Transparency",value:i(t,a,"ToTransparency")})}return{type:"AnimatedColor",color:z([1,1,1,1]),opacity:r,parent:e}}function O(t,n,e){const{animations:o}=n,i=o?.find(t=>"CIMSymbolAnimationTransparency"===t.type);return i?{type:"AnimatedColor",color:z([1,1,1,1]),opacity:{from:0,to:1,timing:D(t,i?.animatedSymbolProperties)},parent:[1,1,1,1]}:e}function x(t,n,e){const{animations:o}=n,a=o?.find(t=>"CIMSymbolAnimationMoveAlongLine"===t.type);if(!a)return e;let s,m;const c=D(t,a.animatedSymbolProperties),l=r(t,a,"DistanceAlong"),f=r(t,a,"Speed"),p=l&&i(t,a,"DistanceAlong"),u=f&&i(t,a,"Speed"),y=!0===a.continuous;if(!1!==p)s={type:"Process",op:"Divide",left:p,right:100},m=!0;else if(!1!==u)s={type:"Process",op:"Multiply",left:u,right:c.duration},m=!1;else{if(!y)throw new Error("Either distanceAlong, speed or continuous must be specified.");s=1,m=!0}return{type:"AnimatedShift",multiplyByLineLength:m,shift:{from:0,to:s,timing:c},parent:e}}function D(t,n){if(!n)return{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:"Local",repeatType:"Loop",easing:"Linear",playAnimation:1,reverseAnimation:0};const o=i(t,n,"Duration");let r;if(i(t,n,"RandomizeStartTime")){r={type:"Process",op:"Random",min:0,max:o,seed:i(t,n,"RandomizeStartSeed")}}else r=i(t,n,"StartTimeOffset");const a=i(t,n,"RepeatDelay"),m=i(t,n,"PlayAnimation"),c=i(t,n,"ReverseAnimation"),l=s(n.repeatType,e.CIMAnimatedSymbolProperties.repeattype);return{duration:o,startTimeOffset:r,repeatDelay:a,timeOriginSelector:"None"===l?"Local":"Global",repeatType:l,easing:s(n.easing,e.CIMAnimatedSymbolProperties.easing),playAnimation:m,reverseAnimation:c}}function L(t,n){const{animations:e}=n;let o;o="CIMPictureMarker"===n.type||"CIMVectorMarker"===n.type?i(t,n,"Size"):"CIMSolidStroke"===n.type||"CIMPictureStroke"===n.type?i(t,n,"Width"):a(n)||10;const r=e?.find(t=>"CIMSymbolAnimationScale"===t.type);if(!r){const n=e?.find(t=>"CIMSymbolAnimationSize"===t.type);if(!n)return z(1);return{from:1,to:{type:"Process",op:"Divide",left:i(t,n,"ToSize"),right:o},timing:D(t,n.animatedSymbolProperties)}}return{from:1,to:i(t,r,"ScaleFactor"),timing:D(t,r.animatedSymbolProperties)}}function R(t,n){const{animations:e}=n,o=e?.find(t=>"CIMSymbolAnimationOffset"===t.type);if(!o)return z([0,0]);return{from:[0,0],to:[i(t,o,"OffsetX"),i(t,o,"OffsetY")],timing:D(t,o.animatedSymbolProperties)}}function w(t,n){const{animations:e}=n,o=h(t,n),r={type:"Process",op:"Divide",left:g(t,n),right:{type:"Process",op:"Cond",condition:o,ifTrue:-1,ifFalse:1}},a=e?.find(t=>"CIMSymbolAnimationRotation"===t.type);if(!a)return z(r);const s={type:"Process",op:"Add",left:i(t,a,"ToRotation"),right:{type:"Process",op:"Divide",left:r,right:-1}};return{from:r,to:{type:"Process",op:"Add",left:r,right:{type:"Process",op:"Cond",condition:i(t,a,"RotateClockwise"),ifTrue:{type:"Process",op:"MatchWinding",sign:-1,angle:s},ifFalse:{type:"Process",op:"MatchWinding",sign:1,angle:s}}},timing:D(t,a.animatedSymbolProperties)}}function z(t){return{from:t,to:t,timing:{duration:1,startTimeOffset:0,repeatDelay:0,timeOriginSelector:"Local",repeatType:"Loop",easing:"Linear",playAnimation:1,reverseAnimation:0}}}function F(t){if(null==t)return!1;if("object"!=typeof t)return!1;if(t.animations&&Array.isArray(t.animations)&&t.animations.length>0)return!0;for(const n in t)if(F(t[n]))return!0;return!1}export{F as checkForAnimations,m as getAnimationParams,C as getFrameTranslation,z as getStaticParam,M as handleAbsoluteAnchor,d as handleAnchor,y as handleMarker,S as handleRelativeAnchor,u as shouldUseAnimatedPath,A as translate};
