/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import r from"../config.js";import{isAborted as e}from"../core/promiseUtils.js";import{getOrigin as t,hasSameOrigin as o,changeHost as n,getAppUrl as s,urlToObject as i}from"../core/urlUtils.js";import{parse as c}from"../layers/support/arcgisLayerUrl.js";import{isSecureProxyService as a}from"../portal/support/urlUtils.js";function u(r,t,o=!1,n){return new Promise((s,i)=>{if(e(n))return void i(f());let c=()=>{l(),i(new Error(`Unable to load ${t}`))},a=async()=>{const e=r;try{await e.decode()}catch{}l(),s(e)},u=()=>{if(!r)return;const e=r;l(),e.src="",i(f())};const l=()=>{r&&(r.removeEventListener("error",c),r.removeEventListener("load",a),c=null,a=null,r=null,n?.removeEventListener("abort",u),u=null,o&&URL.revokeObjectURL(t))};n?.addEventListener("abort",u),r.addEventListener("error",c),r.addEventListener("load",a)})}function f(){try{return new DOMException("Aborted","AbortError")}catch{const r=new Error;return r.name="AbortError",r}}const l="Timeout exceeded";function m(){return new Error(l)}function p(r){return"object"==typeof r&&!!r&&"message"in r&&r.message===l}function d(e){r.request.crossOriginNoCorsDomains||(r.request.crossOriginNoCorsDomains={});const o=r.request.crossOriginNoCorsDomains;for(let r of e)r=r.toLowerCase(),/^https?:\/\//.test(r)?o[t(r)??""]=0:(o[t("http://"+r)??""]=0,o[t("https://"+r)??""]=0)}function w(e){const n=r.request.crossOriginNoCorsDomains;if(n){let r=t(e);if(r)return r=r.toLowerCase(),!o(r,s())&&n[r]<Date.now()-36e5}return!1}async function L(e){const o=i(e);e=o.path,"json"===o.query?.f&&(e+="?f=json");try{await fetch(e,{mode:"no-cors",credentials:"include"})}catch{}const n=r.request.crossOriginNoCorsDomains,s=t(e);n&&s&&(n[s.toLowerCase()]=Date.now())}const v=new Map;function h(r,e){const t=e?.preferredHost;if(!t||o(r,`https://${t}`,!0))return;const n=c(r);if(!n||"FeatureServer"!==n.serverType||a(r))return;const s=n.url.path.toLowerCase();v.has(s)||v.set(s,t)}function E(r){const e=c(r)?.url.path.toLowerCase();if(!e)return r;const t=v.get(e);return t?n(r,t):r}export{m as createTimeoutError,E as getPreferredUrl,w as isNoCorsRequestRequired,p as isTimeoutError,u as loadImageAsync,v as preferredHosts,d as registerNoCorsDomains,L as sendNoCorsRequest,h as setPreferredHost};
