/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{getMetersPerVerticalUnitForSR as e,segmentLength3d as t,segmentLength as n,segmentLength3dSqr as r,segmentLengthSqr as s,closestPointOnLineSegmentWithZ as a,closestPointOnLineSegment as i}from"./centroid.js";import l from"../../core/Error.js";import{getMetersPerUnitForSR as o}from"../../core/unitUtils.js";import c from"../../geometry/Point.js";import u from"../../geometry/Polygon.js";import{closestPointOnCurve as f}from"../../geometry/support/curves/closestPointOnCurve.js";import{curveLength as p}from"../../geometry/support/curves/curveLength.js";import{isCoordinate as h,getEndpoint as m}from"../../geometry/support/curves/curveUtils.js";import{splitCurveAtPoint as d}from"../../geometry/support/curves/splitCurveAtPoint.js";function g(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function y(e){const t=g(e);return[e[0]/t,e[1]/t,e[2]/t]}function R(e,t,n,r){const s=y([t[0]-e[0],t[1]-e[1],t[2]*r-e[2]*r]);return[e[0]+s[0]*n,e[1]+s[1]*n,e[2]+s[2]*n]}function x(e,t,n,r){return e+(t-e)/n*r}function Z(e,t,n){let r=t[0]-e[0],s=t[1]-e[1];const a=Math.sqrt(r*r+s*s);return r/=a,s/=a,r*=n,s*=n,[e[0]+r,e[1]+s]}function M(t,n){if(!t)return null;switch(t.type){case"extent":case"multipoint":case"mesh":case"point":return null}const r="polygon"===t.type?t.rings:t.paths;let s=1;if(t.spatialReference.vcsWkid||t.spatialReference.latestVcsWkid){s=e(t.spatialReference)/o(t.spatialReference)}if(0===r.length)return null;if(0===r[0].length)return null;if(!1===t.hasM)return null;let a=-1,i=0;const{hasM:l,hasZ:u}=t,f=u?3:2,p=2;for(const e of r){if(a++,e.length>0&&e[0][f]===n)return{partId:a,distanceAlong:i,coordinate:new c({hasZ:u,hasM:l,spatialReference:t.spatialReference,x:e[0][0],y:e[0][1],...u?{z:e[0][p]}:{},...l?{m:e[0][f]}:{}}),segmentId:0};let r=-1;for(let o=1;o<e.length;o++){const h=k(e[o-1],e[o],u,s);r++;const m=e[o][f]-e[o-1][f],d=e[o][f];if(d===n)return{partId:a,distanceAlong:h+i,coordinate:new c({hasZ:u,hasM:l,spatialReference:t.spatialReference,x:e[o][0],y:e[o][1],...u?{z:e[o][p]}:{},...l?{m:e[o][f]}:{}}),segmentId:r};if(d>n&&n>e[o-1][f]){const d=(n-e[o-1][f])/m*h;let g=u?R(e[o-1],e[o],d,s):Z(e[o-1],e[o],d);g=[...g,n];const y=new c({hasZ:u,hasM:l,spatialReference:t.spatialReference,x:g[0],y:g[1],...u?{z:g[p]}:{},...l?{m:g[f]}:{}});return{partId:a,distanceAlong:i+k(e[o-1],[y.x,y.y,...u?[y.z]:[],...l?[y.m]:[]],u,s),coordinate:y,segmentId:r}}i+=h}}return null}function v(t,n){if(!t)return null;switch(t.type){case"extent":case"multipoint":case"mesh":case"point":return null}const r="polygon"===t.type?t.rings:t.paths;if(n<0)return null;let s=1;if(t.spatialReference.vcsWkid||t.spatialReference.latestVcsWkid){s=e(t.spatialReference)/o(t.spatialReference)}let a=0;const{hasZ:i,hasM:l}=t,u=i?3:2,f=2;let p=-1;if(0===n)return 0===r.length||0===r[0].length?null:{partId:0,coordinate:new c({hasZ:i,hasM:l,spatialReference:t.spatialReference,x:r[0][0][0],y:r[0][0][1],...i?{z:r[0][0][f]}:{},...l?{m:r[0][0][u]}:{}}),segmentId:0};for(const e of r){p++;let r=-1;for(let o=1;o<e.length;o++){r++;const h=k(e[o-1],e[o],i,s),m=a+h;if(m===n)return{partId:p,coordinate:new c({hasZ:i,hasM:l,spatialReference:t.spatialReference,x:e[o][0],y:e[o][1],...i?{z:e[o][f]}:{},...l?{m:e[o][u]}:{}}),segmentId:r};if(m>n){let m=i?R(e[o-1],e[o],n-a,s):Z(e[o-1],e[o],n-a);return m=[...m,x(e[o-1][u],e[o][u],h,n-a)],{partId:p,coordinate:new c({hasZ:i,hasM:l,spatialReference:t.spatialReference,x:m[0],y:m[1],...i?{z:m[f]}:{},...l?{m:m[u]}:{}}),segmentId:r}}a=m}}return null}function I(r,s){if(!r)return null;if(!s)return null;let a=1;if(s.spatialReference.vcsWkid||s.spatialReference.latestVcsWkid){a=e(s.spatialReference)/o(s.spatialReference)}let i=null,l=0;return i=r,l=r.hasZ&&s.hasZ?t([s.x,s.y,s.z],[r.x,r.y,r.z],a):n([s.x,s.y],[r.x,r.y],!1),{coordinate:i,distance:l}}function w(t,n){if(!t)return null;if(!n)return null;let a=1;if(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid){a=e(n.spatialReference)/o(n.spatialReference)}let i=null,l=0,c=Number.MAX_VALUE,u=-1,f=-1;for(const e of t.points||[]){f++;const i=t.hasZ&&n.hasZ?r([e[0],e[1],e[2]],[n.x,n.y,n.z],a):s([e[0],e[1]],[n.x,n.y],!1);i<c&&(c=i,u=f)}return u<0?null:(l=c,i=t.getPoint(u),{coordinate:i,distance:Math.sqrt(l)})}function z(t,n){if(!t)return null;if(!n)return null;const r="polygon"===t.type?t.curveRings??t.rings:t.curvePaths??t.paths;let s=1;if(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid){s=e(n.spatialReference)/o(n.spatialReference)}let a=Number.MAX_VALUE,i=-1,l=-1,u=-1;const f=t.hasZ&&n.hasZ;let p=null;const g=f?[n.x,n.y,n.z]:[n.x,n.y];for(const e of r){l++;for(let t=1;t<e.length;t++){const n=P(g,e[t-1],e[t],f,s);n.distance<a&&(a=n.distance,p=n.closestPoint,u=l,i=t-1)}}if(i<0||!p)return null;const y=t.hasM&&t.hasZ?3:2,R=2,Z=r[u][i],M=m(Z),v=r[u][i+1],I=m(v);let w=null,z=null,W=f?p[2]:null;const j=h(v)?p:d(M,v,p,.001)[0];let A=k(M,j,f,s);const V=k(M,v,f,s);t.hasM&&(z=x(M[y],I[y],V,A)),!t.hasZ||!1!==n.hasZ&&h(j)||(W=x(M[R],I[R],V,A),m(j)[R]=W,A=k(M,j,!0,s)),w=new c({hasZ:f,hasM:t.hasM,spatialReference:n.spatialReference,x:p[0],y:p[1],...t.hasZ?{z:W}:{},...t.hasM?{m:z}:{}});let L=0;for(let e=0;e<=u;e++){const n=r[e],a=e===u?i:n.length-1;for(let e=1;e<=a;e++)L+=k(m(n[e-1]),n[e],t.hasZ,s)}return L+=A,{partId:u,segmentId:i,coordinate:w,distance:a,distanceAlong:L}}function P(e,r,s,o,c){const u=m(r);if(h(s)){const r=o?a(e,u,s):i(e,u,s);return{closestPoint:r,distance:o?t(r,e,c):n(r,e,!1)}}const p=f(u,s,e);if(!p)throw new l("arcade:closestPointOnSegment","The given point is not on the curve");return{closestPoint:p.curvePoint,distance:p.distance}}function k(e,r,s,a){return h(r)?s?t(e,r,a):n(e,r,!1):p(e,r,.001)}function W(e,t){if(!e)return null;if(!t)return null;if("extent"===e.type){const t=e;e=new u({spatialReference:e.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}switch(e.type){case"point":return I(e,t)??null;case"multipoint":return w(e,t)??null;case"polygon":case"polyline":return z(e,t)??null;default:return null}}export{v as distanceToCoordinate,M as measureToCoordinate,W as pointToCoordinate};
