/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{toSymbolId as e,neverAbortedSignal as n}from"./arcadeEnvironment.js";import{ArcadeModule as t}from"./ArcadeModule.js";import{ArcadeModuleLoader as r}from"./ArcadeModuleLoader.js";import{collectDeclaredGlobalNames as o,collectDeclaredLocalNames as l}from"./compilerUtils.js";import{getNestedOptionalValue as a,geometryMember as s,getGeometryKeys as i}from"./containerUtils.js";import u from"./Dictionary.js";import{ArcadeExecutionError as c,ArcadeCompilationError as m,ArcadeUncompilableError as f}from"./executionError.js";import{Feature as p}from"./Feature.js";import{NativeFunction as d,ArcadeFunction as g,ScopeMarshalledFunction as h,wrapModuleScopedResponse as y}from"./FunctionWrapper.js";import{p as w,q as b,i as v,r as $,j as S,k as x,s as F,u as M,v as I,w as O,x as C,y as j,h as A,n as k}from"../chunks/languageUtils.js";import{addFunctionDeclaration as N}from"./treeAnalysis.js";import{A as E}from"../chunks/aiServices.js";import{A as B}from"../chunks/array.js";import{registerFunctions as _}from"./functions/date.js";import{registerFunctions as V}from"./functions/feature.js";import{registerFunctions as R}from"./functions/geometry.js";import{registerFunctions as L}from"./functions/geomsync.js";import{registerFunctions as T}from"./functions/maths.js";import{registerFunctions as D}from"./functions/stats.js";import{registerFunctions as U}from"./functions/string.js";import{registerFunctions as G}from"./functions/track.js";import{neverReached as K}from"../core/compilerUtils.js";import q from"../core/Logger.js";import{isPromiseLike as P}from"../core/promiseUtils.js";import{addMany as z}from"../core/SetUtils.js";import W from"../geometry/Geometry.js";import Z from"../geometry/SpatialReference.js";import{isGraphic as J,isString as Y,isArray as H,isNumber as Q,isBoolean as X}from"../support/guards.js";const ee=()=>q.getLogger("esri.arcade.arcadeCompiler");class ne{constructor(){this._symbolCounter=0}nextVarId(){return this._symbolCounter+=1,`_T${this._symbolCounter}`}nextTempVarId(){return this._symbolCounter+=1,`_Tvar${this._symbolCounter}`}nextLocalsSymbolMapId(){return this._symbolCounter+=1,`_Locals${this._symbolCounter}`}}function te(e,n){const t=e.localScope?.get(n);if(null!=t)return{scope:"local",name:n,var:t};const r=e.globalScope.get(n);return null!=r?{scope:"global",name:n,var:r}:e.standardGlobals.has(n)?{scope:"global",name:n,var:n}:null}function re(n,t,r="InvalidIdentifier"){const o=te(n,e(t));if(null!=o)return o;throw new m(null,r,t)}function oe(n,t,r){const o=te(n,e(t));if(null==o)throw ee().error(`Internal error: Symbol "${t.name}" not declared.`),new m(null,"NeverReach",t);if(null!=r&&o.scope!==r)throw ee().error(`Internal error: Expected to resolve "${t.name}" in the ${r} scope but is in the ${o.scope} scope.`),new m(null,"NeverReach",t);return o}function le(n,t){const r=e(t),o=n.symbolMetadata;if(n.localStack.length>0){const e=n.localStack[n.localStack.length-1],t=o.locals.get(e._SymbolsMapId);if(null==t)return void ee().error(`Internal error: no reflection metadata for ${e._SymbolsMapId}`);const l=t.get(r);if(null!=l)return Qe.requireInitialized(e[l])}const l=o.globals.get(r);if(null!=l)return Qe.requireInitialized(n.globalScope[l]);if(o.standardGlobals.has(r))return Qe.requireInitialized(n.globalScope[r]);throw new c(null,"InvalidIdentifier",null)}class ae extends g{constructor(e,n){super(),this.paramCount=n,this.fn=e}createFunction(e){return(...n)=>{if(n.length!==this.paramCount)throw new c(e,"WrongNumberOfParameters",null);return this.fn(...n)}}call(e,n){return this.fn(...n.arguments)}marshalledCall(e,n,t,r){return r(e,n,(n,o,l)=>{l=l.map(n=>!v(n)||n instanceof h?n:y(n,e,r));const a=this.call(t,{arguments:l});return P(a)?a.then(e=>y(e,t,r)):a})}}function se(e,n,t){try{return t(e,null,n.arguments)}catch(r){throw r}}function ie(e,n,t,r,l,a){const{globals:s,exports:i}=o(e);z(s,t);const u=new ne,c=[],m=new Map;for(const o of s)if(t.has(o)||n.has(o))m.set(o,o);else{const e=u.nextVarId();m.set(o,e),c.push(`gscope[${JSON.stringify(e)}] = ${Ye};`)}const f=new Map,p=Object.create(null),d={isAsync:r,symbols:u,standardGlobals:n,globalScope:m,exports:i,localScope:null,allLocalSymbolMetadata:f,moduleFactory:a,moduleFactoryMap:p,libraryResolver:l};return{body:[...c,"var lastStatement = lc.voidOperation;",Fe(d,e),"return lastStatement;"].join("\n"),symbolMetadata:{standardGlobals:n,exports:i,globals:m,locals:f},moduleFactoryMap:p}}function ue(e,n){switch(n.type){case"AssignmentExpression":return ve(e,n);case"UpdateExpression":return we(e,n);case"TemplateLiteral":return Be(e,n);case"Identifier":return Re(e,n);case"MemberExpression":return ke(e,n);case"Literal":return null===n.value||void 0===n.value?"null":JSON.stringify(n.value);case"CallExpression":return Le(e,n);case"UnaryExpression":return Ne(e,n);case"BinaryExpression":return _e(e,n);case"LogicalExpression":return Ve(e,n);case"ArrayExpression":return Ee(e,n);case"ObjectExpression":return me(e,n);default:throw new m(null,"Unrecognized",n)}}function ce(e,n){switch(n.type){case"EmptyStatement":return"lc.voidOperation";case"VariableDeclaration":return je(e,n);case"BlockStatement":return Fe(e,n);case"FunctionDeclaration":return Ce(e,n);case"ImportDeclaration":return Ie(e,n);case"ExportNamedDeclaration":return ce(e,n.declaration);case"ReturnStatement":return Me(e,n);case"IfStatement":return xe(e,n);case"ExpressionStatement":return $e(e,n);case"BreakStatement":return"break";case"ContinueStatement":return"continue";case"ForStatement":return ye(e,n);case"ForInStatement":return ge(e,n);case"ForOfStatement":return he(e,n);case"WhileStatement":return be(e,n);default:throw new m(null,"Unrecognized",n)}}function me(e,n){let t="lang.dictionary([";for(let r=0;r<n.properties.length;r++){const o=n.properties[r];let l;l="Identifier"===o.key.type?"'"+o.key.name+"'":ue(e,o.key);r>0&&(t+=","),t+="lang.strCheck("+l+",'ObjectExpression'),lang.aCheck("+ue(e,o.value)+", 'ObjectExpression')"}return t+="])",t}function fe(e,n,t,r,o=(e,n)=>`${e} = ${n}`){const l=e.symbols.nextTempVarId(),a=e.symbols.nextTempVarId();return[`var ${l} = ${t};`,`for (var ${a} = 0; ${a} < ${l}; ${a}++) {`,`  ${o(n,a)}`,`  ${ce(e,r)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function pe(e,n,t,r,o=e=>e){const l=e.symbols.nextTempVarId(),a=e.symbols.nextTempVarId();return[`var ${l} = ${t};`,`for (var ${a} of ${l}) {`,`  ${n} = ${o(a)};`,`  ${ce(e,r)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function de(e,n,t,r){const o=e.symbols.nextTempVarId();return[`var ${o} = ${t}.iterator(runtimeCtx.abortSignal);`,`while ((${n} = lang.graphicToFeature(yield ${o}.next(), ${t}, runtimeCtx)) != null) {`,`  ${ce(e,r)}`,"}","lastStatement = lc.voidOperation;"].join("\n")}function ge(e,n){const t=e.symbols.nextTempVarId();let r,o,l="var "+t+" = "+ue(e,n.right)+";\n";switch("VariableDeclaration"===n.left.type?(r=oe(e,n.left.declarations[0].id),l+=ce(e,n.left)):r=re(e,n.left),r.scope){case"local":o=`lscope['${r.var}']`;break;case"global":o=`gscope['${r.var}']`;break;default:throw K(r.scope),new m(null,"NeverReach",n.left)}return l+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",l+="else if (lc.isArray("+t+") || lc.isString("+t+")) {\n",l+=fe(e,o,`${t}.length`,n.body),l+="}\n",l+="else if (lc.isImmutableArray("+t+")) {\n",l+=fe(e,o,`${t}.length()`,n.body),l+="}\n",l+="else if (( "+t+" instanceof lang.Dictionary) || lc.isDictionaryLike("+t+")) {\n",l+=pe(e,o,`${t}.keys()`,n.body),l+="}\n",e.isAsync&&(l+="else if (lc.isFeatureSet("+t+")) {\n",l+=de(e,o,t,n.body),l+="}\n"),l+=`else if (lc.isGeometry(${t})) {\n`,l+=pe(e,o,`lang.getGeometryKeys(${t})`,n.body),l+="}\n",l+="else { lastStatement = lc.voidOperation; } \n",l}function he(e,n){const t=e.symbols.nextTempVarId();let r,o,l="var "+t+" = "+ue(e,n.right)+";\n";switch("VariableDeclaration"===n.left.type?(r=oe(e,n.left.declarations[0].id),l+=ce(e,n.left)):r=re(e,n.left),r.scope){case"local":o=`lscope['${r.var}']`;break;case"global":o=`gscope['${r.var}']`;break;default:throw K(r.scope),new m(null,"NeverReach",n.left)}return l+="if ("+t+"===null) {  lastStatement = lc.voidOperation; }\n ",l+="else if (lc.isArray("+t+") || lc.isString("+t+")) {\n",l+=fe(e,o,`${t}.length`,n.body,(e,n)=>[`if (${n} >= ${t}.length) {`,"  lang.error('OutOfBounds');","}",`${e} = ${t}[${n}];`].join("\n")),l+="}\n",l+="else if (lc.isImmutableArray("+t+")) {\n",l+=fe(e,o,`${t}.length()`,n.body,(e,n)=>`${e} = ${t}.get(${n});`),l+="}\n",l+="else if (( "+t+" instanceof lang.Dictionary) || lc.isDictionaryLike("+t+")) {\n",l+=pe(e,o,`${t}.keys()`,n.body,e=>`lang.entry(${e}, ${t}.field(${e}))`),l+="}\n",e.isAsync&&(l+="else if (lc.isFeatureSet("+t+")) {\n",l+=de(e,o,t,n.body),l+="}\n"),l+=`else if (lc.isGeometry(${t})) {\n`,l+=pe(e,o,`lang.getGeometryKeys(${t})`,n.body,e=>`lang.entry(${e}, lang.geometryMember(${t}, ${e}, runtimeCtx, null, 1))`),l+="}\n",l+="else { lastStatement = lc.voidOperation; } \n",l}function ye(e,n){let t="lastStatement = lc.voidOperation; \n";null!==n.init&&("VariableDeclaration"===n.init.type?t+=ce(e,n.init):t+=ue(e,n.init)+"; ");const r=e.symbols.nextTempVarId(),o=e.symbols.nextTempVarId();return t+="var "+r+" = true; ",t+="\n do { ",null!==n.update&&(t+=" if ("+r+"===false) {\n "+ue(e,n.update)+"  \n}\n "+r+"=false; \n"),null!==n.test&&(t+="var "+o+" = "+ue(e,n.test)+"; ",t+="if ("+o+"===false) { break; } else if ("+o+"!==true) { lang.error('BooleanConditionRequired');   }\n"),t+=ce(e,n.body),null!==n.update&&(t+="\n "+ue(e,n.update)),t+="\n"+r+" = true; \n} while(true);  lastStatement = lc.voidOperation; ",t}function we(e,n){if("CallExpression"===n.argument.type)throw new m(null,"NeverReach",n);let t;if("MemberExpression"===n.argument.type){const r=ue(e,n.argument.object);return t=!0===n.argument.computed?ue(e,n.argument.property):"'"+n.argument.property.name+"'","lang.memberupdate("+r+","+t+",'"+n.operator+"',"+n.prefix+")"}const r=re(e,n.argument);switch(Oe(r),r.scope){case"local":return`lang.update(lscope, '${r.var}', '${n.operator}', ${n.prefix})`;case"global":return`lang.update(gscope, '${r.var}', '${n.operator}', ${n.prefix})`;default:throw K(r.scope),new m(null,"NeverReach",n.argument)}}function be(e,n){let t="lastStatement = lc.voidOperation; \n";const r=e.symbols.nextTempVarId();return t+=`\n  var ${r} = true;\n    do {\n      ${r} = ${ue(e,n.test)};\n      if (${r}==false) {\n        break;\n      }\n      if (${r}!==true) {\n        lang.error('BooleanConditionRequired');\n      }\n      ${ce(e,n.body)}\n    }\n    while (${r} !== false);\n    lastStatement = lc.voidOperation;\n  `,t}function ve(e,n){const t=ue(e,n.right);if("MemberExpression"===n.left.type){let r;const o=ue(e,n.left.object);return r=!0===n.left.computed?ue(e,n.left.property):"'"+n.left.property.name+"'","lang.assignmember("+o+","+r+",'"+n.operator+"',"+t+")"}const r=re(e,n.left);switch(Oe(r),r.scope){case"local":return`lscope['${r.var}']=lang.assign(${t},'${n.operator}', ${"="===n.operator?"null":He(`lscope['${r.var}']`)})`;case"global":return`gscope['${r.var}']=lang.assign(${t},'${n.operator}', ${"="===n.operator?"null":He(`gscope['${r.var}']`)})`;default:throw K(r.scope),new m(null,"NeverReach",n.left)}}function $e(e,n){return"AssignmentExpression"===n.expression.type?"lastStatement = lc.voidOperation; "+ue(e,n.expression)+"; \n ":"lastStatement = "+ue(e,n.expression)+"; "}function Se(e,n){return"BlockStatement"===n.type?ce(e,n):"ReturnStatement"===n.type||"BreakStatement"===n.type||"ContinueStatement"===n.type?ce(e,n)+"; ":"ExpressionStatement"===n.type?ce(e,n):ce(e,n)+"; "}function xe(e,n){return`if (lang.mustBoolean(${ue(e,n.test)}, runtimeCtx) === true) {\n    ${Se(e,n.consequent)}\n  } `+(null!==n.alternate?"IfStatement"===n.alternate.type?" else "+xe(e,n.alternate):` else {\n      ${Se(e,n.alternate)}\n    }\n`:" else {\n      lastStatement = lc.voidOperation;\n    }\n")}function Fe(e,n){let t="";for(let r=0;r<n.body.length;r++)"EmptyStatement"!==n.body[r].type&&("ReturnStatement"===n.body[r].type||"BreakStatement"===n.body[r].type||"ContinueStatement"===n.body[r].type?t+=ce(e,n.body[r])+"; \n":t+=ce(e,n.body[r])+" \n");return t}function Me(e,n){if(null===n.argument)return"return lc.voidOperation";return"return "+ue(e,n.argument)}function Ie(e,n){const t=oe(e,n.specifiers[0].local,"global"),r=e.libraryResolver?.loadLibrary(t.name),o=e.symbols.nextVarId();void 0===e.moduleFactory[r.uri]&&(e.moduleFactory[r.uri]=rn(r.syntax,e.moduleFactory,e.isAsync)),e.moduleFactoryMap[o]=r.uri;let l="";return l=e.isAsync?"(yield lang.loadModule('"+o+"', runtimeCtx) ); ":"lang.loadModule('"+o+"', runtimeCtx); ",Oe(t),`gscope['${t.var}']=${l}`}function Oe(e){if("global"===e.scope)switch(e.name){case"iif":case"when":case"defaultvalue":case"decode":throw new f}}function Ce(n,t){const r=new Set(t.params.map(n=>e(n))),o=l(t);z(o,r);const a=n.symbols,s=new Map;for(const e of o)s.set(e,a.nextVarId());const i=a.nextLocalsSymbolMapId();n.allLocalSymbolMetadata.set(i,s);const u={...n,localScope:s},c=[`lscope._SymbolsMapId = ${JSON.stringify(i)};`];for(let e=0;e<t.params.length;e++){const n=oe(u,t.params[e],"local");Oe(n),c.push(`lscope['${n.var}'] = arguments[${e}];`)}for(const[e,l]of s)r.has(e)||c.push(`lscope['${l}'] = ${Ye};`);const m=Fe(u,t.body),f=!0===n.isAsync?["return lang.__awaiter(this, void 0, void 0, function* () {",`  ${m}`,"  return lastStatement;","});"]:[m,"return lastStatement;"],p=["new lang.UserDefinedCompiledFunction(","  lang.functionDepthchecker(","    function() {","      var lastStatement = lc.voidOperation;","      var lscope = runtimeCtx.localStack[runtimeCtx.localStack.length-1];",...c,...f,"    },","    runtimeCtx,","  ),",`  ${t.params.length},`,")"].join("\n"),d=oe(n,t.id,"global");return Oe(d),`gscope['${d.var}']=${p}; lastStatement = lc.voidOperation;`}function je(e,n){const t=[];for(let r=0;r<n.declarations.length;r++)t.push(Ae(e,n.declarations[r]));return t.join("\n")+" \n lastStatement=  lc.voidOperation; \n"}function Ae(e,n){const t=null===n.init?"null":ue(e,n.init),r=oe(e,n.id);switch(Oe(r),r.scope){case"local":return`lscope['${r.var}']=${t};`;case"global":return`gscope['${r.var}']=${t};`;default:throw K(r.scope),new m(null,"NeverReach",n.id)}}function ke(e,n){try{let t;return t=!0===n.computed?ue(e,n.property):"'"+n.property.name+"'","lang.member("+ue(e,n.object)+","+t+")"}catch(t){throw t}}function Ne(e,n){try{return"lang.unary("+ue(e,n.argument)+",'"+n.operator+"')"}catch(t){throw t}}function Ee(e,n){try{const t=[];for(let r=0;r<n.elements.length;r++)"Literal"===n.elements[r].type?t.push(ue(e,n.elements[r])):t.push("lang.aCheck("+ue(e,n.elements[r])+",'ArrayExpression')");return"["+t.join(",")+"]"}catch(t){throw t}}function Be(e,n){try{const t=[];let r=0;for(const o of n.quasis)t.push(o.value?JSON.stringify(o.value.cooked):JSON.stringify("")),!1===o.tail&&(t.push(n.expressions[r]?"lang.castString(lang.aCheck("+ue(e,n.expressions[r])+", 'TemplateLiteral'))":""),r++);return"(["+t.join(",")+"]).join('')"}catch(t){throw t}}function _e(e,n){try{return"lang.binary("+ue(e,n.left)+","+ue(e,n.right)+",'"+n.operator+"')"}catch(t){throw t}}function Ve(e,n){try{if("AssignmentExpression"===n.left.type||"UpdateExpression"===n.left.type)throw new m(null,"LogicalExpressionOnlyBoolean",n);if("AssignmentExpression"===n.right.type||"UpdateExpression"===n.right.type)throw new m(null,"LogicalExpressionOnlyBoolean",n);if("&&"===n.operator||"||"===n.operator)return"(lang.logicalCheck("+ue(e,n.left)+") "+n.operator+" lang.logicalCheck("+ue(e,n.right)+"))";throw new m(null,"LogicExpressionOrAnd",null)}catch(t){throw t}}function Re(e,n){const t=re(e,n);switch(Oe(t),t.scope){case"local":return He(`lscope['${t.var}']`);case"global":return He(`gscope['${t.var}']`);default:throw K(t.scope),new m(null,"NeverReach",n)}}function Le(e,n){try{if("MemberExpression"===n.callee.type){let t;t=!0===n.callee.computed?ue(e,n.callee.property):"'"+n.callee.property.name+"'";let r="[";for(let o=0;o<n.arguments.length;o++)o>0&&(r+=", "),r+=ue(e,n.arguments[o]);return r+="]",e.isAsync?"(yield lang.callModuleFunction("+ue(e,n.callee.object)+","+r+","+t+",runtimeCtx))":"lang.callModuleFunction("+ue(e,n.callee.object)+","+r+","+t+",runtimeCtx)"}if("Identifier"!==n.callee.type)throw new m(null,"FunctionNotFound",n);const t=re(e,n.callee,"FunctionNotFound");if("global"===t.scope)switch(t.name){case"iif":return Te(e,n);case"when":return Ue(e,n);case"defaultvalue":return De(e,n);case"decode":return Ge(e,n)}let r;switch(t.scope){case"local":r=He(`lscope['${t.var}']`);break;case"global":r=He(`gscope['${t.var}']`);break;default:throw K(t.scope),new m(null,"NeverReach",n.callee)}let o="[";for(let l=0;l<n.arguments.length;l++)l>0&&(o+=", "),o+=ue(e,n.arguments[l]);return o+="]",e.isAsync?"(yield lang.callfunc("+r+","+o+",runtimeCtx) )":"lang.callfunc("+r+","+o+",runtimeCtx)"}catch(t){throw t}}function Te(e,n){try{if(3!==n.arguments.length)throw new m(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId();return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${ue(e,n.arguments[0])};\n\n        if (${t} === true) {\n          return  ${ue(e,n.arguments[1])};\n        }\n        else if (${t} === false) {\n          return ${ue(e,n.arguments[2])};\n        }\n        else {\n          lang.error('ExecutionErrorCodes.BooleanConditionRequired');\n        }\n      ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function De(e,n){try{if(n.arguments.length<2||n.arguments.length>3)throw new m(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId(),r=e.symbols.nextTempVarId();return 3===n.arguments.length?`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n      var ${t} = ${ue(e,n.arguments[0])};\n      var ${r} = ${ue(e,n.arguments[1])};\n      ${t} = lang.getNestedOptionalValue(${t}, ${r});\n      return ${t} != null && ${t} !== "" ? ${t} : ${ue(e,n.arguments[2])};\n      ${e.isAsync?"})}()))":"}()"}`:`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${ue(e,n.arguments[0])};\n        if (${t} === null) {\n          return  ${ue(e,n.arguments[1])};\n        }\n        if (${t} === "") {\n          return  ${ue(e,n.arguments[1])};\n        }\n        if (${t} === undefined) {\n          return  ${ue(e,n.arguments[1])};\n        }\n        return ${t};\n      ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Ue(e,n){try{if(n.arguments.length<3)throw new m(null,"WrongNumberOfParameters",n);if(n.arguments.length%2==0)throw new m(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId();let r="var ";for(let o=0;o<n.arguments.length-1;o+=2)r+=`${t} = lang.mustBoolean(${ue(e,n.arguments[o])}, runtimeCtx);\n      if (${t} === true ) {\n        return ${ue(e,n.arguments[o+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        ${r}\n        return ${ue(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Ge(e,n){try{if(n.arguments.length<2)throw new m(null,"WrongNumberOfParameters",n);if(2===n.arguments.length)return`(${ue(e,n.arguments[1])})`;if((n.arguments.length-1)%2==0)throw new m(null,"WrongNumberOfParameters",n);const t=e.symbols.nextTempVarId(),r=e.symbols.nextTempVarId();let o="var ";for(let l=1;l<n.arguments.length-1;l+=2)o+=`${r} = ${ue(e,n.arguments[l])};\n      if (lang.binary(${r}, ${t}, "==") === true ) {\n        return ${ue(e,n.arguments[l+1])}\n      }\n`;return`${e.isAsync?"(yield (function() { \n return lang.__awaiter(this, void 0, void 0, function* () {":"function() {"}\n        var ${t} = ${ue(e,n.arguments[0])};\n        ${o}\n        return ${ue(e,n.arguments[n.arguments.length-1])}\n        ${e.isAsync?"})}()))":"}()"}`}catch(t){throw t}}function Ke(e,n){try{return se(e,n,(e,n)=>{throw new c(e,"Unrecognized",n)})}catch(t){throw t}}function qe(e){const n=function(){this.textformatting=u.textFormatting()};n.prototype=Object.create(null),n.provided=new Set(["textformatting","infinity","pi"]),n.prototype.infinity=Number.POSITIVE_INFINITY,n.prototype.pi=Math.PI;for(const[t,r]of Object.entries(e))n.prototype[t]=new d(r),n.provided.add(t);return n}function Pe(){const e=Object.create(null);_(e,se),U(e,se),V(e,se,le),T(e,se),R(e,se),D(e,se),G(e,se),e.iif=Ke,e.decode=Ke,e.when=Ke,e.defaultvalue=Ke;const n=qe(e);L(e,se);return{ScopeSync:qe(e),ScopeAsync:n}}const{ScopeSync:ze,ScopeAsync:We}=Pe();function Ze(e,n){const t={mode:n,compiled:!0,functions:Object.create(null),signatures:[],standardFunction:se,standardFunctionAsync:se,evaluateIdentifier:le};for(const r of e)r.registerFunctions(t);if("sync"===n)for(const[r,o]of Object.entries(t.functions))ze.prototype[r]=new d(o),ze.provided.add(r);else for(const[r,o]of Object.entries(t.functions))We.prototype[r]=new d(o),We.provided.add(r);for(const r of t.signatures)N(r,n)}Ze([B],"sync"),Ze([B],"async"),Ze([E],"async");const Je=Symbol("uninitialized"),Ye="lang.uninitialized";function He(e){return`lang.requireInitialized(${e})`}const Qe={uninitialized:Je,requireInitialized(e){if(e===Je)throw new c(null,"InvalidIdentifier",null);return e},isNumber:e=>Q(e),isArray:e=>H(e),isImmutableArray:e=>S(e),isDictionaryLike:e=>$(e),isString:e=>Y(e),isDictionary:e=>k(e),isGeometry:e=>A(e),getGeometryKeys:e=>i(e),geometryMember:(e,n,t,r,o=1)=>s(e,n,t,r,o),error(e){throw new c(null,e,null)},__awaiter(e,n,t,r){const o=r.apply(e,n||[]);let l=o.next();for(;!l.done&&!P(l.value);)l=o.next(l.value);return l.done?l.value:new Promise((e,n)=>{function t(r){for(;!r.done;){if(P(r.value))return void Promise.resolve(r.value).then(e=>{try{t(o.next(e))}catch(r){n(r)}},e=>{try{t(o.throw(e))}catch(r){n(r)}});try{r=o.next(r.value)}catch(l){return void n(l)}}e(r.value)}t(l)})},functionDepthchecker:(e,n)=>function(){if(n.depthCounter.depth++,n.localStack.push({}),n.depthCounter.depth>64)throw new c(null,"MaximumCallDepth",null);const t=e.apply(this,arguments);return P(t)?t.then(e=>(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,e)):(n.depthCounter.depth--,n.localStack.length=n.localStack.length-1,t)},mustBoolean(e,n){if(!0===e||!1===e)return e;throw new c(n,"BooleanConditionRequired",null)},castString:e=>M(e),aCheck(e,n){if(v(e)){if("ArrayExpression"===n)throw new c(null,"NoFunctionInArray",null);if("ObjectExpression"===n)throw new c(null,"NoFunctionInDictionary",null);throw new c(null,"NoFunctionInTemplateLiteral",null)}return e===I?null:e},Dictionary:u,Feature:p,UserDefinedCompiledFunction:ae,dictionary(e){const n=Object.create(null),t=new Map;for(let o=0;o<e.length;o+=2){if(v(e[o+1]))throw new c(null,"NoFunctionInDictionary",null);if(!1===Y(e[o]))throw new c(null,"KeyMustBeString",null);let r=e[o].toString();const l=r.toLowerCase();t.has(l)?r=t.get(l):t.set(l,r),e[o+1]===I?n[r]=null:n[r]=e[o+1]}const r=new u(n);return r.immutable=!1,r},entry:(e,n)=>u.containerEntry(e,n),strCheck(e){if(!1===Y(e))throw new c(null,"KeyMustBeString",null);return e},unary(e,n){if(X(e)){if("!"===n)return!e;if("-"===n)return-1*F(e);if("+"===n)return 1*F(e);if("~"===n)return~F(e);throw new c(null,"UnsupportUnaryOperator",null)}if("-"===n)return-1*F(e);if("+"===n)return 1*F(e);if("~"===n)return~F(e);throw new c(null,"UnsupportUnaryOperator",null)},logicalCheck(e){if(!1===X(e))throw new c(null,"LogicExpressionOrAnd",null);return e},logical(e,n,t){if(X(e)&&X(n))switch(t){case"||":return e||n;case"&&":return e&&n;default:throw new c(null,"LogicExpressionOrAnd",null)}throw new c(null,"LogicExpressionOrAnd",null)},binary(e,n,t){switch(t){case"|":case"<<":case">>":case">>>":case"^":case"&":return j(F(e),F(n),t);case"==":case"=":return C(e,n);case"!=":return!C(e,n);case"<":case">":case"<=":case">=":return O(e,n,t);case"+":return Y(e)||Y(n)?M(e)+M(n):F(e)+F(n);case"-":return F(e)-F(n);case"*":return F(e)*F(n);case"/":return F(e)/F(n);case"%":return F(e)%F(n);default:throw new c(null,"UnsupportedOperator",null)}},assign(e,n,t){switch(n){case"=":return e===I?null:e;case"/=":return F(t)/F(e);case"*=":return F(t)*F(e);case"-=":return F(t)-F(e);case"+=":return Y(t)||Y(e)?M(t)+M(e):F(t)+F(e);case"%=":return F(t)%F(e);default:throw new c(null,"UnsupportedOperator",null)}},update(e,n,t,r){const o=F(this.requireInitialized(e[n]));return e[n]="++"===t?o+1:o-1,!1===r?o:"++"===t?o+1:o-1},graphicToFeature:(e,n,t)=>null===e?null:p.createFromGraphicLikeObject(e.geometry,e.attributes,n,t.timeZone),memberupdate(e,n,t,r){let o;if(H(e)){if(!Q(n))throw new c(null,"ArrayAccessMustBeNumber",null);if(n<0&&(n=e.length+n),n<0||n>=e.length)throw new c(null,"OutOfBounds",null);o=F(e[n]),e[n]="++"===t?o+1:o-1}else if(e instanceof u){if(!1===Y(n))throw new c(null,"KeyAccessorMustBeString",null);if(!0!==e.hasField(n))throw new c(null,"FieldNotFound",null,{key:n});o=F(e.field(n)),e.setField(n,"++"===t?o+1:o-1)}else if(x(e)){if(!1===Y(n))throw new c(null,"KeyAccessorMustBeString",null);if(!0!==e.hasField(n))throw new c(null,"FieldNotFound",null);o=F(e.field(n)),e.setField(n,"++"===t?o+1:o-1)}else{if(S(e))throw new c(null,"Immutable",null);if(!(e instanceof tn))throw new c(null,"InvalidIdentifier",null);if(!1===Y(n))throw new c(null,"ModuleAccessorMustBeString",null);if(!0!==e.hasGlobal(n))throw new c(null,"ModuleExportNotFound",null);o=F(e.global(n)),e.setGlobal(n,"++"===t?o+1:o-1)}return!1===r?o:"++"===t?o+1:o-1},assignmember(e,n,t,r){if(H(e)){if(!Q(n))throw new c(null,"ArrayAccessMustBeNumber",null);if(n<0&&(n=e.length+n),n<0||n>e.length)throw new c(null,"OutOfBounds",null);if(n===e.length){if("="!==t)throw new c(null,"OutOfBounds",null);e[n]=this.assign(r,t,e[n])}else e[n]=this.assign(r,t,e[n])}else if(e instanceof u){if(!1===Y(n))throw new c(null,"KeyAccessorMustBeString",null);if(!0===e.hasField(n))e.setField(n,this.assign(r,t,e.field(n)));else{if("="!==t)throw new c(null,"FieldNotFound",null);e.setField(n,this.assign(r,t,null))}}else if(x(e)){if(!1===Y(n))throw new c(null,"KeyAccessorMustBeString",null);if(!0===e.hasField(n))e.setField(n,this.assign(r,t,e.field(n)));else{if("="!==t)throw new c(null,"FieldNotFound",null);e.setField(n,this.assign(r,t,null))}}else{if(S(e))throw new c(null,"Immutable",null);if(!(e instanceof tn))throw new c(null,"InvalidIdentifier",null);if(!1===Y(n))throw new c(null,"ModuleAccessorMustBeString",null);if(!e.hasGlobal(n))throw new c(null,"ModuleExportNotFound",null);e.setGlobal(n,this.assign(r,t,e.global(n)))}},member(e,n){if(null===e)throw new c(null,"MemberOfNull",null);if(e instanceof u||$(e)){if(Y(n))return e.field(n);throw new c(null,"InvalidMemberAccessKey",null)}if(e instanceof W){if(Y(n))return s(e,n,null,null);throw new c(null,"InvalidMemberAccessKey",null)}if(H(e)){if(Q(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new c(null,"OutOfBounds",null);return e[n]}throw new c(null,"InvalidMemberAccessKey",null)}if(Y(e)){if(Q(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length+n),n>=e.length||n<0)throw new c(null,"OutOfBounds",null);return e[n]}throw new c(null,"InvalidMemberAccessKey",null)}if(S(e)){if(Q(n)&&isFinite(n)&&Math.floor(n)===n){if(n<0&&(n=e.length()+n),n>=e.length()||n<0)throw new c(null,"OutOfBounds",null);return e.get(n)}throw new c(null,"InvalidMemberAccessKey",null)}if(e instanceof tn){if(Y(n))return e.global(n);throw new c(null,"InvalidMemberAccessKey",null)}throw new c(null,"InvalidMemberAccessKey",null)},callfunc:(e,n,t)=>e.call(t,{arguments:n,preparsed:!0}),loadModule(e,n){const t=n.moduleFactoryMap[e];if(n.moduleSingletons[t])return n.moduleSingletons[t];const r=n.moduleFactory[t]({moduleSingletons:n.moduleSingletons,depthCounter:n.depthCounter,lrucache:n.lrucache,interceptor:n.interceptor,services:n.services,console:n.console,abortSignal:n.abortSignal,timeZone:n.timeZone??null,spatialReference:n.spatialReference});return n.moduleSingletons[t]=r,r},callModuleFunction(e,n,t,r){if(!(e instanceof tn))throw new c(null,"FunctionNotFound",null);const o=e.global(t);if(!1===v(o))throw new c(null,"CallNonFunction",null);return o.call(r,{preparsed:!0,arguments:n})},getNestedOptionalValue:(e,n)=>a(e,n)};function Xe(e){console.log(e)}function en(t,o,l=!1){let a=null;t.usesModules&&(a=new r(null,t.loadedModules));const s=Object.create(null),i=new Set(Object.keys(o?.vars||{}).map(n=>e(n))),u=new Set(Object.keys(o?.customfunctions||{}).map(n=>e(n))),m=ie(t,l?We.provided:ze.provided,new Set([...i,...u]),l,a,s);let f;f=l?["var runtimeCtx = this.prepare(context, true);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","return lang.__awaiter(this, void 0, void 0, function* () {","  function mainBody() {","    return lang.__awaiter(this, void 0, void 0, function* () {",`      ${m.body}`,"    });","  }","  return this.postProcess(yield mainBody());","});"].join("\n"):["var runtimeCtx = this.prepare(context, false);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","function mainBody() {",`  ${m.body}`,"}","return this.postProcess(mainBody());"].join("\n");const{symbolMetadata:d,moduleFactoryMap:g}=m,h={lc:w,lang:Qe,postProcess(e){if(b(e))return null;if(v(e))throw new c(null,"IllegalResult",null);return e},prepare(e,t){const r=e.spatialReference??Z.WebMercator,o=t?new We:new ze;for(const n of u)null!=e.customfunctions&&n in e.customfunctions?o[n]=e.customfunctions[n]??null:o[n]=Je;for(const n of i){if(null==e.vars||!(n in e.vars)){n in o||(o[n]=Je);continue}const t=e.vars[n]??null;J(t)?o[n]=p.createFromGraphic(t,e.timeZone??null):o[n]=t}return{lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??Xe,abortSignal:e.abortSignal??n,timeZone:e.timeZone??null,spatialReference:r,track:e.track,globalScope:o,localStack:[],depthCounter:{depth:1},symbolMetadata:d,moduleFactory:s,moduleFactoryMap:g,moduleSingletons:Object.create(null)}}};return new Function("context",f).bind(h)}async function nn(){return Ze([await import("./functions/geomasync.js")],"async"),!0}class tn extends t{constructor(e){super(),this.moduleContext=e}hasGlobal(n){const t=this.moduleContext.symbolMetadata.exports;return t.has(n)||t.has(e(n))}setGlobal(n,t){if(v(t))throw new c(null,"AssignModuleFunction",null);const r=this.moduleContext.symbolMetadata.globals.get(e(n));if(null==r)throw new c(null,"ModuleExportNotFound",null);this.moduleContext.globalScope[r]=t}global(n){const t=this.moduleContext.symbolMetadata.globals.get(e(n));if(null==t)throw new c(null,"ModuleExportNotFound",null);const r=this.moduleContext.globalScope,o=Qe.requireInitialized(r[t]);if(v(o)&&!(o instanceof h)){const e=new h;return e.fn=o,e.parameterEvaluator=se,e.context=this.moduleContext,r[t]=e,e}return o}}function rn(e,t,o){const l=new r(null,e.loadedModules),a=ie(e,o?We.provided:ze.provided,new Set,o,l,t);let s;s=o?["var runtimeCtx = this.prepare(context, true);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","return lang.__awaiter(this, void 0, void 0, function* () {","  function mainBody() {","    return lang.__awaiter(this, void 0, void 0, function* () {",`      ${a.body}`,"    });","  }","  yield mainBody();","  return this.prepareModule(runtimeCtx);","});"].join("\n"):["var runtimeCtx = this.prepare(context, false);","var lc = this.lc;","var lang = this.lang;","var gscope = runtimeCtx.globalScope;","function mainBody() {",`  ${a.body}`,"}","mainBody();","return this.prepareModule(runtimeCtx);"].join("\n");const{symbolMetadata:i,moduleFactoryMap:u}=a,c={lc:w,lang:Qe,prepareModule:e=>new tn(e),prepare(e,r){const o=e.spatialReference??Z.WebMercator,l=r?new We:new ze;return{lrucache:e.lrucache,interceptor:e.interceptor,services:e.services,console:e.console??Xe,abortSignal:e.abortSignal??n,timeZone:e.timeZone??null,spatialReference:o,track:null,globalScope:l,localStack:[],depthCounter:e.depthCounter,symbolMetadata:i,moduleFactory:t,moduleFactoryMap:u,moduleSingletons:e.moduleSingletons}}};return new Function("context",s).bind(c)}export{ae as UserDefinedCompiledFunction,en as compileScript,nn as enableAsyncSupport,Ze as extend};
