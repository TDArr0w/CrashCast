/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import"../core/has.js";import{rad2deg as t}from"../core/mathUtils.js";import{set as o}from"../core/libs/gl-matrix-2/math/vec2.js";import{create as r}from"../core/libs/gl-matrix-2/factories/vec2f64.js";import n from"../geometry/Polygon.js";import e from"../geometry/SpatialReference.js";import{toExtent as s}from"../geometry/support/aaBoundingRect.js";import{earth as i}from"../geometry/support/Ellipsoid.js";import{convertFromPolygon as c}from"../layers/graphics/featureConversionUtils.js";import f from"../layers/graphics/OptimizedGeometry.js";import{project as a}from"../layers/graphics/data/projectionSupport.js";const l=16,u=8,m=4,h=2,p=1,g=r(),d=r(),x=-90,y=90,j=-180,M=180,S="0123456789bcdefghjkmnpqrstuvwxyz",b=64;function v(t,o,r,i){const l=[t.xmin,t.ymin,t.xmax,t.ymax],u=n.fromExtent(s(l,i)),m=a(u,i,e.WGS84,{extendedParams:{densificationStep:o*b}});if(!m)return null;const h=c(new f,m,!1,!1),p=h.coords.filter((t,o)=>!(o%2)),g=h.coords.filter((t,o)=>o%2),d=Math.min(...p),x=Math.min(...g),y=Math.max(...p),j=Math.max(...g),M=G(d,x,r,e.WGS84),S=G(y,j,r,e.WGS84);return M&&S?{bounds:l,geohashBounds:{xLL:M[0],yLL:M[1],xTR:S[0],yTR:S[1]},level:r}:null}function G(o,r,n,s){if(s.isWebMercator){const e=t(o/i.radius),s=e-360*Math.floor((e+180)/360),c=[0,0];return z(c,0,t(Math.PI/2-2*Math.atan(Math.exp(-r/i.radius))),s,n),c}const c=a({x:o,y:r},s,e.WGS84);if(!c)return null;const f=[0,0];return z(f,0,c.y,c.x,n),f}function W(t){return t<=57?t-48:t<=104?t-88:t<=107?t-89:t<=110?t-90:t-91}function C(t){return S[t]}function L(t){return(t[0]+t[1])/2}function R(t,o){const r=L(t),n=o,e=!o;t[0]=e*t[0]+n*r,t[1]=e*r+n*t[1]}function A(t,o){const r=o>L(t);return R(t,r),r}function P(t,r){const n=o(g,x,y),e=o(d,j,M);for(let o=0;o<r.length;o++){const t=W(r.charCodeAt(o));o%2==0?(R(e,!!(l&t)),R(e,!!(m&t)),R(e,!!(p&t)),R(n,!!(u&t)),R(n,!!(h&t))):(R(n,!!(l&t)),R(n,!!(m&t)),R(n,!!(p&t)),R(e,!!(u&t)),R(e,!!(h&t)))}return t[0]=L(n),t[1]=L(e),t}function X(t,o){let r=0,n=0,e=30,s=30;for(let i=0;i<o.length;i++){const t=W(o.charCodeAt(i)),c=i%2==0;e-=c?3:2,s-=c?2:3,r|=T(t,c)<<e,n|=U(t,c)<<s}return{geohashX:r,geohashY:n}}function Y(t,o){let r=-90,n=90,e=-180,s=180;for(let i=0;i<o;i++){const o=Math.ceil((i+1)/2),c=Math.floor((i+1)/2),f=1-i%2,a=30-(3*o+2*c),l=30-(2*o+3*c),u=3*f+2*(1-f),m=2*f+3*(1-f),h=3*f+7*(1-f)<<l,p=(7*f+3*(1-f)<<a&t.geohashX)>>a,g=(h&t.geohashY)>>l;for(let t=u-1;t>=0;t--){const o=(e+s)/2,r=p&1<<t?1:0;e=(1-r)*e+r*o,s=(1-r)*o+r*s}for(let t=m-1;t>=0;t--){const o=(r+n)/2,e=g&1<<t?1:0;r=(1-e)*r+e*o,n=(1-e)*o+e*n}}return[e,r,s,n]}function w(t,o,r,n){n%2&&(n+=1);let e=0,s=0,i=-90,c=90,f=-180,a=180;for(let l=0;l<n/2;l++){for(let t=0;t<5;t++){const o=(f+a)/2,n=r>o?1:0;e|=n<<29-(t+5*l),f=(1-n)*f+n*o,a=(1-n)*o+n*a}for(let t=0;t<5;t++){const r=(i+c)/2,n=o>r?1:0;s|=n<<29-(t+5*l),i=(1-n)*i+n*r,c=(1-n)*r+n*c}}t.geohashX=e,t.geohashY=s}function z(t,o,r,n,e){e%2&&(e+=1);let s=0,i=0,c=-90,f=90,a=-180,l=180;for(let u=0;u<e/2;u++){for(let t=0;t<5;t++){const o=(a+l)/2,r=n>o?1:0;s|=r<<29-(t+5*u),a=(1-r)*a+r*o,l=(1-r)*o+r*l}for(let t=0;t<5;t++){const o=(c+f)/2,n=r>o?1:0;i|=n<<29-(t+5*u),c=(1-n)*c+n*o,f=(1-n)*o+n*f}}t[2*o]=s,t[2*o+1]=i}function B(t,r,n){let e="";const s=o(g,-90,90),i=o(d,-180,180);for(let o=0;o<n;o++){let n=0;!(o%2)?(n|=A(i,r)<<4,n|=A(s,t)<<3,n|=A(i,r)<<2,n|=A(s,t)<<1,n|=A(i,r)|0):(n|=A(s,t)<<4,n|=A(i,r)<<3,n|=A(s,t)<<2,n|=A(i,r)<<1,n|=A(s,t)|0),e+=C(n)}return e}function E(t,o,r){return r?t&p|(o&p)<<1|(t&h)<<1|(o&h)<<2|(t&m)<<2:o&p|(t&p)<<1|(o&h)<<1|(t&h)<<2|(o&m)<<2}function T(t,o){return o?p&t|(m&t)>>1|(l&t)>>2:(h&t)>>1|(u&t)>>2}function U(t,o){return o?(h&t)>>1|(u&t)>>2:p&t|(m&t)>>1|(l&t)>>2}function k(t,o,r){const n=!((t.length-1)%2),e=t.slice(0,-1),s=W(t.charCodeAt(t.length-1));let i=0,c=0,f=0,a=0;n?(i=8,c=4,f=p&s|(m&s)>>1|(l&s)>>2,a=(h&s)>>1|(u&s)>>2):(i=4,c=8,a=p&s|(m&s)>>1|(l&s)>>2,f=(h&s)>>1|(u&s)>>2);const g=f+o,d=a+r,x=Math.floor(g/i),y=Math.floor(d/c),j=C(E(g-x*i,d-y*c,n));return t.length>1&&(x||y)?k(e,x,y)+j:e+j}export{X as convertGeohash32ToXY,W as decodeBase32Char,P as decodeGeohash,Y as decodeGeohashXY,C as encodeBase32Char,B as encodeGeohash,G as getGeohash,v as getGeohashBounds,k as getRelativeGeohash,z as setGeohashBuf,w as setGeohashXY,T as unpackXBits,U as unpackYBits};
