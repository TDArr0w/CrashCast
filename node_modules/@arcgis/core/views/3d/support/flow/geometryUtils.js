/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import o from"../../../../Color.js";import{fromValues as t}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{newFloatArray as e}from"../../../../geometry/support/FloatArray.js";import{newHalfFloatArray as r}from"../../../../geometry/support/HalfFloatArray.js";import{zValueInAbsoluteHeightMode as i}from"../../../../support/elevationInfoUtils.js";import{convertVisualVariables as s,ConvertOptions as n}from"../../layers/support/FastSymbolUpdates.js";import{animatedLineStripsToParameters as a,createGeometry as l}from"../engineContent/line.js";import{valuesPerFlowVertex as p}from"./loadUtils.js";import{drapedZ as m}from"../../terrain/OverlayRenderer.js";function c(o,t,{vertices:i,stage:s,hasMagnitude:n},c,f,d){const{spatialReference:v}=t.extent,h=[],y=p(n),g=t.flowExtentInfo.modelSize[0];let j=0;for(let e=0;e<i.length;e+=y){if(d&&e>0){const o=i[e]-i[e-y];o>g/2?j-=g:-o>g/2&&(j+=g)}const[r,s]=t.modelToMapSpace(i[e]+j,i[e+1],!1),n=d?[r,s,m]:u(r,s,v,o,c);h.push(n)}const S=Math.floor(i.length/y),V=r(S);for(let e=0;e<S;e++)V[e]=i[e*y+2];const{hasVVColor:C,hasVVOpacity:b,hasVVSize:z}=f.parameters;let w,x,R;if(n&&(C||b||z)){const o=e(S);for(let t=0;t<S;t++)o[t]=i[t*y+3];C&&(w=[o]),b&&(x=[o]),z&&(R=[o])}const U=a([h],void 0,[{timeStamps:V,streamlineType:s}],w,x,R);return l(f,U[0])}function f(t,e,r){if(null==t)return{};let i=null;if(t.visualVariables){const o=[],e=t.visualVariables,r=new n({supports:{size:!0,color:!0,rotation:!1,opacity:!0}});i=s(e,r,o)}const a=i?.color?[1,1,1,1]:o.toUnitRGBA(t.color);a[3]*=e;return{color:a,width:t.trailWidth,cap:0,animationSpeed:t.flowSpeed,trailLength:t.trailLength,animation:3,emissiveStrength:r,vvColor:i?.color,vvOpacity:i?.opacity,vvSize:i?.size}}function u(o,e,r,s,n){const{absoluteZ:a}=i(o,e,0,r,s,n),l=t(o,e,a);return s.renderCoordsHelper.toRenderCoords(l,r,l),l}export{c as createStreamlineGeometry,f as materialParametersFromRenderer};
