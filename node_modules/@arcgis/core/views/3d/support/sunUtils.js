/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import t from"../../../core/Logger.js";import{clamp as e,lerp as i}from"../../../core/mathUtils.js";import{fromRotation as o,identity as n,rotateX as a,rotateY as r,rotateZ as l}from"../../../core/libs/gl-matrix-2/math/mat4.js";import{create as c}from"../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{copy as s,lerp as u}from"../../../core/libs/gl-matrix-2/math/vec2.js";import{fromValues as m,create as g}from"../../../core/libs/gl-matrix-2/factories/vec2f64.js";import{j as d,l as f,n as h,h as b,t as p,g as y,d as A}from"../../../chunks/vec32.js";import{fromValues as w,clone as v,create as x}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{S as M}from"../../../chunks/SunCalc.js";import{angle as N}from"./mathUtils.js";const T={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};class O{constructor(t,e){this.direct=t,this.ambient=e}}function j(t,o,n,a,r,l){d(l.ambient.color,1,1,1),l.ambient.intensity=T.global.ambient,d(l.direct.color,1,1,1),l.direct.intensity=T.global.direct;const c=o[2],s=e((Math.abs(c)-T.local.altitude)/(T.global.altitude-T.local.altitude),0,1);let u;if(l.globalFactor=s,null!=t&&(u=M.getTimes(t,o[1],o[0])),s<1){let e;if(null!=t)e=ot(t,u,a);else{const t=R(a);e={direct:{intensity:T.local.directAtNoon*t.direct,color:w(1,1,1)},ambient:{intensity:T.local.ambientAtNoon*t.ambient,color:w(1,1,1)},timeOfDay:"early afternoon"}}f(l.ambient.color,e.ambient.color,l.ambient.color,s),l.ambient.intensity=i(e.ambient.intensity,l.ambient.intensity,s),f(l.direct.color,e.direct.color,l.direct.color,s),l.direct.intensity=i(e.direct.intensity,l.direct.intensity,s),l.specularStrength="rainy"===a||"snowy"===a||"foggy"===a?0:1,l.environmentStrength="rainy"===a?.7:"snowy"===a||"foggy"===a?.75:1}l.noonFactor=null!=t?F(t,u):1,null!=t?P(t,o,n,l.direct.directionToLightSource):S(r,n,l.direct.directionToLightSource)}function S(t,e,i){1===e?h(rt,t.eye):d(rt,0,0,1),b(lt,t.viewForward,-1);const n=N(lt,rt),a=Math.max(n-2*st,0),r=.85*a/(a+1),l=Math.max(st,n-st-r);o(at,-l,t.viewRight),p(i,lt,at),y(i,i,b(ct,t.viewRight,ut)),h(i,i)}function P(t,i,o,c){const s=H,u=n(L);if(1===o)M.getPosition(t,0,0,s),d(c,0,0,-1),a(u,u,-s.azimuth),r(u,u,-s.altitude),p(c,c,u);else{const o=T.planarDirection,n=o.globalAngles,r=i[2];let m=(Math.abs(r)-o.localAltitude)/(o.globalAltitude-o.localAltitude);m=e(m,0,1),m<1?(M.getPosition(t,i[1],i[0],s),s.azimuth=(1-m)*s.azimuth+m*n.azimuth,s.altitude=(1-m)*s.altitude+m*n.altitude):(s.azimuth=n.azimuth,s.altitude=n.altitude),d(c,0,-1,0),l(u,u,-s.azimuth),a(u,u,-s.altitude),p(c,c,u)}}function z(t,e){if(1===e)return!0;const i=T.planarDirection;return Math.abs(t)<i.localAltitude}function D(e,i,o,n,a,r){const l=e.getTime(),c=Math.max(0,i.getTime()-l),s=Math.floor(c/o)+1,u=Math.min(r,s),m=new Array(u),g=1===u?0:c/(u-1);s>u&&t.getLogger("esri.views.3d.support.sunUtils").warnOnce("computeDirectionsOverTime",`Requested interval ${o} exceeds maximum supported interval of ${Math.floor(g)} based on the provided time range.`);for(let t=0;t<u;++t)nt.setTime(l+g*t),m[t]=x(),P(nt,n,a,m[t]);return m}const E=w(.5773502691896258,-.5773502691896258,.5773502691896258);class I{constructor(){this.ambient={color:w(1,1,1),intensity:.55},this.direct={color:w(1,1,1),intensity:.55,directionToLightSource:v(E)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const L=c(),H={azimuth:0,altitude:0};function F(t,i){const o=t.valueOf();let n,a;i.polarException===M.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):i.polarException===M.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=i.sunrise.valueOf(),a=i.sunset.valueOf());const r=n+(a-n)/2;return 1-e(Math.abs(o-r)/432e5,0,1)}function R(t){switch(t){case"disabled":case"sunny":case"cloudy":return new O(1,1);case"rainy":return new O(.4,1.2);case"snowy":return new O(.5,1.3);case"foggy":return new O(.2,1.6)}}function U(t,e){const i=(t[0]+t[1]+t[2])/3;t[0]+=(i-t[0])*e,t[1]+=(i-t[1])*e,t[2]+=(i-t[2])*e}const G=w(.01,.01,.01),_=w(1,.6,.5),k=w(1,.98,.98),$=w(1,1,1),q=w(.8,.8,1),C=w(.8,.8,1),V=w(.98,.98,1),B=w(1,1,1),J=m(.01,T.local.ambientAtNight),K=m(T.local.directAtTwilight,T.local.ambientAtTwilight),Q=m(.9*T.local.directAtNoon,T.local.ambientAtNoon),W=m(T.local.directAtNoon,T.local.ambientAtNoon),X=Q,Y=k,Z=V,tt=K,et=_,it=C;function ot(t,e,i){const o=t.valueOf();let n,a;e.polarException===M.PolarException.MIDNIGHT_SUN?(n=o-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,a=n+432e6):e.polarException===M.PolarException.POLAR_NIGHT?(n=o-2,a=o-1):(n=e.sunrise.valueOf(),a=e.sunset.valueOf());const r=a-n,l=n+r/2,c=r/4,m=l-c,d=l+c,h=.06*r,b=n-h/2,p=n+h/2,y=a-h/2,w=a+h/2,v=g(),N=x(),T=x();let O="";if(o<b||o>w)s(v,J),A(N,G),A(T,q),O="night";else if(o<p){const t=(o-b)/(p-b);u(v,J,K,t),f(N,G,_,t),f(T,q,C,t),O="sun rising"}else if(o<m){const t=(o-p)/(m-p);u(v,K,Q,t),f(N,_,k,t),f(T,C,V,t),O="early morning"}else if(o<l){const t=(o-m)/(l-m);u(v,Q,W,t),f(N,k,$,t),f(T,V,B,t),O="late morning"}else if(o<d){const t=(o-l)/(d-l);u(v,W,X,t),f(N,$,Y,t),f(T,B,Z,t),O="early afternoon"}else if(o<y){const t=(o-d)/(y-d);u(v,X,tt,t),f(N,Y,et,t),f(T,Z,it,t),O="late afternoon"}else if(o<w){const t=(o-y)/(w-y);u(v,tt,J,t),f(N,et,G,t),f(T,it,q,t),O="sun setting"}let j=0;switch(i){case"rainy":case"foggy":j=.8;break;case"snowy":j=.5}j>0&&(U(N,j),U(T,j));const S=R(i);return{direct:{intensity:v[0]*S.direct,color:N},ambient:{intensity:v[1]*S.ambient,color:T},timeOfDay:O}}const nt=new Date(0),at=c(),rt=x(),lt=x(),ct=x(),st=.25,ut=.2;export{I as ColorAndIntensity,j as computeColorAndIntensity,D as computeDirectionsOverTime,z as computeShadowsEnabled,S as computeVirtualLightDirection};
