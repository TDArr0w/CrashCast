/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{isValidMbs as e}from"./I3SUtil.js";import{I3sTarget as t}from"./Intersector.js";import{IntersectorResult as i}from"../../webgl-engine/lib/IntersectorResult.js";import{MeshIntersectionOptions as n}from"../../webgl-engine/lib/RayIntersections.js";import{getVerticalOffsetI3S as s}from"../../webgl-engine/lib/verticalOffsetUtils.js";class r{constructor(e){this.type=2,this._needVerticalOffset=!1,this.layerViewUid=e.layerViewUid,this.sublayerId=e.sublayerId,this._collection=e.collection,this._traverseNodeHierarchy=e.traverseNodeHierarchy,this.slicePlaneEnabled=e.slicePlaneEnabled,this.isGround=e.isGround}updateElevationAlignState(e,t){this._needVerticalOffset=e&&1===t}intersect(r,o,c,a,d,u){const b=2===r.options.store,f=r.ray.direction;let h=e=>e,y=e=>e;const m=s(r.verticalOffset??(this._needVerticalOffset?0:null));null!=r.verticalOffset&&null!=m&&(h=e=>m.applyToMbs(e),y=e=>m.applyToObb(e));const{results:p,tolerance:R}=r,I=new n(R,u,r.options.normalRequired),g=(n,s)=>{if(0===n.childrenLoaded)return!1;const d=n.serviceObbInRenderSR?.isValid?n.serviceObbInRenderSR:null;return!(d&&!y(d).intersectRay(c,f,R))&&(!s||!d&&e(n.serviceMbsInRenderSR)&&!l(h(n.serviceMbsInRenderSR),c,f,R)||null!=n.geometryObbInRenderSR&&!y(n.geometryObbInRenderSR).intersectRay(c,f,R)||this._collection.intersect(s,c,a,m,I,(e,s,l,d)=>{if(s<0||null!=o&&!o(c,a,s))return;const u=i=>{const r=new t(this.layerViewUid,this.sublayerId,n.index,e,d);i.set(this.type,r,s,l)};if(this.isGround&&(null==p.ground.distance||s<p.ground.distance)&&u(p.ground),!r.options.isFiltered&&((null==p.min.distance||s<p.min.distance)&&u(p.min),(null==p.max.distance||s>p.max.distance)&&u(p.max),b)){const e=new i(r.ray);u(e),r.results.all.push(e)}}),!0)};this._traverseNodeHierarchy(g)}}function l(e,t,i,n=0){const s=e[3]+n,r=t[0]-e[0],l=t[1]-e[1],o=t[2]-e[2],c=i[0],a=i[1],d=i[2],u=c*r+a*l+d*o;return u*u-(c*c+a*a+d*d)*(r*r+l*l+o*o-s*s)>=0}export{r as I3SIntersectionHandler};
