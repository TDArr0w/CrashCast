/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as r}from"tslib";import t from"../../../../core/Accessor.js";import{removeUnordered as s}from"../../../../core/arrayUtils.js";import{makeHandle as e}from"../../../../core/handleUtils.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/has.js";import"../../../../core/Logger.js";import{subclass as n}from"../../../../core/accessorSupport/decorators/subclass.js";import{TaskPriority as i}from"../../../support/Scheduler.js";let a=class extends t{constructor(){super(...arguments),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get readyToRun(){return this.callbacks.some(r=>r.running)}runTask(r){this._sort();const t=this.callbacks,s={numIndexLoading:0,numNodesLoading:0};for(let e=0;e<t.length&&!r.done;++e)t[e].priority=t[e].runTask(r,s),this.runIndex=e}_sort(){const r=this.callbacks;let t=r.length;for(let s=this.runIndex;s>0;s--){const e=r[s-1];let o=s;for(;o<r.length&&e.priority<=r[o].priority&&(o!==t||e.priority<r[o].priority);)r[o-1]=r[o],o++;r[o-1]=e,t=o-1}this.runIndex=0}add(r){this._sort(),r.priority=1/0,this.callbacks.unshift(r),this.notifyChange("readyToRun")}remove(r){s(this.callbacks,r),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("readyToRun")}};r([o({readOnly:!0})],a.prototype,"readyToRun",null),a=r([n("esri.views.3d.layers.i3s.I3SFrameTask")],a);class l{constructor(r,t){this.task=r,this.handle=t}}const c=new Map;function h(r,t){let s=c.get(r);if(null==s){const t=new a,e=r.registerTask(i.I3S_CONTROLLER,t);s=new l(t,e),c.set(r,s)}return s.task.add(t),e(()=>{if(null==s)return;s.task.remove(t);s.task.callbacks.length>0||(c.delete(r),s.handle.remove(),s.task.destroy()),s=null})}export{h as addCallback};
