/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../../../request.js";import{binaryIndexOf as t}from"../../../../core/arrayUtils.js";import r from"../../../../core/Error.js";import has from"../../../../core/has.js";import{invert as o}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as n}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{j as s,t as i,d as a}from"../../../../chunks/vec32.js";import{create as l}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{canProjectWithoutEngine as c}from"../../../../geometry/projectionUtils.js";import u from"../../../../geometry/SpatialReference.js";import{projectVectorToVector as f}from"../../../../geometry/projection/projectVectorToVector.js";import{create as p,empty as m,expandPointInPlace as d,intersects as h}from"../../../../geometry/support/aaBoundingRect.js";import{a as y}from"../../../../chunks/sphere.js";import{fetchFeaturePopupFeatures as g}from"../../../../layers/support/featurePopupQueryUtils.js";import b from"../../../../rest/support/Query.js";import{readBinaryAttribute as w,getCachedAttributeValue as v}from"./I3SBinaryReader.js";import{computeGlobalTransformation as x}from"./I3SProjectionUtil.js";import{createSolidEdgeMaterial as S,createMaterialFromEdges as M}from"../support/edgeUtils.js";import{parseColorMixMode as j}from"../support/symbolColorUtils.js";import{Obb as R,compute as I}from"../../support/orientedBoundingBox.js";import{emissiveStrengthDefault as T}from"../../webgl-engine/core/shaderLibrary/output/Emissions.glsl.js";import{spatialReferenceIncompatibleError as k}from"../../../support/layerViewUtils.js";function U(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function W(e){if(has("disable-feature:i3s-draco")||!e)return!1;for(const t of e)for(const e of t.geometryBuffers)if("draco"===e.compressedAttributes?.encoding)return!0;return!1}function C(e,t,r,o){r.traverse(t,t=>{const r=t.serviceMbsInIndexSR;return 0!==(null!=r&&F(e,r))&&(o(t),!0)})}function A(e,t,r){let o=0,n=0;for(let s=0;s<t.length&&o<e.length;s++)e[o]===t[s]&&(r(s)&&(e[n]=e[o],n++),o++);e.length=n}function K(e,r,o){let n=0,s=0;for(;n<o.length;){t(e,o[n])>=0===r&&(o[s]=o[n],s++),n++}o.length=s}function L(e,t){if(0===t.rotationScale[1]&&0===t.rotationScale[2]&&0===t.rotationScale[3]&&0===t.rotationScale[5]&&0===t.rotationScale[6]&&0===t.rotationScale[7])return q[0]=(e[0]-t.position[0])/t.rotationScale[0],q[1]=(e[1]-t.position[1])/t.rotationScale[4],q[2]=(e[2]-t.position[0])/t.rotationScale[0],q[3]=(e[3]-t.position[1])/t.rotationScale[4],q}const q=p();function F(e,t){const r=t[0],o=t[1],n=t[3],s=e[0]-r,i=r-e[2],a=e[1]-o,l=o-e[3],c=Math.max(s,i,0),u=Math.max(a,l,0),f=c*c+u*u;if(f>n*n)return 0;if(f>0)return 1;return-Math.max(s,i,a,l)>n?3:2}function G(e,t,r){const o=[],n=r?.missingFields,s=r?.originalFields;let i=!1;for(const a of e){const e=t.get(a);e?(s?.push(a),o.push(e.name),a!==e.name&&(i=!0)):n?.push(a)}return r&&"hasMismatchedCasing"in r&&(r.hasMismatchedCasing=i),o}async function P(e,t,o,n,s,i){if(0===t.length)return[];const a=e.attributeStorageInfo;if(null!=e.associatedLayer)try{return await E(e.associatedLayer,t,n,i)}catch(l){if(e.associatedLayer.loaded)throw l}if(a){const r=B(e,t,o,s),l=e.parsedUrl.path;return await Promise.allSettled(r.map(t=>V(l,a,t.node,t.indices,n,e.apiKey,e.customParameters,i).then(e=>{for(let r=0;r<t.graphics.length;r++){const o=t.graphics[r],n=e[r];if(o.attributes)for(const e in o.attributes)e in n||(n[e]=o.attributes[e]);o.attributes=n}}))),t}throw new r("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function B({globalIdField:e},t,r,o){const n=new Map,s=[],i=o();for(const a of t){const t=a.attributes?.[r],o=null==t?a.getGlobalId():void 0;for(let r=0;r<i.length;r++){const l=i[r],c=O(l,t,e,o);if(c<0)continue;let u=n.get(l.node);u||(u={node:l.node,indices:[],graphics:[]},s.push(u),n.set(l.node,u)),u.indices.push(c),u.graphics.push(a);for(let e=r;e>0;e--)i[e]=i[e-1];i[0]=l;break}}return s}function O(e,t,r,o){if(null!=t&&"number"==typeof t)return e.featureIds.indexOf(t);if(null==o||null==r)return-1;const n=e.attributeInfo?.attributeData?.[r];return n?n.indexOf(o):-1}async function E(e,t,r,o){const n=[],s={hasMismatchedCasing:!1,originalFields:n},i=G(r,e.fieldsIndex,s),a=new b({outFields:[...i]});if(await g(e,t,a,{updateSourceAttributes:!0,...o}),!s.hasMismatchedCasing)return t;for(let l=0;l<t.length;l++){const e=t[l];if(e.attributes)for(let t=0;t<n.length;t++){const r=n[t],o=i[t];o in e.attributes&&(e.attributes[r]=e.attributes[o],delete e.attributes[o])}}return t}function V(e,t,r,o,n,s,i,a){return $(e,t,r.resources.attributes,o,n,s,i,a)}async function $(t,r,o,n,s,i,a,l){const c=[];for(const e of r)if(e&&s.includes(e.name)){const r=`${t}/nodes/${o}/attributes/${e.key}/0`;c.push({url:r,storageInfo:e})}const u=await Promise.allSettled(c.map(t=>e(t.url,{responseType:"array-buffer",query:{...a,token:i},signal:l?.signal}).then(e=>w(t.storageInfo,e.data)))),f=[];for(const e of n){const t={};for(let r=0;r<u.length;r++){const o=u[r];if("fulfilled"===o.status){const n=o.value;t[c[r].storageInfo.name]=v(n,e)}}f.push(t)}return f}function z(e){const t=e.store,o=t.indexCRS||t.geographicCRS,n=void 0===o?t.indexWKT:void 0;if(n){if(!e.spatialReference)throw new r("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new r("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const s=o?new u(U(o)):e.spatialReference;return s.equals(e.spatialReference)?e.spatialReference:s}function Q(e){const t=e.store,o=t.vertexCRS||t.projectedCRS,n=void 0===o?t.vertexWKT:void 0;if(n){if(!e.spatialReference)throw new r("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(n!==e.spatialReference.wkt)throw new r("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const s=o?new u(U(o)):e.spatialReference;return s.equals(e.spatialReference)?e.spatialReference:s}function D(e,t,r){if(!c(e,t))throw k("scene layer",e?.wkid,t?.wkid);if("local"===r&&!H(e,t))throw k("scene layer",e?.wkid,t?.wkid)}function Z(e,t,o){if(e.serviceUpdateTimeStamp?.lastUpdate!==t.serviceUpdateTimeStamp?.lastUpdate||!o.isEmpty||e.associatedLayer?.url!==t.associatedLayer?.url)throw new r("layerview:recycle-failed","Could not recycle layerview")}function H(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function J(e,t,r){const o=z(e),n=Q(e);D(o,t,r),D(n,t,r)}function N(e){return(null==e.geometryType||"triangles"===e.geometryType)&&((null==e.topology||"PerAttributeArray"===e.topology)&&null!=e.vertexAttributes?.position)}function X(e){if(null==e.store?.defaultGeometrySchema||!N(e.store.defaultGeometrySchema))throw new r("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function Y(e,t){J(e,t.spatialReference,t.viewingMode)}function _(e){return null!=e.geometryType&&"points"===e.geometryType&&((null==e.topology||"PerAttributeArray"===e.topology)&&((null==e.encoding||""===e.encoding||"lepcc-xyz"===e.encoding)&&null!=e.vertexAttributes?.position))}function ee(e){if(null==e.store?.defaultGeometrySchema||!_(e.store.defaultGeometrySchema))throw new r("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function te(e,t){D(e.spatialReference,t.spatialReference,t.viewingMode)}function re(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}function oe(e){return"mesh-3d"===e.type}function ne(e){if(null==e||!re(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;const t=e.symbols;if(0===t.length)return!0;for(const r of t){if(!oe(r)||0===r.symbolLayers.length)return!0;for(const e of r.symbolLayers.items)if("fill"!==e.type||null==e.material?.color||"replace"!==e.material.colorMixMode)return!0}return!1}const se=S({color:[0,0,0,0],opacity:0});class ie{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function ae(e){const t=new ie;let r=!1,o=!1;for(const n of e.symbolLayers.items)if("fill"===n.type&&n.enabled){const e=n.material,s=n.edges;if(null!=e&&!r){const o=e.color,s=j(e.colorMixMode),i={strength:e.emissive?.strength??T,source:"color"===e.emissive?.source?1:0};t.material=null!=o?{color:[o.r/255,o.g/255,o.b/255],alpha:o.a,colorMixMode:s,emissive:i}:{color:[1,1,1],alpha:1,colorMixMode:1,emissive:i},t.castShadows=n.castShadows,r=!0}null==s||o||(t.edgeMaterial=M(s,{}),o=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:1,emissive:{strength:T,source:0}}),t}function le(e,t){return(0|e)+(0|t)|0}function ce(e,t,r,n,l,c,u){if(!c||0===c.length||null==t||!e.serviceMbsInIndexSR)return null;const p=x(e.serviceMbsInIndexSR,l,"none",r,t);o(be,p);let g=null;const b=()=>{if(!g)if(g=pe,m(de),null!=e.serviceObbInIndexSR){e.serviceObbInIndexSR.transform(he,r,t,l,u),he.getCorners(g);for(const e of g)i(e,e,be),d(de,e)}else{const o=e.serviceMbsInIndexSR;if(!o)return;const n=o[3];f(y(o),r,ye,t),i(ye,ye,be),ye[2]+=l;for(let e=0;e<8;++e){const t=1&e?n:-n,r=2&e?n:-n,o=4&e?n:-n,s=g[e];a(s,[ye[0]+t,ye[1]+r,ye[2]+o]),d(de,s)}}};let w=1/0,v=-1/0;const S=e=>{if("replace"!==e.type)return;const r=e.geometry;if(!r?.hasZ)return;m(me);const o=r.spatialReference||n,a=r.rings.reduce((e,r)=>r.reduce((e,r)=>(s(ye,r[0],r[1],r[2]),f(ye,o,ye,t),i(ye,ye,be),d(me,ye),Math.min(ye[2],e)),e),1/0);b(),h(de,me)&&(w=Math.min(w,a),v=Math.max(v,a))};if(c.forEach(e=>S(e)),w===1/0)return null;const M=(e,t,r)=>{i(ye,r,p),e[t]=ye[0],e[t+1]=ye[1],e[t+2]=ye[2],t+=24,r[2]=w,i(ye,r,p),e[t]=ye[0],e[t+1]=ye[1],e[t+2]=ye[2],t+=24,r[2]=v,i(ye,r,p),e[t]=ye[0],e[t+1]=ye[1],e[t+2]=ye[2]};for(let o=0;o<8;++o)M(ge.data,3*o,g[o]);return I(ge)}function ue(e){return e[3]>=0}function fe(e){null!=e&&(e[3]=-1)}const pe=[l(),l(),l(),l(),l(),l(),l(),l()],me=p(),de=p(),he=new R,ye=l(),ge={data:new Array(72),size:3,exclusive:!0,stride:3},be=n();export{ie as SymbolInfo,le as addWraparound,te as checkPointCloudLayerCompatibleWithView,ee as checkPointCloudLayerValid,Z as checkRecyclable,Y as checkSceneLayerCompatibleWithView,X as checkSceneLayerValid,D as checkSpatialReference,J as checkSpatialReferences,ce as computeVisibilityObb,W as containsDraco,U as extractWkid,A as filterInPlace,G as findFieldsCaseInsensitive,C as findIntersectingNodes,L as getClipRect,z as getIndexCrs,ae as getSymbolInfo,Q as getVertexCrs,F as intersectBoundingRectWithMbs,fe as invalidateMbs,H as isSupportedLocalModeProjection,ue as isValidMbs,K as objectIdFilter,$ as queryAttributesFromCachedAttributesId,ne as rendererNeedsTextures,se as transparentEdgeMaterial,P as whenGraphicAttributes};
