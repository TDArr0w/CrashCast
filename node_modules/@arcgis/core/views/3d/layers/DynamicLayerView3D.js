/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import"../../../core/has.js";import r from"../../../core/Logger.js";import{destroyMaybe as t}from"../../../core/maybe.js";import{debounce as s,isAbortError as i}from"../../../core/promiseUtils.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/RandomLCG.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import n from"./DrapedSubView3D.js";import{LayerView3D as p}from"./LayerView3D.js";import{LayerViewPerformanceInfo as l}from"./support/LayerViewPerformanceInfo.js";import d from"../../layers/LayerView.js";import{RefreshableLayerView as u}from"../../layers/RefreshableLayerView.js";import{isInEffectiveScaleRange as c}from"../../support/layerViewUtils.js";import{projectWithZConversionSilent as h}from"../../support/projectionUtils.js";let m=class extends(u(p(d))){constructor(){super(...arguments),this.fullExtentInLocalViewSpatialReference=null,this.refreshDebounced=s(async e=>{this.destroyed||await this._doRefresh(e).catch(e=>{i(e)||r.getLogger(this).error(e)})},2e3),this.ignoresMemoryFactor=!1,this.unloadedMemory=0}get visibleAtCurrentScale(){const e=this.layer,r="effectiveScaleRange"in e?e.effectiveScaleRange:null;return c(r,this.view.scale)}isUpdating(){return super.isUpdating()||this.subView?.updating}initialize(){this._initSubView(),"local"===this.view.viewingMode&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await h(this.layer.fullExtent,this.view.spatialReference))()),this._updatingHandles.add(()=>this.suspended,()=>this._suspendedChangeHandler())}destroy(){this.subView=t(this.subView)}_initSubView(){this.subView=new n({layerView:this})}async doRefresh(){return this._doRefresh()}async _doRefresh(e){this.suspended||await this.subView.doRefresh(e)}getFetchOptions(){}_suspendedChangeHandler(){this.suspended?this.subView.clear():this.refreshDebounced()}get test(){}get usedMemory(){return this.subView.usedMemory}get performanceInfo(){return new l(this.usedMemory)}};e([o()],m.prototype,"layer",void 0),e([o()],m.prototype,"suspended",void 0),e([o()],m.prototype,"fullExtentInLocalViewSpatialReference",void 0),e([o({readOnly:!0})],m.prototype,"visibleAtCurrentScale",null),e([o()],m.prototype,"updating",void 0),e([o()],m.prototype,"subView",void 0),m=e([a("esri.views.3d.layers.DynamicLayerView3D")],m);export{m as default};
