/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import r from"../../../../../core/Error.js";import{EsriPromise as t}from"../../../../../core/Promise.js";import{property as o}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as n}from"../../../../../core/accessorSupport/decorators/subclass.js";import{WorkerHandle as i}from"../../../../../core/workers/WorkerHandle.js";import a from"../../../../../geometry/Extent.js";import{clone as s}from"../../../../../geometry/support/aaBoundingRect.js";import{isFeatureGraphicOrigin as d}from"../../../../../graphic/isFeatureGraphicOrigin.js";import c from"../../../../../rest/support/AttributeBinsFeatureSet.js";import l from"../../../../../rest/support/FeatureSet.js";import{ElevationContext as u}from"../ElevationContext.js";import{applyElevationAlignment as p}from"./utils.js";let y=class extends t{constructor(e){super(e),this.schedule=null,this._workerUpdating=!0}get updating(){return this._workerUpdating}get _graphicOrigin(){const e=this.layer.graphicOrigin;if(!d(e))throw new r("featurelayerview3d:invalid-graphic-origin","Layer's graphic origin is not a FeatureGraphicOrigin");return e}initialize(){const{layer:e,layerView:r,viewSpatialReference:t,renderSpatialReference:o}=this,n=e.elevationInfo;this._elevationContext=u.fromElevationInfo(n),this._workerHandle=new h(this.schedule,{createTexture:async({data:e,parameters:r})=>({result:await this.renderer.createTexture(e,r),transferList:[]}),releaseTexture:async({uid:e})=>(await this.renderer.releaseTexture(e),w),createMaterial:async({materialJSON:e})=>(await this.renderer.createMaterial(e),w),destroyMaterial:async({materialId:e})=>(await this.renderer.destroyMaterial(e),w),createDirectRenderer:async({materialId:e})=>(await this.renderer.createDirectRenderer(e),w),destroyDirectRenderer:async({materialId:e})=>(await this.renderer.destroyDirectRenderer(e),w),createLoDRenderer:async({rendererId:e,lodRenderGeometry:r},t)=>(await this.renderer.createLoDRenderer(e,r,t?.signal??void 0),w),destroyLoDRenderer:async({rendererId:e},r)=>(await this.renderer.destroyLoDRenderer(e,r?.signal??void 0),w),dispatchRenderCommands:async({commands:e})=>(await this.renderer.executeRenderCommands(e),w),applyElevationAlignment:async({mapPoints:e})=>{const{viewSpatialReference:r,elevationProvider:t,renderCoordsHelper:o}=this,n=p(e,r,this._elevationContext,t,o);return{result:n,transferList:[n.buffer]}},setBaseInstance:async({rendererId:e,baseInstance:r})=>(this.renderer.setBaseInstance(e,r),w)}),this.addResolvingPromise((async()=>{await e.load();const i={url:e.parsedUrl?.path??"",baseQuery:e.createQuery().toJSON(),objectIdField:e.objectIdField,capabilities:e.capabilities,fieldIndex:e.fieldsIndex.toJSON(),timeInfo:e.timeInfo?.toJSON(),elevationInfo:n?.toJSON(),fullExtent:e.fullExtent?.toJSON(),renderer:e.renderer?.toJSON()},a={fullOpacity:r.fullOpacity};await this._workerHandle.invokeMethod("setup",{viewSpatialReference:t.toJSON(),renderSpatialReference:o.toJSON(),viewingMode:this.viewingMode,layerInfo:i,layerViewInfo:a})})()),this.addHandles(this._workerHandle.on("notify-updating",({updating:e})=>{this._workerUpdating=e}))}onTileTreeChange(e){this._workerHandle.invokeMethod("onTileTreeChange",{tiles:e.items.map(m)})}onElevationChange(e){this._workerHandle.invokeMethod("onElevationChange",{context:e.context,spatialReference:e.spatialReference?.toJSON(),extent:s(e.extent)})}onLayerViewOpacityChange(e){this._workerHandle.invokeMethod("onLayerViewOpacityChange",e)}onRendererChange(e){const r=e?.toJSON();this._workerHandle.invokeMethod("onRendererChange",r)}async executeQuery(e,r){const t=await this._workerHandle.invokeMethod("executeQuery",e?.toJSON(),r),o=l.fromJSON(t);return this._ensureLayerOnFeatures(o),o}async executeQueryForIds(e,r){return await this._workerHandle.invokeMethod("executeQueryForIds",e?.toJSON(),r)}async executeQueryForCount(e,r){return await this._workerHandle.invokeMethod("executeQueryForCount",e?.toJSON(),r)}async executeQueryForExtent(e,r){const{count:t,extent:o}=await this._workerHandle.invokeMethod("executeQueryForExtent",e?.toJSON(),r);return{count:t,extent:a.fromJSON(o)}}async executeQueryForLatestObservations(e,r){const t=await this._workerHandle.invokeMethod("executeQueryForLatestObservations",e?.toJSON(),r),o=l.fromJSON(t);return this._ensureLayerOnFeatures(o),o}async executeAttributeBinsQuery(e,r){const t=await this._workerHandle.invokeMethod("executeAttributeBinsQuery",e.toJSON(),r);return c.fromJSON(t)}_ensureLayerOnFeatures(e){const{layer:r,_graphicOrigin:t}=this;for(const o of e.features)o.layer=r,o.sourceLayer=r,o.origin=t}};e([o()],y.prototype,"updating",null),e([o({constructOnly:!0})],y.prototype,"schedule",void 0),e([o({constructOnly:!0})],y.prototype,"layer",void 0),e([o({constructOnly:!0})],y.prototype,"layerView",void 0),e([o({constructOnly:!0})],y.prototype,"viewSpatialReference",void 0),e([o({constructOnly:!0})],y.prototype,"renderSpatialReference",void 0),e([o({constructOnly:!0})],y.prototype,"viewingMode",void 0),e([o({constructOnly:!0})],y.prototype,"renderer",void 0),e([o({constructOnly:!0})],y.prototype,"elevationProvider",void 0),e([o({constructOnly:!0})],y.prototype,"renderCoordsHelper",void 0),e([o()],y.prototype,"_workerUpdating",void 0),e([o()],y.prototype,"_graphicOrigin",null),y=e([n("esri.views.3d.layers.graphics.pipeline.Feature3DPipelineWorkerHandle")],y);class h extends i{constructor(e,r){super("Feature3DPipelineWorker","setup",{},e,{strategy:"dedicated",client:r})}}function m({id:e,lij:r,extent:t}){return{id:e,lij:r,extent:t}}const w={result:void 0};export{y as Feature3DPipelineWorkerHandle};
