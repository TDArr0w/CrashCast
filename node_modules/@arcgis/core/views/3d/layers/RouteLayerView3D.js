/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import r from"../../../core/Collection.js";import t from"../../../core/CollectionFlattener.js";import{destroyMaybe as o}from"../../../core/maybe.js";import{initial as s,when as i,watch as a}from"../../../core/reactiveUtils.js";import{property as n}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as p}from"../../../core/accessorSupport/decorators/subclass.js";import l from"../../../rest/support/DirectionLine.js";import c from"../../../rest/support/DirectionPoint.js";import h from"../../../rest/support/PointBarrier.js";import u from"../../../rest/support/PolygonBarrier.js";import d from"../../../rest/support/PolylineBarrier.js";import m from"../../../rest/support/RouteInfo.js";import y from"../../../rest/support/Stop.js";import{LayerView3D as g}from"./LayerView3D.js";import{GraphicsProcessor as f}from"./graphics/GraphicsProcessor.js";import{LayerViewPerformanceInfo as w}from"./support/LayerViewPerformanceInfo.js";import{EventedSet as v}from"../support/EventedSet.js";import _ from"../../layers/LayerView.js";import{getHighlightName as j}from"../../support/highlightOptionsUtils.js";import{isInEffectiveScaleRange as b,hasLayerBasedScaleVisibility as G}from"../../support/layerViewUtils.js";import{projectWithZConversionSilent as S}from"../../support/projectionUtils.js";function V(e){return e instanceof l||e instanceof c||e instanceof h||e instanceof u||e instanceof d||e instanceof m||e instanceof y}let C=class extends(g(_)){constructor(){super(...arguments),this.type="route-3d",this.loadedGraphics=new v,this._networkFeatureToGraphic=new Map,this._graphicToNetworkFeature=new Map,this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null}initialize(){this._set("processor",new f({owner:this,scaleVisibilityEnabled:!0,frustumVisibilityEnabled:!0})),this.addResolvingPromise(this.processor.initializePromise),this._updatingHandles.addOnCollectionChange(()=>this._routeItems,e=>this._routeItemsChanged(e),s),"local"===this.view.viewingMode&&this.addResolvingPromise((async()=>this.fullExtentInLocalViewSpatialReference=await S(this.layer.fullExtent,this.view.spatialReference))()),this.addHandles(i(()=>this.view?.basemapTerrain?.ready,()=>()=>this.notifyChange("updating"),{once:!0}))}destroy(){this._updatingHandles.removeAll(),this._networkFeatureToGraphic.clear(),this._graphicToNetworkFeature.clear(),this._set("processor",o(this.processor)),this._get("_routeItems")?.destroy()}get _routeItems(){return new t({getCollections:()=>[this.layer.pointBarriers,this.layer.polygonBarriers,this.layer.polylineBarriers,this.layer.stops,this.layer.directionLines,this.layer.directionPoints,null!=this.layer.routeInfo?new r([this.layer.routeInfo]):null]})}_routeItemsChanged(e){if(e.removed.length){this.loadedGraphics.removeMany(e.removed.map(e=>{const r=this._networkFeatureToGraphic.get(e);return this._networkFeatureToGraphic.delete(e),this._graphicToNetworkFeature.delete(r),r}));for(const r of e.removed)this.removeHandles(r)}if(e.added.length){this.loadedGraphics.addMany(e.added.map(e=>{const r=e.toGraphic();return this._networkFeatureToGraphic.set(e,r),this._graphicToNetworkFeature.set(r,e),r}));for(const r of e.added)this.addHandles([a(()=>r.geometry,(e,t)=>{this._updateGraphic(r,"geometry",e,t)}),a(()=>r.symbol,(e,t)=>{this._updateGraphic(r,"symbol",e,t)})],r)}}get legendEnabled(){return this.canResume()&&!this.processor?.frustumVisibilitySuspended}get visibleAtCurrentScale(){return G()?b(this.layer.effectiveScaleRange,this.view.scale):!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const e=super.getSuspendInfo();return e.outsideOfView=this.processor?.frustumVisibilitySuspended??!1,e}getHit(e){const r=this.processor.getHit(e,null);if("graphic"===r?.type){const e=this._graphicToNetworkFeature.get(r.graphic);if(e)return{type:"route",layer:this.layer,networkFeature:e}}return null}whenGraphicBounds(e,r){return this.processor.whenGraphicBounds(e,r)}computeAttachmentOrigin(e,r){return this.processor?.computeAttachmentOrigin(e,r)}getSymbolLayerSize(e,r){return this.processor.getSymbolLayerSize(e,r)}async queryGraphics(){return new r(this.loadedGraphics.toArray())}maskOccludee(e){return this.processor.maskOccludee(e)}highlight(e,r){return V(e)&&(e=this._networkFeatureToGraphic.get(e)),this.processor.highlight(e,j(r))}notifyContentGeometryUpdate(){this.emit("visible-geometry-changed")}get updatePolicy(){return this.processor?.graphicsCore.effectiveUpdatePolicy||1}isUpdating(){return!(!this.processor?.updating&&this.view?.basemapTerrain?.ready)}get performanceInfo(){return new w(this.processor?.graphicsCore.usedMemory??0,this.loadedGraphics.length,-1,-1,0,this.processor?.graphicsCore.performanceInfo??null)}_updateGraphic(e,r,t,o){const s=this._networkFeatureToGraphic.get(e);s[r]=t,I.graphic=s,I.property=r,I.oldValue=o,I.newValue=t,this.processor?.graphicsCore.graphicUpdateHandler(I),I.graphic=null}};e([n()],C.prototype,"_routeItems",null),e([n()],C.prototype,"loadedGraphics",void 0),e([n({readOnly:!0})],C.prototype,"legendEnabled",null),e([n({readOnly:!0})],C.prototype,"visibleAtCurrentScale",null),e([n()],C.prototype,"layer",void 0),e([n({readOnly:!0})],C.prototype,"processor",void 0),e([n({type:Boolean})],C.prototype,"slicePlaneEnabled",void 0),C=e([p("esri.views.3d.layers.RouteLayerView3D")],C);const I={graphic:null,property:null,oldValue:null,newValue:null},k=C;export{k as default};
