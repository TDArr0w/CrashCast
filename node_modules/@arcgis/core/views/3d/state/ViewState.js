/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import t from"../../../core/Accessor.js";import{EventEmitter as r}from"../../../core/Evented.js";import{destroyMaybe as o}from"../../../core/maybe.js";import{when as a}from"../../../core/reactiveUtils.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as s}from"../../../core/accessorSupport/decorators/subclass.js";import{afterDispatch as n}from"../../../core/accessorSupport/watch.js";import{fromValues as l}from"../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{getReferenceEllipsoid as p}from"../../../geometry/ellipsoidUtils.js";import c from"../../ViewAnimation.js";import{viewingModeFromString as m}from"../../ViewingMode.js";import{Constraints as h}from"./Constraints.js";import{AnimationController as d}from"./controllers/AnimationController.js";import u from"../webgl/RenderCamera.js";import{DepthRange as g}from"../webgl-engine/lib/DepthRange.js";import{maximumHighlights as y}from"../../support/HighlightDefaults.js";import{PropertiesPool as C}from"../../support/PropertiesPool.js";let f=class extends t{constructor(e){super(e),this._propertiesPool=new C({camera:()=>new u},this),this._lastSeenCameraProjectionValues=new u,this.mode=0,this._cssCamera=new u,this._camera=new u,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.constraints=new h({state:this}),this.events=new r,this.fading=!1,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}reset(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new C({camera:()=>new u},this)}destroy(){this.cameraController=o(this.cameraController),this._propertiesPool=o(this._propertiesPool)}createInitialCamera(){if(1===this.viewingMode){const e=p(this.spatialReference).radius;this.camera=new u({eye:l(4*e,0,0),center:l(e,0,0),up:l(0,0,1)})}else this.camera=new u({eye:l(0,0,100),center:l(0,0,0),up:l(0,1,0)})}get animation(){return this.cameraController instanceof d&&null!=this.cameraController.viewAnimation?this.cameraController.viewAnimation:null}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:t,width:r,pixelRatio:o}=this.camera;return e.pixelRatio=1,e.height=Math.round(t/o),e.width=Math.round(r/o),e}get camera(){return this._camera}set camera(e){e!==_&&_.copyFrom(e),_.computeUp(this.viewingMode),this.events.emit("before-camera-change",{camera:_});const t=this._camera;if(v(this._lastSeenCameraProjectionValues,_)&&(this._lastSeenCameraProjectionValues.copyFrom(_),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!t.equals(_)&&(this._camera=this._propertiesPool.get("camera").copyFrom(_),this._cameraChanged=!t.almostEquals(_),this._cameraChanged)){const e=n(()=>{this._cameraChanged=!1,e.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&2===this.mode}get updating(){return 2!==this.mode}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){if(null==e)return void(this._contentCamera=null);const t=e.clone();this.events.emit("before-camera-change",{camera:t,sceneDepthRange:g.Infinite}),this._contentCamera=t}get fixedContentCamera(){return null!=this._contentCamera}get isGlobal(){return 1===this.viewingMode}get isLocal(){return 2===this.viewingMode}get viewingMode(){return m(this.view.viewingMode)}get spatialReference(){return this.view.spatialReference}get highlights(){const e=this.view.highlights.items.slice(0,y);for(let t=0;t<e.length;){const r=e[t],o=e.findIndex(e=>e.name===r.name);o>=0&&t>o?e.splice(t,1):++t}return e}get highlightOrderMap(){const e=new Map;return this.highlights.forEach((t,r)=>e.set(t.name,r)),e}get navigating(){return!!this.cameraController?.isInteractive}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.removeHandles(j),this.cameraController?.destroy(),e&&(this.addHandles(a(()=>4===e.state||3===e.state,()=>{this.updateCamera(t=>e.onControllerEnd(t)),this.cameraController===e&&(this._set("cameraController",null),e.destroy())},{sync:!0,once:!0}),j),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=1)}switchCameraController(e){this.cameraController=e}stopActiveCameraController(){return!this.cameraController||this.cameraController.stopController()}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(0===this._updateQueue.length||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();_.copyFrom(this.camera),e(_),this.camera=_,this._processingUpdates=!1,this._processUpdateQueue()}static cleanupViewstate(){_=new u}};e([i({constructOnly:!0})],f.prototype,"view",void 0),e([i()],f.prototype,"mode",void 0),e([i({readOnly:!0,type:c})],f.prototype,"animation",null),e([i({type:u})],f.prototype,"cssCamera",null),e([i()],f.prototype,"_cssCamera",void 0),e([i({type:u})],f.prototype,"camera",null),e([i()],f.prototype,"_camera",void 0),e([i({readOnly:!0})],f.prototype,"pixelRatio",null),e([i()],f.prototype,"rasterPixelRatio",void 0),e([i()],f.prototype,"contentPixelRatio",void 0),e([i({readOnly:!0})],f.prototype,"alignPixelEnabled",null),e([i({readOnly:!0})],f.prototype,"updating",null),e([i({})],f.prototype,"_contentCamera",void 0),e([i({type:u})],f.prototype,"contentCamera",null),e([i({readOnly:!0})],f.prototype,"fixedContentCamera",null),e([i({readOnly:!0})],f.prototype,"events",void 0),e([i({readOnly:!0})],f.prototype,"isGlobal",null),e([i({readOnly:!0})],f.prototype,"isLocal",null),e([i({readOnly:!0})],f.prototype,"viewingMode",null),e([i({readOnly:!0})],f.prototype,"highlights",null),e([i({readOnly:!0})],f.prototype,"highlightOrderMap",null),e([i({readOnly:!0})],f.prototype,"navigating",null),e([i()],f.prototype,"fading",void 0),e([i({readOnly:!0})],f.prototype,"stationary",null),e([i()],f.prototype,"_cameraChanged",void 0),e([i()],f.prototype,"cameraController",null),f=e([s("esri.views.3d.state.ViewState")],f);const w=f;function v(e,t){return e.fov!==t.fov||(e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||(e.padding[0]!==t.padding[0]||e.padding[1]!==t.padding[1]||e.padding[2]!==t.padding[2]||e.padding[3]!==t.padding[3]))}let _=new u;const j="ViewStateHandles";export{w as default};
