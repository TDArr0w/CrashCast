/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as i}from"tslib";import e from"../../../../Color.js";import"../../../../intl.js";import s from"../../../../core/Accessor.js";import{destroyHandle as t}from"../../../../core/handleUtils.js";import"../../../../core/has.js";import{mapCollection as a}from"../../../../core/mapCollectionUtils.js";import{watch as o,syncAndInitial as r,when as n,sync as l}from"../../../../core/reactiveUtils.js";import{pt2px as m}from"../../../../core/screenUtils.js";import{property as c}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/Logger.js";import"../../../../core/RandomLCG.js";import{subclass as h}from"../../../../core/accessorSupport/decorators/subclass.js";import{ZEROS as d}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{LengthDimensionVisualization as p}from"./LengthDimensionVisualization.js";import{markerLineSizeFraction as f,offsetLineSizeFraction as u}from"./settings.js";import{LineMarkerMaterial as g}from"../../webgl-engine/materials/LineMarkerMaterial.js";import{createStipplePatternSimple as M}from"../../webgl-engine/materials/lineStippleUtils.js";import{RibbonLineMaterial as _}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{onLocaleChange as y}from"../../../../intl/locale.js";import{fetchMessageBundle as w}from"../../../../intl/messages.js";let v=class extends s{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(i){super(i),this.loadingMessages=!1,this._messages=null}initialize(){const i=this.isDecoration;this._markerMaterial=new g({width:1,anchor:1,color:d,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:4,markerPrimitive:"triangle",isDecoration:i},this.view.state.isGlobal),this._dimensionLineMaterial=new _({width:1,color:d,renderOccluded:4,markerParameters:this._markerMaterial.parameters,isDecoration:i},this.view.state.isGlobal),this._offsetLineMaterial=new _({width:1,color:d,renderOccluded:4,stipplePattern:M(5),isDecoration:i},this.view.state.isGlobal),this._smallDimensionLineMaterial=new _({width:1,color:d,renderOccluded:4,isDecoration:i},this.view.state.isGlobal),this._smallOffsetLineMaterial=new _({width:1,color:d,renderOccluded:4,stipplePattern:M(5),isDecoration:i},this.view.state.isGlobal);const s=a(()=>this.analysisViewData.computations,({computation:i})=>this._createVisualization(i));this._dimensionVisualizations=s,this.addHandles([t(s),o(()=>e.toUnitRGBA(this.analysis.style.color),i=>{for(const e of this._lineMaterials())e.setParameters({color:i})},r),o(()=>this.analysis.style.lineSize,i=>{const e=m(i);this._markerMaterial.setParameters({width:e*f}),this._dimensionLineMaterial.setParameters({width:e,markerParameters:this._markerMaterial.parameters});const s=Math.max(e*u,1);this._offsetLineMaterial.setParameters({width:s})},r),o(()=>({camera:this.view.state.camera,style:L(this.analysis)}),({camera:i,style:e})=>{for(const{visualization:s}of this._dimensionVisualizations)s.updateCameraDependentElements(i,s.computation.geometry,e),s.updateLabelStyle(e)}),o(()=>this.visible,i=>{for(const{visualization:e}of this._dimensionVisualizations)e.visible=i})]),this.addHandles([y(()=>this._updateMessageBundle()),n(()=>!this.loadingMessages,()=>{for(const{visualization:i}of this._dimensionVisualizations)i.updateUnitsMessages(this._messages)},l)]),this._updateMessageBundle()}get testInfo(){}_createVisualization(i){const e=new p({analysis:this.analysis,computation:i,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await w("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function L(i){const{fontSize:e,lineSize:s,textColor:t,textBackgroundColor:a}=i.style;return{fontSize:e,lineSize:s,textBackgroundColor:a.clone(),textColor:t.clone()}}i([c({constructOnly:!0})],v.prototype,"analysisViewData",void 0),i([c({constructOnly:!0,nonNullable:!0})],v.prototype,"view",void 0),i([c({constructOnly:!0})],v.prototype,"isDecoration",void 0),i([c()],v.prototype,"analysis",null),i([c()],v.prototype,"visible",null),i([c()],v.prototype,"loadingMessages",void 0),v=i([h("esri.views.3d.analysis.Dimension.DimensionVisualization")],v);export{v as DimensionVisualization};
