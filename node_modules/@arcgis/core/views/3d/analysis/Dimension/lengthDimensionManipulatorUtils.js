/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import{lengthDimensionMeasureType as t}from"../../../../analysis/dimensionUtils.js";import{cyclicalDegrees as r}from"../../../../core/Cyclical.js";import{rad2deg as n}from"../../../../core/mathUtils.js";import{watch as i,initial as o}from"../../../../core/reactiveUtils.js";import{pt2px as a}from"../../../../core/screenUtils.js";import{identity as s,scale as c}from"../../../../core/libs/gl-matrix-2/math/mat4.js";import{create as l}from"../../../../core/libs/gl-matrix-2/factories/mat4f64.js";import{h as m,d,q as u,b as p,j as f,a as h,e as g,i as v,f as y}from"../../../../chunks/vec32.js";import{fromValues as w,create as S,ZEROS as j}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{create as x}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import b from"../../../../geometry/Point.js";import{fromPositionAndNormal as H,create as M,signedDistance as P,getNormal as C}from"../../../../geometry/support/plane.js";import{sv3d as T}from"../../../../geometry/support/vectorStacks.js";import{clonePoint as R}from"../../../../layers/graphics/hydratedFeatures.js";import{isValidComputation as z,computeOffsetForPoint as O,computeSegmentForMeasureType as U,computeOffsetAxis as _,dimensionStartToEnd as A,headingFromGeometry as L,computeGeometryFromDimension as k,computationToGeometryDependencies as E,directUp as D,directStartToEnd as G}from"./lengthDimensionUtils.js";import{getTransparentAccentColor as F,pointRadius as B,lengthFraction as W,minLengthMeters as I,linePaddingPx as q,focusedLinePaddingPx as N,orientationFocusMultiplier as J,orientationDiscScale as K,orientationCalloutWidth as Q,markerLineSizeFraction as V,orientationCalloutOffsetPx as X,orientationSnapThresholdDegrees as Y}from"./settings.js";import{Manipulator3D as Z}from"../../interactive/Manipulator3D.js";import{createManipulatorMaterial as $,worldScaledManipulatorSettings as ee,calculateTranslateRotateFromBases as te,rotateManipulatorDefaults as re,calculateInputRotationTransform as ne}from"../../interactive/manipulatorUtils.js";import{RenderObject as ie}from"../../interactive/RenderObject.js";import{hideManipulatorWhileDragging as oe,screenToMap3D as ae,screenToRenderPlane as se}from"../../interactive/editingTools/dragEventPipeline3D.js";import{EuclideanSegment as ce}from"../../interactive/visualElements/support/Segment.js";import{markerSizePerLineWidth as le}from"../../support/engineContent/marker.js";import{Attribute as me}from"../../webgl-engine/lib/Attribute.js";import{Geometry as de}from"../../webgl-engine/lib/Geometry.js";import{createSphereGeometry as ue,createPolylineGeometry as pe}from"../../webgl-engine/lib/GeometryUtil.js";import{RibbonLineMaterial as fe}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createManipulatorDragEventPipeline as he,resetProperties as ge,EventPipeline as ve}from"../../../interactive/dragEventPipeline.js";class ye{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const r of t)e(this.manipulatorForMeasureType(r),r)}manipulatorForMeasureType(e){switch(e){case"direct":return this.direct;case"horizontal":return this.horizontal;case"vertical":return this.vertical}}}class we extends Z{constructor(t,r){const n=$(e.toUnitRGBA(F(t.effectiveTheme))),o=[new ie(ue(n,1,32,32),Ve)];super({view:t,renderObjects:o,metadata:r.metadata,available:!1,grabCursor:"crosshair",radius:B,collisionPriority:1}),this._themeHandle=i(()=>({color:e.toUnitRGBA(F(t.effectiveTheme))}),e=>n.setParameters(e))}destroy(){this._themeHandle.remove(),super.destroy()}}function Se(e,t){const r=[w(-.5,0,0),w(.5,0,0)],n=pe(t.unfocusedMaterial,r.map(e=>m(S(),e,W))),i=n.instantiate({material:t.focusedMaterial});return new Z({view:e,renderObjects:[new ie(n,9|Ve),new ie(i,2|Ve)],collisionType:{type:"line",paths:[r]},radius:Ke(t.lineSizePt)/2,metadata:t.metadata,available:!1,...ee})}class je extends Z{constructor(t,{lineSizePt:r,material:n,metadata:a}){super({view:t,autoScaleRenderObjects:!1,collisionPriority:1,metadata:a}),this._options={calloutColor:x(),lineSizePt:r,material:n},this._themeHandle=i(()=>e.toUnitRGBA(F(t.effectiveTheme)),e=>{this._options.calloutColor=e,Qe(this,xe({...this._options,metadata:this.metadata}))},o)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,Qe(this,xe({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function xe({calloutColor:e,lineSizePt:t,material:r,metadata:n}){return{calloutLength:.25*le*V*a(t)+X,calloutColor:e,calloutWidth:Q,customStateMask:Ve,discScale:K,focusMultiplier:J,material:r,metadata:n}}function be(e,t){const r=[w(-.5,0,0),w(.5,0,0)],n=pe(t.thinOffsetManipulatorMaterial,r),i=pe(t.unfocusedMaterial,r.map(e=>m(S(),e,W))),o=i.instantiate({material:t.focusedMaterial});return new Z({view:e,renderObjects:[new ie(i,1|Ve),new ie(o,2|Ve),new ie(n,Ve)],collisionType:{type:"line",paths:[r]},radius:Ke(t.lineSizePt)/2,available:!1,metadata:t.metadata,...ee})}function He(e,{isStart:t,createSnappingPipelineStep:r,dimension:n,onUpdate:i,view:o}){const a=t?"startPoint":"endPoint",s=he(e,(e,t,s,c)=>{const l=oe(e),{snappingStep:m,cancelSnapping:d}=r(c);s=s.next(l).next(ge(n,[a,"measureType","orientation"])).next(d),t.next(l).next(ae(o)).next(...m).next(e=>{const t=R(e.mapEnd,new b);i("startPoint"===a?{startPoint:t}:{endPoint:t})})});return[s]}function Me(e,{computation:t,view:r}){return[he(e,(e,n,i)=>{if(!z(t)||!e.selected)return;const{geometry:o,dimension:a}=t,s=oe(e);n.next(s).next(Ue(r,a,o.dimensionSegment,o.primaryOffsetAxis)),i.next(s).next(ge(a,["offset"]))})]}function Pe(e,{computation:t,view:r}){return[he(e,(e,n,i)=>{Re({cancel:i,computation:t,settingHeading:!0,steps:n,view:r})})]}function Ce(e,{computation:t,view:r}){return[he(e,(e,n,i)=>{Re({cancel:i,computation:t,settingHeading:!1,steps:n,view:r})}),e.events.on("immediate-click",e=>{Te(e,t,r)})]}function Te(e,t,n){const{dimension:i,geometry:o}=t;if(90===i.orientation||270===i.orientation)return i.orientation=0,void e.stopPropagation();if(null==o)return;const{renderCoordsHelper:a}=n,s=k({...E(t),orientation:90},a),c=k({...E(t),orientation:270},a);if(null==s||null==c)return;const l=L(s,a),m=L(c,a),d=_e(o,n),u=r.shortestSignedDiff(d,l),p=r.shortestSignedDiff(d,m);i.orientation=Math.abs(u)<Math.abs(p)?90:270,e.stopPropagation()}function Re(e){const{cancel:t,computation:r,settingHeading:i,steps:o,view:a}=e;if(!z(r))return;const{renderCoordsHelper:s}=a,{dimension:c,geometry:l}=r,m=S(),u=Be(S(),l,l.directSegment,s),p=We(T.get(),{forHeading:i,geometry:l,renderCoordsHelper:s}),f=H(u,p,M()),h=i?c.orientation??L(l,a.renderCoordsHelper):c.orientation??0;o.next(se(a,f)).next(e=>{"start"===e.action&&d(m,e.renderStart);const t=C(f),r=ne(m,e.renderEnd,u,t);let o=h-n(r);i||(o=ze(o)),c.orientation=o}),t.next(ge(c,["orientation"]))}function ze(e){const t=r.normalize(e)%90;return t<Y?e-t:90-t<Y?e+(90-t):e}function Oe(e,{computation:t,manipulatorMeasureType:r,view:n}){let i="direct",o=0,a=0;return[e.events.on("grab-changed",s=>{if("start"!==s.action||!z(t))return;const{dimension:c,geometry:l}=t;i=c.measureType,o=c.offset,a=c.orientation;const m=d(T.get(),e.renderLocation);c.measureType=r,c.offset=O(m,r,l,n.renderCoordsHelper),c.orientation=0}),he(e,(e,s,c)=>{if(!z(t))return;const{geometry:l,dimension:m}=t,{renderCoordsHelper:d}=n,u=U($e,r,t,d),p=_(T.get(),{measureType:r,directSegment:l.directSegment,renderCoordsHelper:d}),f=oe(e);s.next(f).next(Ue(n,m,u,p)),c.next(f).next(e=>(m.measureType=i,m.offset=o,m.orientation=a,e))})]}function Ue(e,t,r,n){const i=g(T.get(),r.endRenderSpace,r.startRenderSpace);v(i,i,n);const o=H(r.startRenderSpace,i,M()),a=H(r.startRenderSpace,n,M()),s=t.offset;let c,l=0;const m=new ve;return m.next(se(e,o)).next(r=>{"start"===r.action&&(l=P(a,r.renderStart));const n=(P(a,r.renderEnd)-l)*e.renderCoordsHelper.unitInMeters;t.offset=s+n,c=r}),e=>(m.execute(e),c)}function _e(e,t){const{directSegment:r}=e,{renderCoordsHelper:n}=t,i=D(T.get(),e,n),o=G(T.get(),e),a=v(T.get(),o,i),{viewForward:s}=t.state.camera;y(a,s)>0&&m(a,a,-1);const c=r.eval(.5,T.get());return n.headingAtPosition(c,a)}function Ae(e,t,r){const{dimensionSegment:n,primaryOffsetAxis:i}=t,o=A(Xe,t),a=u(o,j)?s(Ze):te(o,i,j,Ze),l=Math.max(p(o),I/r.unitInMeters);c(a,a,f(Xe,l,l,l)),e.modelTransform=a,e.renderLocation=n.eval(.5,Xe)}function Le(e,t,r){Ee(e,t,r,{forHeading:!0})}function ke(e,t,r){Ee(e,t,r,{forHeading:!1})}function Ee(e,t,r,{forHeading:n}){const{dimension:i,geometry:o}=t,{primaryOffsetAxis:a}=o,s=m(De,a,i.offset>=0?1:-1),c=We(Ge,{forHeading:n,geometry:o,renderCoordsHelper:r});v(c,c,s);const l=te(s,c,j,Ze);e.modelTransform=l,e.renderLocation=Be(Xe,o,o.dimensionSegment,r)}const De=S(),Ge=S();function Fe(e,t,r,n){const{geometry:i}=t,o=U($e,r,t,n),a=_(Xe,{measureType:r,directSegment:i.directSegment,renderCoordsHelper:n}),s=h(Ye,o.endRenderSpace,o.startRenderSpace),l=te(s,a,j,Ze),m=p(s);c(l,l,f(Ye,m,m,m)),e.modelTransform=l,e.renderLocation=o.eval(.5,Ye)}function Be(e,t,r,n){const{startRenderSpace:i,endRenderSpace:o}=r,a=Ie(t,n)?i:o;return d(e,a)}function We(e,{forHeading:t,geometry:r,renderCoordsHelper:n}){return t?D(e,r,n):A(e,r,{invert:!0})}function Ie(e,t){const r=G(qe,e),n=D(Ne,e,t);return y(r,n)>0}const qe=S(),Ne=S();function Je(e){return a(e)+q}function Ke(e){return a(e)+N}function Qe(e,t){const r=t.material,n=t.focusMultiplier??re.focusMultiplier,i=t.calloutLength??re.calloutLength,o=re.discRadius*(t.discScale??1),a=o*n,s=(e,t)=>{const r=[0,1,2,2,3,0];return new de(t,[["position",new me([i-e,-e,0,i+e,-e,0,i+e,e,0,i-e,e,0],r,3,!0)],["uv0",new me([0,0,1,0,1,1,0,1],r,2,!0)]])},c=t.calloutWidth??re.calloutWidth,l=new fe({width:c,color:t.calloutColor,renderOccluded:4,isDecoration:!0},e.view.state.isGlobal),m=pe(l,[[0,0,0],[i-o,0,0]]),d=pe(l,[[0,0,0],[i-a,0,0]]),u=t.customStateMask??0;e.collisionType={type:"disc",direction:[0,0,1],offset:[i,0,0]},e.focusMultiplier=n,e.metadata=t.metadata,e.radius=o,e.renderObjects=[new ie(s(o,r),1|u),new ie(m,1|u),new ie(s(a,r),2|u),new ie(d,2|u)]}const Ve=16,Xe=S(),Ye=S(),Ze=l(),$e=new ce;export{Ve as DidPointerMoveRecentlyFlag,ye as LengthDimensionManipulators,we as LengthDimensionPointManipulator,je as LineOfSightOrientationManipulator,_e as automaticHeadingFromCamera,be as createMeasureTypeManipulator,Se as createOffsetManipulator,Ke as focusedOffsetWidth,Pe as headingManipulatorHandles,Oe as measureTypeManipulatorHandles,Me as offsetManipulatorHandles,He as pointManipulatorHandles,Ce as rotationManipulatorHandles,ze as snapOrientationToNearestRightAngle,Je as unfocusedOffsetWidth,Le as updateHeadingManipulatorTransform,Fe as updateMeasureTypeManipulatorTransform,Ae as updateOffsetManipulatorTransform,ke as updateRotationManipulatorTransform};
