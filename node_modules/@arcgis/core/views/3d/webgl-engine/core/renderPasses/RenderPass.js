/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../../../../core/PooledArray.js";import{DataType as t}from"../../../../webgl/enums.js";class r{constructor(t,r,i=0){this._rctx=t,this._techniques=r,this._sorting=i,this._draws=new e({allocator:e=>e??{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,t,r,i,s){const n=this._draws.pushNew();n.geometry=t,n.geometryRanges=r,n.material=e,n.depthSquaredHint=i,n.indexType=(t.indexed?t.vao.indexBuffer.indexType:null)??0,n.highlightName=s}acquire(e,t){return this._draws.map(r=>r.material.acquireTechnique(this._techniques,e,t,r.geometry.parameters))}dispatch(e,t,r){const s=this._rctx;this._previouslyBoundDraw.clear();let n=null;const a=this._draws.length,o=t.highlight?.name;for(let h=0;h<a;h++){const a=this._draws.data[h];if(2===e.identifier){const e=a.highlightName;if(e){if(e!==o)continue}else if(!o||!t.overlay?.hasHighlight(o))continue}const l=r[h];l===n&&0===t.oitPass||(s.bindTechnique(l,t,e),n=l);const{geometryRanges:d,indexType:u,geometry:m,material:c}=a;s.bindVAO(m.vao),this._previouslyBoundDraw.get(l)!==c&&(l.program.bindDraw(t,e,c),this._previouslyBoundDraw.set(l,c));const g=d.length,{primitiveType:p}=m;for(let e=0;e<g;e+=2){const t=d[e],r=d[e+1];if(0!==u){const e=i.get(u);s.drawElements(p,r,u,t*e)}else s.drawArrays(p,t,r)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=0===this._sorting?1:-1;this._draws.sort((t,r)=>e*(t.depthSquaredHint-r.depthSquaredHint)||t.geometry.vao.usedMemory-r.geometry.vao.usedMemory)}get count(){return this._draws.length}}const i=new Map;i.set(t.UNSIGNED_BYTE,1),i.set(t.UNSIGNED_SHORT,2),i.set(t.UNSIGNED_INT,4);export{r as RenderPass};
