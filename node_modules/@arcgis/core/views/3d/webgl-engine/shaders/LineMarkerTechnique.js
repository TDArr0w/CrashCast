/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{newLayout as e}from"../../support/buffer/InterleavedLayout.js";import{isColorOrColorEmission as t}from"../core/shaderLibrary/ShaderOutput.js";import{ReloadableShaderModule as i}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as r,depthOnlyOutputBuffersOr as l}from"../core/shaderTechnique/ShaderTechnique.js";import{depthWrite as n,oitDepthTest as s,blending as o,getDrawBuffers as c}from"../lib/OrderIndependentTransparency.js";import{stencilToolMaskBaseParams as u,stencilBaseAllZerosParams as p,stencilWriteMaskOn as a,stencilToolTransparentOccluderParams as d,depthCompareAlways as h,stencilToolMaskOccluderParams as f,stencilWriteMaskOff as m,depthCompareLess as P}from"../lib/StencilUtils.js";import{L as T}from"../../../../chunks/LineMarker.glsl.js";import{makePipelineState as W,defaultColorWrite as _,unpremultipliedAlphaToPremultipliedAlpha as b}from"../../../webgl/renderState.js";class g extends r{constructor(e,t){super(e,t,new i(T,()=>import("./LineMarker.glsl.js")),S(t).locations)}_makePipelineState(e,i){const{output:r,oitPass:d,space:h,hasOccludees:f}=e;return W({blending:t(r)?o(d):null,depthTest:0===h?null:{func:s(d)},depthWrite:n(e),drawBuffers:l(r,c(d,r)),colorWrite:_,stencilWrite:f?a:null,stencilTest:f?i?u:p:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(e){return e.occluder?(this._occluderPipelineTransparent=W({blending:b,depthTest:h,depthWrite:null,colorWrite:_,stencilWrite:null,stencilTest:d}),this._occluderPipelineOpaque=W({blending:b,depthTest:h,depthWrite:null,colorWrite:_,stencilWrite:m,stencilTest:f}),this._occluderPipelineMaskWrite=W({blending:null,depthTest:P,depthWrite:null,colorWrite:null,stencilWrite:a,stencilTest:u})):this._occluderPipelineTransparent=this._occluderPipelineOpaque=this._occluderPipelineMaskWrite=null,this._occludeePipelineState=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){return e?this._occludeePipelineState:11===t?this._occluderPipelineTransparent??super.getPipeline():10===t?this._occluderPipelineOpaque??super.getPipeline():this._occluderPipelineMaskWrite??super.getPipeline()}}function S(t){const i=e().vec3f("position").vec4f16("previousDelta").vec2f16("uv0");return t.hasVVColor?i.f32("colorFeatureAttribute"):i.vec4u8("color",{glNormalized:!0}),t.hasVVOpacity&&i.f32("opacityFeatureAttribute"),t.hasVVSize?i.f32("sizeFeatureAttribute"):i.f16("size"),t.worldSpace&&i.vec3f16("normal"),i.freeze()}export{g as LineMarkerTechnique,S as getLayout};
