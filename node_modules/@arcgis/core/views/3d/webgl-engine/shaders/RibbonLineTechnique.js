/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{newLayout as e}from"../../support/buffer/InterleavedLayout.js";import{isColorOrColorEmission as t}from"../core/shaderLibrary/ShaderOutput.js";import{ReloadableShaderModule as i}from"../core/shaderTechnique/ReloadableShaderModule.js";import{ShaderTechnique as r,depthOnlyOutputBuffersOr as l}from"../core/shaderTechnique/ShaderTechnique.js";import{olidEnabled as s}from"../effects/geometry/olidUtils.js";import{OITPolygonOffset as n,depthWrite as o,oitDepthTest as u,blending as c,getDrawBuffers as a}from"../lib/OrderIndependentTransparency.js";import{stencilToolMaskBaseParams as p,stencilBaseAllZerosParams as f,stencilWriteMaskOn as d,stencilToolTransparentOccluderParams as h,depthCompareAlways as m,stencilToolMaskOccluderParams as P,stencilWriteMaskOff as g,depthCompareLess as b}from"../lib/StencilUtils.js";import{R as T}from"../../../../chunks/RibbonLine.glsl.js";import{PrimitiveType as W}from"../../../webgl/enums.js";import{makePipelineState as y,defaultColorWrite as O,unpremultipliedAlphaToPremultipliedAlpha as j}from"../../../webgl/renderState.js";class S extends r{constructor(e,t){super(e,t,new i(T,()=>import("./RibbonLine.glsl.js")),v(t).locations),this.primitiveType=t.wireframe?W.LINES:W.TRIANGLE_STRIP}_makePipelineState(e,i){const{oitPass:r,output:s,hasOccludees:h,hasPolygonOffset:m}=e,P=0===r,g=2===r;return y({blending:t(s)?c(r):null,depthTest:{func:u(r)},depthWrite:o(e),drawBuffers:l(s,a(r,s)),colorWrite:O,stencilWrite:h?d:null,stencilTest:h?i?p:f:null,polygonOffset:P||g?m?_:null:n})}initializePipeline(e){if(e.occluder){const t=e.hasPolygonOffset?_:null,{output:i,hasOccludees:r}=e;this._occluderPipelineTransparent=y({blending:j,polygonOffset:t,depthTest:m,depthWrite:null,colorWrite:O,stencilWrite:null,stencilTest:r?h:null,drawBuffers:l(i)}),this._occluderPipelineOpaque=y({blending:j,polygonOffset:t,depthTest:r?m:b,depthWrite:null,colorWrite:O,stencilWrite:r?g:null,stencilTest:r?P:null,drawBuffers:l(i)}),this._occluderPipelineMaskWrite=y({blending:null,polygonOffset:t,depthTest:b,depthWrite:null,colorWrite:null,stencilWrite:r?d:null,stencilTest:r?p:null,drawBuffers:l(i)})}return this._occludeePipeline=this._makePipelineState(e,!0),this._makePipelineState(e,!1)}getPipeline(e,t){if(e)return this._occludeePipeline;switch(t){case 11:return this._occluderPipelineTransparent??super.getPipeline();case 10:return this._occluderPipelineOpaque??super.getPipeline();default:return this._occluderPipelineMaskWrite??super.getPipeline()}}}const _={factor:0,units:-4};function v(t){const i=e().vec3f("position").vec4f16("previousDelta").vec4f16("nextDelta").f32("u0").vec2f16("lineParameters");return t.hasVVColor?i.f32("colorFeatureAttribute"):i.vec4u8("color",{glNormalized:!0}),t.hasVVSize?i.f32("sizeFeatureAttribute"):i.f32("size"),t.hasVVOpacity&&i.f32("opacityFeatureAttribute"),s()&&i.vec4u8("olidColor"),t.hasAnimation&&i.vec4f16("timeStamps"),i}export{S as RibbonLineTechnique,v as getLayout};
