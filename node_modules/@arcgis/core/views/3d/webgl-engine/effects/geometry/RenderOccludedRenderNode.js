/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import r from"../../../../../core/PooledArray.js";import{property as t}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as o}from"../../../../../core/accessorSupport/decorators/subclass.js";import{ZEROS as s}from"../../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{InternalRenderCategory as c}from"../../../webgl.js";import i from"../../../webgl/RenderNode.js";import{Blit as n}from"../blit/Blit.js";import{DepthStencilAttachment as d}from"../../../../webgl/enums.js";let l=class extends i{constructor(e){super(e),this.consumes={required:[c.OCCLUDED]},this.produces=c.OCCLUDED,this._blit=new n(e.view.stage.renderView.techniques,2)}precompile(){const e=this.view.stage.renderer;e.plugins.plugins.forEach(r=>{e.precompileSlots(r,9,11),r.material&&e.precompileOccludedSlots(r,h)})}render(e){const r=e.find(({name:e})=>e===this.produces);return this._renderOccludedAndTransparentStencil(r),this._renderOccludedComposite(r),r}_renderOccludedAndTransparentStencil(e){const r=this.view.stage.renderer,t=a;t.clear();for(const o of r.plugins.plugins)8&o.renderOccludedFlags&&t.push(o);0!==t.length&&(r.renderSlots(t,10),this._renderAndComposite(e,e.getAttachment(d),.5,()=>r.renderSlots(t,11),!1,!1),t.clear())}_renderOccludedComposite(e){const r=this.view.stage.renderer,t=a;t.clear();let o=0;for(const i of r.plugins.plugins){const e=i.renderOccludedFlags&m;o|=e,e&&t.push(i)}if(!o)return void t.clear();const s=this._getDepthStencilAttachment(e);let c=s.clearStencil;for(const i of h)o&i&&(this._renderAndComposite(e,s.depth,16===i?1:.5,()=>r.renderOccludedSlots(t,i),!0,c),c=!1);s.release(),t.clear()}_renderAndComposite(e,r,t,o,c,i){const n=this.renderingContext,{width:d,height:l}=e.fbo,a=this.fboCache.acquire(d,l,"tmp color");a.attachDepth(r),n.bindFramebuffer(a.fbo),n.clearFramebuffer(s,c,i),o(),a.detachDepth(),this._blit.blend(n,a,e,this.bindParameters,t),a.release()}_getDepthStencilAttachment(e){const{width:r,height:t}=e.fbo;if(!this.view.stage.renderer.occludedRequiresIntegratedMeshStencil){const e=this.fboCache.acquireDepth(13,r,t,"retained stencil");return{depth:e,release:()=>e.release(),clearStencil:!0}}const o=this.fboCache.acquire(r,t,"retained stencil",13);return this.renderingContext.blitFramebuffer(e.fbo,o.fbo,1024),{depth:o.getAttachment(d),release:()=>o.release(),clearStencil:!1}}};e([t()],l.prototype,"consumes",void 0),e([t()],l.prototype,"produces",void 0),l=e([o("esri.views.3d.webgl-engine.effects.geometry.RenderOccludedRenderNode")],l);const a=new r;function p(){a.prune()}const h=[4,2,16],m=h.reduce((e,r)=>e|r,0);export{l as RenderOccludedRenderNode,p as cleanupRenderOccluded};
