/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import{unitRGBAFromColor as s}from"../../../../../core/colorUtils.js";import{smoothstep as t,clamp as i}from"../../../../../core/mathUtils.js";import{watch as r,syncAndInitial as a}from"../../../../../core/reactiveUtils.js";import{property as o}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/has.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as h}from"../../../../../core/accessorSupport/decorators/subclass.js";import{n as c,j as p,f as n}from"../../../../../chunks/vec32.js";import{create as d}from"../../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{getDefaultHighlightOptions as m}from"../../../../2d/support/highlightOptionsUtils.js";import{RenderCategory as l}from"../../../webgl.js";import u from"../../../webgl/RenderNode.js";import{ShadowHighlightPassParameters as f,ShadowHighlightTechnique as g}from"./ShadowHighlightTechnique.js";import{defaultShadowOpacity as w,defaultShadowDifference as _,defaultShadowColor as O}from"../../../../support/HighlightDefaults.js";const y=1/512,P=4e4,j=5e4;let v=class extends u{constructor(e){super(e),this.produces=l.COMPOSITE,this.consumes={required:[l.COMPOSITE,"highlights"]},this._passParameters=new f,this._maxOpacity=1,this._shadowDifference=.2}initialize(){this.addHandles([r(()=>m(this.view)?.shadowOpacity,e=>{this._passParameters.shadowOpacity=e??w,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},a),r(()=>m(this.view)?.shadowDifference,e=>{this._shadowDifference=e??_,this._updateOccludedShadowOpacity(),this._ensureMaxOpacity()},a),r(()=>m(this.view)?.shadowColor,e=>{this._passParameters.shadowColor=s(e??O),this._ensureMaxOpacity()},a)])}_updateOccludedShadowOpacity(){this._passParameters.occludedShadowOpacity=this._passParameters.shadowOpacity*(1-this._shadowDifference)}_ensureMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3],this.requestRender(1)}precompile(){this.techniques.precompile(g)}render(e){const s=e.find(({name:e})=>e===l.COMPOSITE),t=this.bindParameters;if(!t.shadowHighlightsVisible||!t.depth||!this._ensureIfVisible(t.camera,t.lighting.mainLight.direction))return s;const i=this.techniques.get(g);if(!i.compiled)return this.requestRender(1),s;this._passParameters.highlightTexture=e.find(({name:e})=>"highlights"===e)?.getTexture(),this._passParameters.origin=t.camera.center;const r=this.renderingContext;return r.bindFramebuffer(s.fbo),r.bindTechnique(i,t,this._passParameters),r.screen.draw(),s}_ensureIfVisible(e,s){this._passParameters.opacityElevation=1-t(P,j,e.relativeElevation);const r=1===this.viewingMode?c(b,e.center):p(b,0,0,1),a=n(r,s);return this._passParameters.dayNightTerminator=t(0,1,i(30*a,0,1)),this._maxOpacity*this._passParameters.opacityElevation*this._passParameters.dayNightTerminator>=y}};e([o()],v.prototype,"produces",void 0),e([o()],v.prototype,"consumes",void 0),e([o({constructOnly:!0})],v.prototype,"viewingMode",void 0),v=e([h("esri.views.3d.webgl-engine.effects.highlight.ShadowHighlight")],v);const b=d();export{v as ShadowHighlight};
