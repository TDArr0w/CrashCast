/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{fromValues as e}from"../../../../core/libs/gl-matrix-2/factories/vec4f64.js";import{BufferViewMat3f as t,BufferViewVec4f as r}from"../../../../geometry/support/buffer/BufferView.js";import{isHighlightOrOID as s,isColorOrColorEmission as i,isDepth as o,isColorEmissionHighlightOrOID as a}from"../core/shaderLibrary/ShaderOutput.js";import n from"../lib/GLMaterial.js";import{OITPolygonOffsetLimit as c}from"../lib/OrderIndependentTransparency.js";import{assert as f}from"../lib/Util.js";import{DefaultBufferWriter as l}from"./DefaultBufferWriter.js";import{TriangleMaterial as h}from"./TriangleMaterial.js";import{VisualVariablePassParameters as u}from"./VisualVariablePassParameters.js";import{writeAttributes as p,writeBufferVec4 as m}from"./internal/bufferWriterUtils.js";import{getLayout as g,PatternTechnique as d}from"../shaders/PatternTechnique.js";import{PatternTechniqueConfiguration as b}from"../shaders/PatternTechniqueConfiguration.js";import{alphaCutoff as y}from"../../../../webscene/support/AlphaCutoff.js";class _ extends h{constructor(e){super(e,x),this._configuration=new b,this.supportsEdges=!0,this.produces=new Map([[2,e=>s(e)],[4,e=>i(e)],[5,e=>o(e)],[18,e=>this.parameters.draped&&a(e)]])}getConfiguration(e,t){return super.getConfiguration(e,t,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.style=this.parameters.style,this._configuration.draped=this.parameters.draped,this._configuration.oitPass=t.oitPass,this._configuration.enableOffset=t.camera.relativeElevation<c,this._configuration.terrainDepthTest=t.terrainDepthTest&&i(e),this._configuration.cullAboveTerrain=t.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration}get visible(){return this.parameters.color[3]>=y}createGLMaterial(e){return new j(e)}createBufferWriter(){return new v(g(this.parameters))}}class j extends n{beginSlot(e){return this.getTechnique(d,e)}}class v extends l{write(e,s,i,o,a,n){const c=p(i,o,this.layout,e,s,a,n);for(const l of this.layout.fields.keys()){const s=i.get(l),o=s?.indices;if(s&&o)switch(l){case"uvMapSpace":{f(4===s.size);const e=a.getField(l,r);e&&m(s,e,n);break}case"boundingRect":{f(9===s.size);const r=a.getField(l,t);r&&C(s,e,r,n);break}}}return c}}function C(e,t,r,s){const{data:i,indices:o}=e,a=t,n=r.typedBuffer,c=r.typedBufferStride,f=o.length;s*=c;for(let l=0;l<f;++l){const e=9*o[l],t=i[e],r=i[e+1],f=i[e+2];n[s]=a[0]*t+a[4]*r+a[8]*f+a[12],n[s+1]=a[1]*t+a[5]*r+a[9]*f+a[13],n[s+2]=a[2]*t+a[6]*r+a[10]*f+a[14];for(let o=3;o<9;++o)n[s+o]=i[e+o];s+=c}}class x extends u{constructor(){super(...arguments),this.color=e(1,1,1,1),this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.hasOccludees=!1,this.style=2,this.draped=!0}}export{x as Parameters,_ as PatternMaterial};
