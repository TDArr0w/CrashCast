/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{getOrCreateMapValue as s}from"../../../../../core/MapUtils.js";import t from"../../../../../core/PooledArray.js";import{BufferRange as e}from"./BufferRange.js";import{DrawCommand as n}from"./DrawCommand.js";import{InstancedCommandVAO as a}from"./InstancedCommandVAO.js";import{InstancedCommandVAOs as i}from"./InstancedCommandVAOs.js";import{defaultHighlightName as o}from"../../../../support/HighlightDefaults.js";class h{constructor(s){this.targetBuffer=s,this.vaoEndElement=0,this._numElements=0,this._instances=new Map,this.holes=new t({allocator:s=>s||new e,deallocator:null}),this.hasHiddenInstances=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.highlightNames=new Set,this.drawCommandsDefault=d(),this.drawCommandsHighlights=new Map,this.drawCommandsOccludees=d(),this.drawCommandsShadowHighlightRest=d(),this._instancedCommandVAOs=null}get numElements(){return this._numElements}get instances(){return this._instances}get writeableInstances(){return this._instances}get hasHighlights(){return this.highlightNames.size>0}get instancedCommandVAOs(){return this._instancedCommandVAOs}resetInstanceSummary(){this.hasHiddenInstances=!1,this.hasOccludees=!1,this.highlightNames.clear()}updateIfDrawCommandsDirty(s){if(this.drawCommandsDirty){this.resetInstanceSummary();for(const s of this.instances.values())this.updateDrawState(s);this.updateDrawCommands(s)}}addInstance(s,t){this.deleteInstance(s),this._instances.set(s,t),this._numElements+=t.numElements}deleteInstance(s){const t=this._instances.get(s);t&&(this._numElements-=t.numElements,this._instances.delete(s))}updateInstances(){let s=0;for(const t of this._instances.values())s+=t.numElements,this.updateDrawState(t);this._numElements=s}updateDrawState(s){if(s.isVisible){const{highlightName:t}=s;t&&this.highlightNames.add(t),s.hasOccludees&&(this.hasOccludees=!0)}else this.hasHiddenInstances=!0}updateDrawCommands(s){this._updateDrawCommands(s),this._updateInstancedCommandVAOs()}_updateDrawCommands(s){if(this.drawCommandsDefault.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsDirty=!1,0===this._instances.size)return;const{sortedInstances:t}=this;if(this._updateHighlightDrawCommands(s,t),!this.needsMultipleCommands){const s=this.drawCommandsDefault.pushNew(),t=this.holes.front();return this.vao&&1===this.holes.length&&t.to===this.vaoEndElement?(s.first=0,void(s.count=t.from)):(s.first=1/0,s.count=0,this._instances.forEach(t=>{s.first=Math.min(s.first,t.from),s.count=Math.max(s.count,t.to)}),void(s.count-=s.first))}for(const e of t)e.isVisible&&c(e.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,e)}get sortedInstances(){return Array.from(this._instances.values()).sort((s,t)=>s.from===t.from?s.to-t.to:s.from-t.from)}updateHighlights(s){this.highlightNames.clear();const t=this.sortedInstances;for(const e of t)e.updateHighlightOptions(s),e.isVisible&&e.highlightName&&this.highlightNames.add(e.highlightName);this._updateHighlightDrawCommands(s),this._updateInstancedCommandVAOs()}_updateHighlightDrawCommands(t,e=this.sortedInstances){const{drawCommandsHighlights:n,drawCommandsShadowHighlightRest:a}=this;n.clear(),a.clear();for(const i of e){if(i.updateHighlightOptions(t),!i.isVisible)continue;const{highlightName:e}=i;if(e){this.highlightNames.add(e);c(s(n,e,d),i)}e&&e===o||c(a,i)}}_updateInstancedCommandVAOs(){const s=this.vao;if("geometry"===this.targetBuffer||null==s)return;this._instancedCommandVAOs??=new i;const t=this._instancedCommandVAOs,e=t.commandVAOs.copy();t.clear();const n=t.commandVAOs,o=(t,i)=>{for(const o of t){const{first:t,count:h}=o,m=n.get(t,h)??e.pop(t,h)??new a(s.shallowCloneWithBaseInstances(new Map([["instances",o.first]])),o.count);n.set(t,h,m),i.push(m)}};o(this.drawCommandsDefault,t.drawCommandsDefault);for(const[a,i]of this.drawCommandsHighlights){const s=new Array;o(i,s),t.drawCommandsHighlights.set(a,s)}o(this.drawCommandsOccludees,t.drawCommandsOccludees),o(this.drawCommandsShadowHighlightRest,t.drawCommandsShadowHighlightRest);for(const a of e.values())a.dispose();e.clear()}get needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}}function m(s){return null!=s.vao}function r(s){return s?"instances":"geometry"}function d(){return new t({allocator:s=>s||new n,deallocator:s=>s})}function c(s,t){const e=s.back();if(null==e){const e=s.pushNew();return e.first=t.from,void(e.count=t.numElements)}if(l(e,t)){const s=t.from-e.first+t.numElements;e.count=s}else{const e=s.pushNew();e.first=t.from,e.count=t.numElements}}function l(s,t){return s.first+s.count>=t.from}export{h as PerBufferData,r as getTargetBuffer,m as hasVao};
