/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import e from"../../../../../core/Accessor.js";import"../../../../../core/has.js";import{disposeMaybe as s}from"../../../../../core/maybe.js";import{property as i}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/Logger.js";import"../../../../../core/RandomLCG.js";import{subclass as r}from"../../../../../core/accessorSupport/decorators/subclass.js";import{GLMaterials as a}from"../../lib/GLMaterials.js";import{DrawParameters as n}from"../DrawParameters.js";import{defaultHighlightName as o}from"../../../../support/HighlightDefaults.js";let h=class extends e{constructor(t){super(t),this._glMaterials=null,this._drawParameters=new n,this._highlightNames=new Set,this._produces=new Map}initialize(){this._updateProduces()}destroy(){this.uninitializeRenderContext()}get _hasHighlights(){return this._highlightNames.size>0}hasHighlight(t){return this._highlightNames.has(t)}get produces(){return this._produces}_updateProduces(){this.material.produces.forEach((t,e)=>{this._produces.set(e,e=>!(0===this.dataByBaseInstance.size||!(9!==e&&5!==e||this._hasHighlights))&&t(e))})}initializeRenderContext(t){this._glMaterials=new a(this.material,t.materials)}uninitializeRenderContext(){this._glMaterials=s(this._glMaterials)}acquireTechniques(t){if(!this.material.shouldRender(t))return null;const{output:e,bind:s}=t,i=this.material.produces.get(s.slot);if(!i?.(e))return null;const{highlight:r,slot:a}=s,n=5===e,h=9===e,l=h||n,d=r?.name;if(l&&(0===this._highlightNames.size||h&&d&&!this._highlightNames.has(d)))return null;const c=t=>h&&!!d&&!t.has(d),u=6===e,g=!(l||u);for(const m of this.dataByBaseInstance.values())for(const i of m.dataByOrigin.values())for(const r of i.buffers){if(c(r.highlightNames))continue;const i=n?r.drawCommandsHighlights.get(o):l?d?r.drawCommandsHighlights.get(d):r.drawCommandsHighlights.size>0:((u&&r.needsMultipleCommands?r.drawCommandsShadowHighlightRest:r.drawCommandsDefault)||null)?.length??!1,h=g&&r.drawCommandsOccludees||null;if(i||h?.length){const i=this._glMaterials.load(t.rctx,a,e),r=i?.beginSlot(s);if(r)return r}}return null}render(t,e){const{output:s,bind:i}=t,{slot:r,highlight:a}=i,n=9===s,h=a?.name??"";if(n&&!a)return;const g=5===s,m=n||g,w=6===s,C=!(m||w),_=10===r||11===r?r:null,{rctx:b}=t;b.runAppleAmdDriverHelper();const y=b.bindTechnique(e,i,this.material.parameters);for(const H of this.dataByBaseInstance.values()){const{baseInstanceData:t}=H,s=null!=t,r=s?u:c,a=s?d:l;for(const l of H.dataByOrigin.values()){this._drawParameters.origin=l.origin;for(const s of l.buffers){if(n&&(!s.hasHighlights||!s.drawCommandsHighlights.has(h)))continue;if(g&&(!s.hasHighlights||!s.drawCommandsHighlights.has(o)))continue;const l=a(s),d=f(l,s.needsMultipleCommands,h,g,m,w),c=p(l,C);(d?.length||c?.length)&&(y.bindDraw(i,this.material.parameters,this._drawParameters),r(b,s,t,e,d,c,_))}}}}updateHighlights(){const{_highlightNames:t}=this;t.clear();for(const e of this.dataByBaseInstance.values())for(const s of e.dataByOrigin.values())for(const e of s.buffers)for(const s of e.highlightNames)t.add(s);this._updateProduces()}get test(){}};t([i({constructOnly:!0})],h.prototype,"material",void 0),t([i({constructOnly:!0})],h.prototype,"dataByBaseInstance",void 0),h=t([r("esri.views.3d.webgl-engine.materials.renderers.VaoRenderer")],h);const l=t=>t,d=t=>t.instancedCommandVAOs,c=(t,{vao:e},s,i,r,a,n)=>{i.ensureAttributeLocations(e),t.bindVAO(e),g(t,i,r,n,!1),g(t,i,a,n,!0)},u=(t,e,{baseCommand:s},i,r,a,n)=>{m(t,i,s,r,n,!1),m(t,i,s,a,n,!0)};function g(t,e,s,i,r){if(s?.length){t.setPipelineState(e.getPipeline(r,i));for(const i of s)t.drawArrays(e.primitiveType,i.first,i.count)}}function m(t,e,{first:s,count:i},r,a,n){if(r?.length){t.setPipelineState(e.getPipeline(n,a));for(const{vao:a,instanceCount:n}of r)e.ensureAttributeLocations(a),t.bindVAO(a),t.drawArraysInstanced(e.primitiveType,s,i,n)}}function f(t,e,s,i,r,a){const n=r&&!i?t.drawCommandsHighlights.get(s)??null:null;return i?t.drawCommandsHighlights.get(o):r?n:a&&e?t.drawCommandsShadowHighlightRest:t.drawCommandsDefault}function p(t,e){return e&&t.drawCommandsOccludees||null}export{h as VaoRenderer};
