/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{a as n,j as t,d as i,i as o,n as e}from"../../../../chunks/vec32.js";import{create as c}from"../../../../core/libs/gl-matrix-2/factories/vec3f64.js";import{setMin as s,create as f,setMax as r}from"../../../../geometry/support/aaBoundingBox.js";import{assert as u}from"./Util.js";class a{constructor(n=0,t=!1,i=!0){this.tolerance=n,this.isVerticalRay=t,this.normalRequired=i}}const l=f();function h(t,i,o,e,c,s){if(!t.visible)return;const f=n(F,e,o),r=(n,t,i)=>s(n,i,t),{tolerance:l}=i,h=new a(l,!1,i.options.normalRequired);if(t.boundingInfo)u(0===t.type),b(t.boundingInfo,o,f,l,c,h,r);else{const n=t.positionAttribute,i=n.indices;V(o,f,0,i.length/3,i,n.data,n.stride,c,h,r)}}const p=c();function b(n,t,i,o,e,c,f){if(null==n)return;const u=C(i,p);if(s(l,n.bbMin),r(l,n.bbMax),null!=e&&e.applyToAabb(l),U(l,t,u,o)){const{primitiveIndices:s,position:r}=n,u=s?s.length:r.indices.length/3;if(u>D){const s=n.getChildren();if(void 0!==s){for(const n of s)b(n,t,i,o,e,c,f);return}}T(t,i,0,u,r.indices,r.data,r.stride,s,e,c,f)}}const m=c();function M(t,i,o,e,c,s,f,r,u){const{data:a,stride:l}=s;V(t,n(F,i,t),o,e,c,a,l,f,r,u)}function d(n,t,i,o){if(!i.visible)return;const e=(n,t,i)=>o(n,i,t),{boundingInfo:c}=i;if(c){const{bbMin:i,bbMax:o}=c;if(n<i[0]||n>o[0]||t<i[1]||t>o[1])return}const s=i.positionAttribute,f=s.indices;x(n,t,0,f.length/3,f,s,e)}function x(n,t,i,o,e,c,s){const{data:f,stride:r}=c;for(let u=i;u<o;++u){const i=3*u,o=r*e[i],c=r*e[i+1],a=r*e[i+2],l=f[o+0]-n,h=f[o+1]-t,p=f[c+0]-n,b=f[c+1]-t,m=f[a+0]-n,M=f[a+1]-t,d=m*b-M*p,x=l*M-h*m,g=p*h-b*l;(d<0||x<0||g<0)&&(d>0||x>0||g>0)||s(0,u,null)}}function g(n,t,i,o,e,c,s,f,r,u=null,a=0){const l=n[0],h=n[1],p=n[2],b=t[0],M=t[1],d=t[2];for(let x=i;x<o;++x){const n=a+(u?u[x]:x),t=3*n,i=s*e[t],o=c[i],g=c[i+1],y=c[i+2],q=s*e[t+1],T=c[q],V=c[q+1],v=c[q+2],j=s*e[t+2],R=T-o,A=V-g,B=v-y,k=c[j]-o,w=c[j+1]-g,C=c[j+2]-y,U=M*C-w*d,z=d*k-C*b,D=b*w-k*M,F=R*U+A*z+B*D;if(Math.abs(F)<=E)continue;const G=l-o,H=h-g,J=p-y,K=G*U+H*z+J*D;if(F>0){if(K<0||K>F)continue}else if(K>0||K<F)continue;const L=H*B-A*J,N=J*R-B*G,O=G*A-R*H,P=b*L+M*N+d*O;if(F>0){if(P<0||K+P>F)continue}else if(P>0||K+P<F)continue;const Q=(k*L+w*N+C*O)/F;if(Q>=0){r(Q,n,f?I(R,A,B,k,w,C,m):null)}}}function y(n,t,i,o,e,c,s,f){const r=n[0],u=n[1],a=n[2],l=t[0],h=t[1],p=t[2];for(let b=i;b<o;++b){const n=3*b,t=n+1,i=n+2,o=c*n,M=e[o],d=e[o+1],x=e[o+2],g=c*t,y=c*i,q=e[g]-M,T=e[g+1]-d,V=e[g+2]-x,v=e[y]-M,j=e[y+1]-d,R=e[y+2]-x,A=h*R-j*p,B=p*v-R*l,k=l*j-v*h,w=q*A+T*B+V*k;if(Math.abs(w)<=E)continue;const C=r-M,U=u-d,z=a-x,D=C*A+U*B+z*k;if(w>0){if(D<0||D>w)continue}else if(D>0||D<w)continue;const F=U*V-T*z,G=z*q-V*C,H=C*T-q*U,J=l*F+h*G+p*H;if(w>0){if(J<0||D+J>w)continue}else if(J>0||D+J<w)continue;const K=(v*F+j*G+R*H)/w;if(K>=0){f(K,b,s?I(q,T,V,v,j,R,m):null)}}}function q(n,t,i,o,e,c,s,f,r,u,a,l=null,h=0){const p=n[0],b=n[1],M=n[2],d=t[0],x=t[1],g=t[2];for(let y=i;y<o;++y){const n=h+(l?l[y]:y),t=3*n,i=s*e[t],o=c[i],q=c[i+1],T=c[i+2],V=s*e[t+1],v=c[V],j=c[V+1],R=c[V+2],A=s*e[t+2],B=c[A],k=c[A+1],w=c[A+2],C=T-r,U=f/Math.sqrt(o*o+q*q+C*C),z=o+o*U,D=q+q*U,F=T+C*U,G=R-r,H=f/Math.sqrt(v*v+j*j+G*G),J=v+v*H,K=j+j*H,L=R+G*H,N=w-r,O=f/Math.sqrt(B*B+k*k+N*N),P=J-z,Q=K-D,S=L-F,W=B+B*O-z,X=k+k*O-D,Y=w+N*O-F,Z=x*Y-X*g,$=g*W-Y*d,_=d*X-W*x,nn=P*Z+Q*$+S*_;if(Math.abs(nn)<=E)continue;const tn=p-z,on=b-D,en=M-F,cn=tn*Z+on*$+en*_;if(nn>0){if(cn<0||cn>nn)continue}else if(cn>0||cn<nn)continue;const sn=on*S-Q*en,fn=en*P-S*tn,rn=tn*Q-P*on,un=d*sn+x*fn+g*rn;if(nn>0){if(un<0||cn+un>nn)continue}else if(un>0||cn+un<nn)continue;const an=(W*sn+X*fn+Y*rn)/nn;if(an>=0){a(an,n,u?I(P,Q,S,W,X,Y,m):null)}}}function T(n,t,i,o,e,c,s,f,r,u,a){const l=n[0],h=n[1],p=n[2],b=t[0],M=t[1],d=t[2],{normalRequired:x}=u;for(let g=i;g<o;++g){const n=f[g],t=3*n,i=s*e[t];let o=c[i],u=c[i+1],y=c[i+2];const q=s*e[t+1];let T=c[q],V=c[q+1],v=c[q+2];const j=s*e[t+2];let R=c[j],A=c[j+1],B=c[j+2];null!=r&&([o,u,y]=r.applyToVertex(o,u,y,g),[T,V,v]=r.applyToVertex(T,V,v,g),[R,A,B]=r.applyToVertex(R,A,B,g));const k=T-o,w=V-u,C=v-y,U=R-o,z=A-u,D=B-y,F=M*D-z*d,G=d*U-D*b,H=b*z-U*M,J=k*F+w*G+C*H;if(Math.abs(J)<=E)continue;const K=l-o,L=h-u,N=p-y,O=K*F+L*G+N*H;if(J>0){if(O<0||O>J)continue}else if(O>0||O<J)continue;const P=L*C-w*N,Q=N*k-C*K,S=K*w-k*L,W=b*P+M*Q+d*S;if(J>0){if(W<0||O+W>J)continue}else if(W>0||O+W<J)continue;const X=(U*P+z*Q+D*S)/J;if(X>=0){a(X,n,x?I(k,w,C,U,z,D,m):null)}}}function V(o,e,c,s,f,r,u,a,l,h){const p=e,b=G,m=Math.abs(p[0]),M=Math.abs(p[1]),d=Math.abs(p[2]),x=m>=M?m>=d?0:2:M>=d?1:2,g=x,y=p[g]<0?2:1,q=(x+y)%3,T=(x+(3-y))%3,V=p[q]/p[g],I=p[T]/p[g],B=1/p[g],k=v,w=j,C=R,{normalRequired:U}=l;for(let v=c;v<s;++v){const e=3*v,c=u*f[e];t(b[0],r[c+0],r[c+1],r[c+2]);const s=u*f[e+1];t(b[1],r[s+0],r[s+1],r[s+2]);const l=u*f[e+2];t(b[2],r[l+0],r[l+1],r[l+2]),a&&(i(b[0],a.applyToVertex(b[0][0],b[0][1],b[0][2],v)),i(b[1],a.applyToVertex(b[1][0],b[1][1],b[1][2],v)),i(b[2],a.applyToVertex(b[2][0],b[2][1],b[2][2],v))),n(k,b[0],o),n(w,b[1],o),n(C,b[2],o);const p=k[q]-V*k[g],m=k[T]-I*k[g],M=w[q]-V*w[g],d=w[T]-I*w[g],x=C[q]-V*C[g],y=C[T]-I*C[g],j=x*d-y*M,R=p*y-m*x,z=M*m-d*p;if((j<0||R<0||z<0)&&(j>0||R>0||z>0))continue;const D=j+R+z;if(0===D)continue;const E=j*(B*k[g])+R*(B*w[g])+z*(B*C[g]);if(E*Math.sign(D)<0)continue;const F=E/D;if(F>=0){h(F,v,U?A(b):null)}}}const v=c(),j=c(),R=c();function I(n,i,c,s,f,r,u){return t(B,n,i,c),t(k,s,f,r),o(u,B,k),e(u,u),u}function A(t){return n(B,t[1],t[0]),n(k,t[2],t[0]),o(m,B,k),e(m,m),m}const B=c(),k=c();function w(n,i,o){return t(o,1/(i[0]-n[0]),1/(i[1]-n[1]),1/(i[2]-n[2]))}function C(n,i){return t(i,1/n[0],1/n[1],1/n[2])}function U(n,t,i,o){return z(n,t,i,o,1/0)}function z(n,t,i,o,e){const c=(n[0]-o-t[0])*i[0],s=(n[3]+o-t[0])*i[0];let f=Math.min(c,s),r=Math.max(c,s);const u=(n[1]-o-t[1])*i[1],a=(n[4]+o-t[1])*i[1];if(r=Math.min(r,Math.max(u,a)),r<0)return!1;if(f=Math.max(f,Math.min(u,a)),f>r)return!1;const l=(n[2]-o-t[2])*i[2],h=(n[5]+o-t[2])*i[2];return r=Math.min(r,Math.max(l,h)),!(r<0)&&(f=Math.max(f,Math.min(l,h)),!(f>r)&&f<e)}const D=1e3,E=1e-7,F=c(),G=[c(),c(),c()];export{a as MeshIntersectionOptions,w as computeInvDir,C as computeInvDirFromDirection,I as computeNormalFromBarycentric,U as intersectAabbInvDir,z as intersectAabbInvDirBefore,g as intersectRayTriangles,V as intersectRayTrianglesWithDisplacementWatertight,q as intersectRayTrianglesWithVerticalOffsetENUGlobal,y as intersectRenderGeometryTriangles,h as intersectTriangleGeometry,d as intersectTriangleGeometry2d,M as intersectTriangles,x as intersectTriangles2d,E as triangleRayParallelTolerance};
