/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{estimateNumberMemory as e}from"../../../../../core/memoryEstimations.js";import{getMetersPerUnitForSR as t,inchesPerMeter as i}from"../../../../../core/unitUtils.js";import{AAggregateSpatialIndex as s}from"./AAggregateSpatialIndex.js";import{GridCell as l}from"./GridCell.js";const o=96;function r(e,s){return t(e)*i*o/s}class n extends s{constructor(e){super(e),this._cells=new Map,this._pixelsPerMapUnit=r(e.spatialReference,e.scale)}get usedMemory(){const t=this._cells.values().next().value;return t?(e+t.usedMemory)*this._cells.size:0}put(e){for(const t of this._cells.values()){const i=e.get(t.id);i?i.merge(t):e.set(t.id,t.clone())}}putBounded(e,t,i){const s=[t.xmin,t.ymin,t.xmax,t.ymax],[l,o,r,n]=s,c=Math.floor(l*this._pixelsPerMapUnit/this._options.cellSize),p=Math.floor(o*this._pixelsPerMapUnit/this._options.cellSize),a=Math.ceil(r*this._pixelsPerMapUnit/this._options.cellSize),h=Math.ceil(n*this._pixelsPerMapUnit/this._options.cellSize);for(let _=p;_<=h;_++)for(let t=c;t<=a;t++){const i=`${t}.${_}`,s=this._cells.get(i);if(!s)continue;const l=e.get(s.id);l?s&&!e.has(s.id)&&l.merge(s):e.set(s.id,s.clone())}}_insert(e,t,i,s){const l=t*this._pixelsPerMapUnit,o=i*this._pixelsPerMapUnit,r=Math.floor(l/this._options.cellSize),n=Math.floor(o/this._options.cellSize);this._getCellOrCreate(r,n).insert(e,s,t,i)}_getCellOrCreate(e,t){const i=l.createId(e,t);let s=this._cells.get(i);if(!s){const o=1*this._options.cellSize/this._pixelsPerMapUnit;s=l.create(e,t,this._options.fields,o),this._cells.set(i,s)}return s}}export{n as GridSpatialIndex,r as pixelsPerMapUnit};
