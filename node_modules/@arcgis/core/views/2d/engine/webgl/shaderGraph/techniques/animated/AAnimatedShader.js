/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as i}from"tslib";import{animationDebugFlags as t}from"../../../../../../../symbols/cim/animationDebugFlags.js";import{generateVirtualMachineSource as e}from"../../../animations/instructions.js";import{location as o,uniform as a,option as r}from"../../GraphShaderModule.js";import{Vec2 as s,texture2D as l,block as n,Float as m,step as p,negate as u,cond as d,equal as c,Mat2 as y,cos as f,sin as v,Mat3 as b,Vec3 as S,lessThanEqual as h,ifElse as w,clamp as g,abs as V,Vec4 as x}from"../../graph/glsl.js";import{AnimationUniformInfo as z}from"./AnimationUniformInfo.js";import{MarkerConstants as P}from"../markers/markerConstants.js";import{AFeatureShader as j,FeatureVertexInput as T,FeatureFragmentInput as _}from"../shaders/AFeatureShader.js";import{c256ToRad as I,softEdgeRatio as O}from"../shaders/constants.js";import{LocalTileOffset as C}from"../shaders/LocalTileOffset.js";import{MosaicInfo as M}from"../shaders/MosaicInfo.js";import{getBit as D,rgba2float as A}from"../shaders/utils.js";import{VisualVariableColor as F}from"../shaders/VisualVariableColor.js";import{VisualVariableOpacity as L}from"../shaders/VisualVariableOpacity.js";import{VisualVariableRotation as R}from"../shaders/VisualVariableRotation.js";import{VisualVariableSizeMinMaxValue as k}from"../shaders/VisualVariableSizeMinMaxValue.js";import{VisualVariableSizeScaleStops as U}from"../shaders/VisualVariableSizeScaleStops.js";import{VisualVariableSizeStops as E}from"../shaders/VisualVariableSizeStops.js";import{VisualVariableSizeUnitValue as B}from"../shaders/VisualVariableSizeUnitValue.js";import{getVisualVariableSize as G,getVisualVariableAngle as N}from"../shaders/vvUtils.js";class W extends T{}i([o(3,s)],W.prototype,"offset",void 0),i([o(4,x)],W.prototype,"sizing",void 0),i([o(5,x)],W.prototype,"value1Position2Value2",void 0),i([o(6,x)],W.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),i([o(7,s)],W.prototype,"zoomRange",void 0),i([o(8,m)],W.prototype,"lineLength",void 0);class q extends _{}class H extends j{_vertexPreamble(i,t,e){const{id:o,offset:a,animationPointerAndBaseSizeAndReferenceSize:r,sizing:s}=i,l=r.xy,n=r.z,b=r.w,S=s.xy,h=this._getEvalParams(i,S,e);let w,g;if(i.value1Position2Value2){const t=J(l,6,h).a,e=i.pos,o=i.value1Position2Value2.yz,a=i.value1Position2Value2.x,r=i.value1Position2Value2.w,s=t.subtract(a).divide(r.subtract(a));g=e.add(o.subtract(e).multiply(s)),w=p(new m(1),s).add(p(new m(0),u(s)))}else g=i.pos,w=new m(0);const V=s.z,x=D(i.bitset,P.bitset.isStroke),z=s.w,j=D(i.bitset,P.bitset.scaleSymbolsProportionally),T=J(l,0,h),_=d([c(D(i.bitset,P.bitset.isMapAligned),new m(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new m(0)]),O=new y(f(_),v(_.multiply(-1)),v(_),f(_)).multiply(T.xy),C=T.z.subtract(_).subtract(t.multiply(I)),M=T.w,A=D(i.bitset,P.bitset.isSDF),F=G(this,o,new m(b)).divide(new m(b));return{baseSize:n,animationPointer:l,strokeWidth:V,isOutline:x,unscaledDistanceToPx:z,scaleSymbolsProportionally:j,isSDF:A,position:this._getScreenPosition({id:o,pos:g,offset:a,referenceSize:b,translation:O,rotation:C,scale:M,vvScale:F}),evalParams:h,vvScale:F,scale:M,clip:w}}_getScreenPosition(i){const{pos:t,translation:e,rotation:o,scale:a,offset:r,id:s,vvScale:l}=i,n=N(this,s).multiply(Math.PI/180),p=e.x.multiply(4/3),d=e.y.multiply(-1).multiply(4/3),c=v(n),y=f(n),h=y.multiply(p).add(u(c).multiply(d)),w=c.multiply(p).add(y.multiply(d)),g=v(o.subtract(n)),V=f(o.subtract(n)),x=new m(0),z=new m(1),{pixelRatio:P}=this.animationInfo,j=new b(z,x,x,x,z,x,h.multiply(P),w.multiply(P),z),T=new b(V,g.multiply(-1),x,g,V,x,0,0,z),_=a.multiply(l).multiply(P).multiply(4/3),I=T.multiply(_),O=this.animationInfo.toScreen.multiply(new S(t,1)),C=j.multiply(O).xy,M=I.multiply(new S(r,0)).xy;return C.add(M)}_clip(i,e){let o=super.clip(i,e);const a=h(this._getLocalTimeOrigin(i),new m(0));return t.forceGlobalTimeOrigin||(o=o.add(d([a,()=>new m(2)],[!0,()=>new m(0)]))),o}_getLocalTimeOrigin(i){return this.storage.getLocalTimeOrigin(i)}_toNdc(i){return this.animationInfo.toNdc.multiply(new S(i,1)).xy}_getEvalParams(i,t,e){const{globalTime:o,animationTextureSize:a,animationTexture:r}=this.animationInfo;return{globalTime:o,localTimeOrigin:this._getLocalTimeOrigin(i.id),animationTextureSize:a,animationTexture:r,pixelDimensions:t,lineLength:e}}_getColor(i,t){return w(c(t.isSDF,new m(1)),this._getSDFColor(i,t),this._getSpriteColor(i,t))}_getSpriteColor(i,t){return l(this.mosaicInfo.texture,i).multiply(t.color)}_getSDFColor(i,t){const e=l(this.mosaicInfo.texture,i),o=new m(.5).subtract(A(e)).multiply(t.distanceToPx).multiply(O),a=g(new m(.5).subtract(o),new m(0),new m(1)),r=t.color.multiply(a),s=t.outlineSize.multiply(.5),n=V(o).subtract(s),p=g(new m(.5).subtract(n),new m(0),new m(1)),u=t.outlineColor.multiply(p);return new m(1).subtract(u.a).multiply(r).add(u)}}function J(i,t,o){const a=i.add(new s(t,0)),r=l(o.animationTexture,a.add(.5).divide(o.animationTextureSize)).xy;return i=i.add(r),n({animationPointer:i,...o},x,null,i=>{const{out:t}=i;if(!t)throw new Error("out is null");return e({...i,out:t})})}i([a(M)],H.prototype,"mosaicInfo",void 0),i([a(z)],H.prototype,"animationInfo",void 0),i([a(C)],H.prototype,"localTileOffset",void 0),i([r(F)],H.prototype,"visualVariableColor",void 0),i([r(L)],H.prototype,"visualVariableOpacity",void 0),i([r(k)],H.prototype,"visualVariableSizeMinMaxValue",void 0),i([r(U)],H.prototype,"visualVariableSizeScaleStops",void 0),i([r(E)],H.prototype,"visualVariableSizeStops",void 0),i([r(B)],H.prototype,"visualVariableSizeUnitValue",void 0),i([r(R)],H.prototype,"visualVariableRotation",void 0);export{q as AAnimatedFragmentInput,H as AAnimatedShader,W as AAnimatedVertexInput,J as getValue};
