/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t,__param as e}from"tslib";import{animationDebugFlags as i}from"../../../../../../../symbols/cim/animationDebugFlags.js";import{location as s,input as o,ComputeVertexInput as l}from"../../GraphShaderModule.js";import{Float as r,Vec4 as a,or as n,Bool as d,mix as m,Mat3 as u,ifElse as p,lessThan as h,Vec3 as x,distance as c,greaterThan as y,Vec2 as f,negate as w,step as g}from"../../graph/glsl.js";import{AAnimatedShader as v,getValue as S,AAnimatedVertexInput as b,AAnimatedFragmentInput as _}from"./AAnimatedShader.js";import{MarkerConstants as V}from"../markers/markerConstants.js";import{distPointTriangle as z,xyToBarycentric as C,inTriangle as P,failHittest as N}from"../shaders/hittestUtils.js";import{getBitBool as k}from"../shaders/utils.js";import{getVisualVariableColor as M,getVisualVariableOpacity as D}from"../shaders/vvUtils.js";class R extends b{}t([s(9,f)],R.prototype,"uv",void 0),t([s(10,r)],R.prototype,"angle",void 0);class F extends l{}t([s(11,f)],F.prototype,"offsetNextVertex1",void 0),t([s(12,f)],F.prototype,"offsetNextVertex2",void 0),t([s(13,f)],F.prototype,"textureUVNextVertex1",void 0),t([s(14,f)],F.prototype,"textureUVNextVertex2",void 0);class j extends _{}function T(t,e,i,s){return e.multiply(t.x).add(i.multiply(t.y)).add(s.multiply(t.z))}class U extends v{constructor(){super(...arguments),this.type="AnimatedMarkerShader",this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(t,e){const i=t.uv.divide(this.mosaicInfo.size),{position:s,animationPointer:o,evalParams:l,isOutline:p,unscaledDistanceToPx:h,vvScale:x,strokeWidth:c,scaleSymbolsProportionally:y,scale:f,isSDF:w,baseSize:g,clip:v}=this._vertexPreamble(t,t.angle,t.lineLength||new r(0)),b=this._toNdc(s);let _=S(o,1,l);_=new a(_.rgb.multiply(_.a),_.a);let z=S(o,2,l);z=new a(z.rgb.multiply(z.a),z.a);let C=S(o,3,l);C=new a(C.rgb.multiply(C.a),C.a);const P=S(o,4,l).a,N=S(o,5,l).a,R=M(this,t.id,_,n(k(t.bitset,V.bitset.colorLocked),new d(p))),F=m(R,z,C),j=D(this,t.id),T=m(j,P,N),U=F.multiply(T),q=this.clip(t.id,t.zoomRange).add(v.multiply(2)),A=h.multiply(x);return{glPosition:new a(b,q,1),uv:i,color:U.multiply(new r(1).subtract(p)),outlineColor:U.multiply(p),distanceToPx:A,strokeWidth:c.multiply(m(new r(1),f,y)),isOutline:p,isSDF:w,...this.maybeRunHittest(t,e,{pos:t.pos,size:g,sizeCorrection:new r(1),isMapAligned:new r(1),vvRotationMat3:new u(1,0,0,0,1,0,0,0,1),placementMat3:new u(1,0,0,0,1,0,0,0,1),outlineSize:new r(1),distanceToPx:A,isSDF:w})}}fragment(t){let e=this._getColor(t.uv,{color:t.color,distanceToPx:t.distanceToPx,isSDF:t.isSDF,outlineColor:t.outlineColor,outlineSize:t.strokeWidth});return i.spotlightAnimatedSymbols&&(e=e.add(new a(0,.3,0,.3))),this.getFragmentOutput(e,t)}hittest(t,e,i){return p(h(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(t,e,i),this._hittestMarker(t,e,i))}_hittestSmallMarker(t,e,i){const{position:s,distance:o,smallSymbolDistance:l}=this.hittestRequest,r=o.subtract(l),{viewMat3:a,tileMat3:n}=this.view,d=a.multiply(n).multiply(new x(i.pos,1)).xy,m=i.size.multiply(.5);return c(d,s).subtract(m).add(r)}_hittestMarker(t,e,i){const s=this._vertexPreamble({...t},t.angle,new r(0)).position,o=this._vertexPreamble({...t,offset:e.offsetNextVertex1},t.angle,new r(0)).position,l=this._vertexPreamble({...t,offset:e.offsetNextVertex2},t.angle,new r(0)).position,a=this.hittestRequest.position,n=this.hittestRequest.distance,d=z(a,s,o,l);return p(y(d,n),d,this._hittestSamples(s,o,l,t,e,i))}_hittestSamples(t,e,i,s,o,l){const{outlineSize:n,isSDF:d,distanceToPx:m}=l,u=this.hittestRequest.position,p=this.hittestRequest.distance,h=C(u.add(new f(w(p),w(p))),t,e,i),x=C(u.add(new f(0,w(p))),t,e,i),c=C(u.add(new f(p,w(p))),t,e,i),y=C(u.add(new f(w(p),0)),t,e,i),v=C(u,t,e,i),S=C(u.add(new f(p,0)),t,e,i),b=C(u.add(new f(w(p),p)),t,e,i),_=C(u.add(new f(0,p)),t,e,i),V=C(u.add(new f(p,p)),t,e,i),z=s.uv.divide(this.mosaicInfo.size),k=o.textureUVNextVertex1.divide(this.mosaicInfo.size),M=o.textureUVNextVertex2.divide(this.mosaicInfo.size),D={color:new a(1,1,1,1),outlineSize:n,outlineColor:new a(1,1,1,1),isSDF:d,distanceToPx:m};let R=new r(0);return R=R.add(P(h).multiply(this._getColor(T(h,z,k,M),D).a)),R=R.add(P(x).multiply(this._getColor(T(x,z,k,M),D).a)),R=R.add(P(c).multiply(this._getColor(T(c,z,k,M),D).a)),R=R.add(P(y).multiply(this._getColor(T(y,z,k,M),D).a)),R=R.add(P(v).multiply(this._getColor(T(v,z,k,M),D).a)),R=R.add(P(S).multiply(this._getColor(T(S,z,k,M),D).a)),R=R.add(P(b).multiply(this._getColor(T(b,z,k,M),D).a)),R=R.add(P(_).multiply(this._getColor(T(_,z,k,M),D).a)),R=R.add(P(V).multiply(this._getColor(T(V,z,k,M),D).a)),g(R,new r(.05)).multiply(N(this.hittestRequest))}}t([e(0,o(R)),e(1,o(F))],U.prototype,"vertex",null),t([e(0,o(j))],U.prototype,"fragment",null);export{j as AnimatedMarkerFragmentInput,U as AnimatedMarkerShader,R as AnimatedMarkerVertexInput};
