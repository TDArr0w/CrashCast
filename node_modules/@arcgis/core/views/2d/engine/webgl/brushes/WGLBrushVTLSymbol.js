/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{create as e,fromValues as t}from"../../../../../core/libs/gl-matrix-2/factories/vec2f32.js";import{fadeDuration as i}from"../../vectorTiles/decluttering/config.js";import{vtlTextureBindingUnitSprites as a,vtlTextureBindingUnitGlyphs as r}from"../definitions.js";import{degToByte as n}from"../GeometryUtils.js";import s from"./WGLBrush.js";import{PrimitiveType as o,DataType as l}from"../../../../webgl/enums.js";const f=1/65536;class c extends s{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=e()}dispose(){}drawMany(e,t){const i=e.styleLayer;this._drawIcons(e,i,t),this._drawText(e,i,t)}_drawIcons(e,t,r){const{context:s,displayLevel:o,painter:l,spriteMosaic:f,state:c,styleLayerUID:u,requestRender:p,allowDelayedRender:m}=e,g=t.iconMaterial,d=l.vectorTilesMaterialManager;let y,_=!1;for(const i of r)if(i.layerData.has(u)&&(y=i.layerData.get(u),y.iconPerPageElementsMap.size>0)){_=!0;break}if(!_)return;const h=t.getPaintValue("icon-translate",o),M=t.getPaintValue("icon-translate-anchor",o);let U=t.getLayoutValue("icon-rotation-alignment",o);2===U&&(U=0===t.getLayoutValue("symbol-placement",o)?1:0);const x=0===U,P=t.getLayoutValue("icon-keep-upright",o)&&x,S=y.isIconSDF,E=this._iconProgramOptions;E.sdf=S;const v=d.getMaterialProgram(s,g,E);if(m&&null!=p&&!v.compiled)return void p();s.useProgram(v),v.setUniformMatrix3fv("u_displayViewMat3",0===U?c.displayViewMat3:c.displayMat3),v.setUniformMatrix3fv("u_displayMat3",1===M?c.displayMat3:c.displayViewMat3),v.setUniform2fv("u_iconTranslation",h),v.setUniform1f("u_depth",t.z),v.setUniform1f("u_mapRotation",n(c.rotation)),v.setUniform1f("u_keepUpright",P?1:0),v.setUniform1f("u_level",10*o),v.setUniform1i("u_texture",a),v.setUniform1f("u_fadeDuration",i/1e3),v.setUniform1i("u_isStencilPass",e.stencilSymbols?1:0);let D=-1;for(const i of r){if(!i.layerData.has(u))continue;if(i.key.level!==D&&(D=i.key.level,g.setDataUniforms(v,o,t,D,f)),y=i.layerData.get(u),0===y.iconPerPageElementsMap.size)continue;y.prepareForRendering(s),y.updateOpacityInfo();const a=y.iconVAO;if(null!=a){s.bindVAO(a),v.setUniformMatrix3fv("u_dvsMat3",i.transforms.displayViewScreenMat3),v.setUniform1f("u_time",(performance.now()-y.lastOpacityUpdate)/1e3);for(const[t,a]of y.iconPerPageElementsMap)this._renderIconRange(e,v,a,t,i)}}}_renderIconRange(e,t,i,r,n){const{context:s,spriteMosaic:f}=e;this._spritesTextureSize[0]=f.getWidth(r)/4,this._spritesTextureSize[1]=f.getHeight(r)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),f.bind(s,9729,r,a),this._setStencilState(e,n),s.drawElements(o.TRIANGLES,i[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),n.triangleCount+=i[1]/3}_drawText(e,a,s){const{context:o,displayLevel:l,glyphMosaic:c,painter:u,pixelRatio:p,spriteMosaic:m,state:g,styleLayerUID:d,requestRender:y,allowDelayedRender:_}=e,h=a.textMaterial,M=u.vectorTilesMaterialManager;let U,x=!1;for(const t of s)if(t.layerData.has(d)&&(U=t.layerData.get(d),U.glyphPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const P=a.getPaintProperty("text-opacity");if(P&&!P.isDataDriven&&0===P.getValue(l))return;const S=a.getPaintProperty("text-color"),E=!S||S.isDataDriven||S.getValue(l)[3]>0,v=a.getPaintProperty("text-halo-width"),D=a.getPaintProperty("text-halo-color"),T=(!v||v.isDataDriven||v.getValue(l)>0)&&(!D||D.isDataDriven||D.getValue(l)[3]>0);if(!E&&!T)return;const V=24/8;let w=a.getLayoutValue("text-rotation-alignment",l);2===w&&(w=0===a.getLayoutValue("symbol-placement",l)?1:0);const R=0===w,I=a.getLayoutValue("text-keep-upright",l)&&R,L=.8*V/p;this._glyphTextureSize||(this._glyphTextureSize=t(c.width/4,c.height/4));const z=a.getPaintValue("text-translate",l),N=a.getPaintValue("text-translate-anchor",l),b=this._sdfProgramOptions,k=M.getMaterialProgram(o,h,b);if(_&&null!=y&&!k.compiled)return void y();o.useProgram(k),k.setUniformMatrix3fv("u_displayViewMat3",0===w?g.displayViewMat3:g.displayMat3),k.setUniformMatrix3fv("u_displayMat3",1===N?g.displayMat3:g.displayViewMat3),k.setUniform2fv("u_textTranslation",z),k.setUniform1f("u_depth",a.z+f),k.setUniform2fv("u_mosaicSize",this._glyphTextureSize),k.setUniform1f("u_mapRotation",n(g.rotation)),k.setUniform1f("u_keepUpright",I?1:0),k.setUniform1f("u_level",10*l),k.setUniform1i("u_texture",r),k.setUniform1f("u_antialiasingWidth",L),k.setUniform1f("u_fadeDuration",i/1e3);let O=-1;for(const t of s){if(!t.layerData.has(d))continue;if(t.key.level!==O&&(O=t.key.level,h.setDataUniforms(k,l,a,O,m)),U=t.layerData.get(d),0===U.glyphPerPageElementsMap.size)continue;U.prepareForRendering(o),U.updateOpacityInfo();const i=U.textVAO;if(null==i)continue;o.bindVAO(i),k.setUniformMatrix3fv("u_dvsMat3",t.transforms.displayViewScreenMat3),this._setStencilState(e,t);const r=(performance.now()-U.lastOpacityUpdate)/1e3;k.setUniform1f("u_time",r),U.glyphPerPageElementsMap.forEach((e,i)=>{this._renderGlyphRange(o,e,i,c,k,T,E,t)})}}_renderGlyphRange(e,t,i,a,n,s,f,c){a.bind(e,9729,i,r),s&&(n.setUniform1f("u_halo",1),e.drawElements(o.TRIANGLES,t[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),c.triangleCount+=t[1]/3),f&&(n.setUniform1f("u_halo",0),e.drawElements(o.TRIANGLES,t[1],l.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),c.triangleCount+=t[1]/3)}_setStencilState(e,t){const{context:i,is3D:a,stencilSymbols:r}=e;if(i.setStencilTestEnabled(!0),r)return i.setStencilWriteMask(255),void i.setStencilFunction(519,t.stencilRef,255);i.setStencilWriteMask(0),a?i.setStencilFunction(514,t.stencilRef,255):i.setStencilFunction(516,255,255)}}export{c as WGLBrushVTLSymbol};
