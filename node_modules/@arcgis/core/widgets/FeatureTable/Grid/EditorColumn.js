/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import{on as e,sync as o}from"../../../core/reactiveUtils.js";import{property as n}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import l from"./Column.js";import{autoLink as r}from"../../support/uriUtils.js";const a={showInput:"Enter",cancelEdit:"Escape"},s=Symbol();let c=class extends l{constructor(t){super(t),this.editInfo=null,this.cellValueValidatorFunction=({oldValue:t,value:e})=>t!==e,this.editable=!0,this.headerRenderFunction=t=>{const{root:e}=t,o=this.createHeaderContent();this.tableEditingEnabled&&!this.effectiveEditable&&o.prepend(this._lockIconNode),this.removeCellContent(e),e.appendChild(o)},this.inputRenderFunction=({root:t,column:e,rowData:o})=>{if(this.editInfo||!this.effectiveEditable||!o)return;const n=this.getCellValue(o),i=this.createInputElement({value:n});this._set("editInfo",{column:e,inputs:[i],root:t,rowData:o,oldValue:n});const l=document.createElement("div");l.appendChild(i),this.removeCellContent(t),t.appendChild(l),i.focus(),i instanceof HTMLInputElement&&i.select()},this.loadingMessage="",this.inputType="text",this.maxLength=null,this.onShowPromptCallback=()=>{},this.parseInputValueFunction=({inputs:t})=>t?.length||1!==t.length||Array.isArray(t[0].value)?null:t[0].value,this.renderFunction=t=>{const{root:e,rowData:o}=t,{editInfo:n}=this;if(n)return;const i=this.getCellValue(o),l=this.cellValueFormatFunction({root:e,rowData:o,value:i});let s=null;e.onclick=()=>e.focus(),e.ondblclick=()=>this.inputRenderFunction(t),e.ontouchend=()=>this.inputRenderFunction(t);const c=this.grid?.getSlotElementByName(e.slot),u=c?.parentElement;u&&!u.onkeydown&&(u.onkeydown=e=>{e.key!==a.showInput||this.editInfo||this.inputRenderFunction(t),e.key===a.cancelEdit&&this.editInfo&&this.cancel()}),null!=i&&null!=l?e.title=l.toString():e.title&&e.removeAttribute("title"),s=l instanceof HTMLElement?l:r(this.messagesURIUtils,l),this.removeCellContent(e),s instanceof HTMLElement?e.appendChild(s):null!=s&&(e.innerHTML=s.toString())},this.required=!1,this.tableEditingEnabled=!1}get _lockIconNode(){return this.createCalciteIcon({icon:"lock",textLabel:this.messages?.editingPreventedColumn})}get effectiveEditable(){return this.tableEditingEnabled&&this.editable}get effectiveRequired(){return this.required}get editing(){return!!this.editInfo}get shouldShowPrompt(){return!1}cancel(){this.onEditComplete()}createCalciteOption(t,e,o=!1){const n=document.createElement("calcite-option");return n.label=t,n.value=`${e}`,n.selected=o,n}createCalciteSelect(t,e){const{effectiveRequired:o,messages:n}=this;let i=!1;const l=e.map(({name:e,value:o})=>{const n=o===t;return n&&(i=!0),this.createCalciteOption(e,o,n)});if(null!=t&&""!==t&&!i){const e=t.toString(),o=this.createCalciteOption(e,e);l.unshift(o)}o||l.unshift(this.createCalciteOption(`<${n?.noValue}>`,""));const r=document.createElement("calcite-select");return l.forEach(t=>r.appendChild(t)),r}createInputElement({value:t}){const{effectiveRequired:n,maxLength:i}=this,l=document.createElement("calcite-input");return null!=i&&(l.maxLength=i),l.required=n,l.value=null!=t?t.toString():"",this.addHandles([e(()=>l,"calciteInputChange",()=>this.onInputBlur(),o),e(()=>l,"keydown",t=>{t.key===a.cancelEdit&&this.onInputBlur(!0)},o),e(()=>l,"blur",()=>this.onInputBlur(),o)],s),l}createDateComponent(){const t=document.createElement("calcite-input-date-picker");return t.focusTrapDisabled=!0,t.overlayPositioning="fixed",t}createTimeComponent(){const t=document.createElement("calcite-input-time-picker");return t.overlayPositioning="fixed",t.placement="auto-start",t.step=1,t}createTimeZoneComponent(){const t=document.createElement("calcite-input-time-zone");return t.maxItems=4,t.overlayPositioning="fixed",t}onEditComplete(){this._set("editInfo",null),this.grid?.generateCellPartNames(),this.grid?.requestContentUpdate()}onInputBlur(t=!1){this.removeHandles(s),t?this.cancel():this.submit()}async submit(){const{editInfo:t}=this;if(!t)return void this.cancel();const{inputs:e,rowData:o,oldValue:n}=t,i=this.parseInputValueFunction({inputs:e});if(!this.cellValueValidatorFunction({value:i,oldValue:n}))return void this.cancel();const{root:l}=t,r=o.item.objectId,{fieldName:a}=this;l.textContent=this.loadingMessage,this.shouldShowPrompt?this.onShowPromptCallback({column:this,objectId:r,oldValue:n,value:i}):await this.updateItems({objectId:r,updates:[{fieldName:a,value:i}]})}async updateItems(t){const{store:e}=this;if(e)try{await e.updateItem(t),this.onEditComplete()}catch{this.cancel()}else this.cancel()}};t([n()],c.prototype,"_lockIconNode",null),t([n({readOnly:!0})],c.prototype,"editInfo",void 0),t([n()],c.prototype,"cellValueValidatorFunction",void 0),t([n()],c.prototype,"editable",void 0),t([n()],c.prototype,"effectiveEditable",null),t([n()],c.prototype,"effectiveRequired",null),t([n()],c.prototype,"editing",null),t([n()],c.prototype,"headerRenderFunction",void 0),t([n()],c.prototype,"inputRenderFunction",void 0),t([n({constructOnly:!0})],c.prototype,"loadingMessage",void 0),t([n()],c.prototype,"inputType",void 0),t([n()],c.prototype,"maxLength",void 0),t([n()],c.prototype,"onShowPromptCallback",void 0),t([n()],c.prototype,"parseInputValueFunction",void 0),t([n()],c.prototype,"renderFunction",void 0),t([n()],c.prototype,"required",void 0),t([n()],c.prototype,"shouldShowPrompt",null),t([n()],c.prototype,"tableEditingEnabled",void 0),c=t([i("esri.widgets.FeatureTable.Grid.EditorColumn")],c);const u=c;export{u as default};
