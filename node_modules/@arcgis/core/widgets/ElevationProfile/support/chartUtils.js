/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import*as t from"@amcharts/amcharts5/index.js";import{XYChart as i,ValueAxis as e,AxisRendererX as o,AxisRendererY as n,XYCursor as s,LineSeries as a}from"@amcharts/amcharts5/xy.js";import l from"@amcharts/amcharts5/themes/Dark.js";import r from"@amcharts/amcharts5/themes/Responsive.js";import"../../../intl.js";import{handlesGroup as d,makeHandle as c}from"../../../core/handleUtils.js";import"../../../core/has.js";import{throwIfAborted as p}from"../../../core/promiseUtils.js";import{signal as m}from"../../../core/signal.js";import{unitName as u,formatDecimal as x}from"../../../core/unitFormatUtils.js";import{convertUnit as f}from"../../../core/unitUtils.js";import{getEpsilon as g}from"../../../core/libs/gl-matrix-2/math/common.js";import{getConfig as h,notAvailable as A}from"./constants.js";import{getTranslatedLineTitle as v}from"./intlUtils.js";import{niceScale as b}from"./niceScale.js";import{binaryFindClosest as y}from"./profileUtils.js";import{createRoot as T}from"../../support/chartUtilsAm5.js";import{isRTL as L}from"../../support/widgetUtils.js";import{isDarkMode as M}from"../../../support/modeUtils.js";import{formatNumber as F}from"../../../intl/number.js";import{substitute as S}from"../../../intl/substitute.js";const P="#f8f8f8",X="#a9a9a9",Y="#323232",z="line",k="fill",C=15,j=12,w=.001,H=.1,B=.02,U={fontFamily:"Avenir Next",paddingBottom:j/2,paddingLeft:0,paddingRight:0,paddingTop:0,axisGridStroke:"#f4f4f4",axisLabelsFontSize:9,axisLabelsFontWeight:"400",axisLabelsColor:X,axisTooltipFontSize:12,axisTooltipBackgroundColor:Y,axisTooltipLabelColor:P,axisTooltipPaddingTop:Math.round(j/4),axisTooltipPaddingBottom:Math.round(j/4),axisTooltipPaddingHorizontal:Math.round(C/4),xAxisMinGridDistance:50,xAxisLabelsSpacing:Math.round(j/2),xAxisMinLabelPosition:.05,xAxisMaxLabelPosition:.9,yAxisMinGridDistance:30,yAxisLabelSpacing:Math.round(C/4),yAxisMinLabelPosition:0,yAxisMaxLabelPosition:.8,seriesTooltipFontSize:12,seriesTooltipBackgroundColor:P,seriesTooltipLabelColor:Y,seriesFillLighten:.9,seriesTooltipSpacing:j/2,seriesTooltipPaddingVertical:Math.round(C/4),seriesTooltipPaddingHorizontal:Math.round(C/4)},D={...U,axisGridStroke:Y,axisLabelsColor:X,axisTooltipBackgroundColor:Y,axisTooltipLabelColor:P,seriesTooltipBackgroundColor:Y,seriesTooltipLabelColor:P,seriesFillLighten:-.75},R={minX:void 0,maxX:void 0,minY:void 0,maxY:void 0};async function O(t){const s=await T(t.container);p(t.abortOptions);const a=M(t.container),c=a?D:U;s.setThemes(a?[r.new(s),l.new(s)]:[r.new(s)]);const u=L(t.container),x=s.container.children.push(i.new(s,{panX:!0,panY:!0,paddingTop:c.paddingTop,paddingBottom:c.paddingBottom,paddingLeft:u?c.paddingRight:c.paddingLeft,paddingRight:u?c.paddingLeft:c.paddingRight,maxTooltipDistance:-1}));x.zoomOutButton.set("forceHidden",!0);const f=x.xAxes.push(e.new(s,{renderer:o.new(s,{})})),g=x.yAxes.push(e.new(s,{renderer:n.new(s,{})})),h=m(null),A=m("loading"),v={chart:x,xAxis:f,yAxis:g,seriesInfos:new Map,messages:null,theme:c,pointerIsOver:!1,rtl:u,get state(){return A.value},get data(){return h.value},set data(t){h.value=t}};E(v),I(v),G(v);const b=d([et(v,t.onRangeChange),nt(v,t.onCursorPositionChange),gt(s.events.once("frameended",()=>{A.value="ready"})),gt(s)]);let y;return{destroy:()=>{b.remove(),A.value="destroyed"},update:t=>{t.data===v.data&&t.messages===v.messages||W(v)||V(v,t)},zoomOut:()=>$(v),test:y}}function W(t){return"destroyed"===t.state}function G({chart:t,xAxis:i,yAxis:e}){const o=s.new(t.root,{behavior:"none",xAxis:i,yAxis:e,snapToSeriesBy:"y"});o.lineY.set("visible",!1),t.set("cursor",o)}function E(i){const{chart:e,xAxis:o,theme:n}=i;o.setAll({extraMax:0,extraMin:0,maxDeviation:0,numberFormatter:pt(i,"distance"),strictMinMax:!0,strictMinMaxSelection:!0}),o.axisHeader.set("forceHidden",!0);const s=o.get("renderer");s.setAll({inside:!1,minGridDistance:n.xAxisMinGridDistance}),s.labels.template.setAll({centerX:t.p0,centerY:t.p0,fill:t.color(n.axisLabelsColor),fontFamily:n.fontFamily,fontSize:n.axisLabelsFontSize,fontWeight:n.axisLabelsFontWeight,maxPosition:n.xAxisMaxLabelPosition,minPosition:n.xAxisMinLabelPosition,paddingLeft:0,paddingRight:0,paddingTop:n.xAxisLabelsSpacing});const a=o.set("tooltip",t.Tooltip.new(e.root,{paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0}));a.get("background")?.setAll({fill:t.color(n.axisTooltipBackgroundColor),stroke:void 0}),a.label.setAll({fill:t.color(n.axisTooltipLabelColor),fontFamily:n.fontFamily,fontSize:n.axisTooltipFontSize,paddingBottom:n.axisTooltipPaddingBottom,paddingLeft:n.axisTooltipPaddingHorizontal,paddingRight:n.axisTooltipPaddingHorizontal,paddingTop:n.axisTooltipPaddingTop,direction:i.rtl?"rtl":"ltr"}),s.grid.template.setAll({strokeOpacity:1,stroke:t.color(n.axisGridStroke)})}function I(i){const{yAxis:e,theme:o,rtl:n}=i;e.setAll({baseValue:h().noDataValue,extraMax:0,extraMin:0,maxDeviation:0,numberFormatter:pt(i,"elevation"),strictMinMax:!0,strictMinMaxSelection:!0,tooltip:void 0}),e.axisHeader.set("visible",!1);const s=e.get("renderer");s.setAll({minGridDistance:o.yAxisMinGridDistance,opposite:n,inside:!0}),s.labels.template.setAll({centerX:t.p0,centerY:t.p100,fill:t.color(o.axisLabelsColor),fontFamily:o.fontFamily,fontSize:o.axisLabelsFontSize,fontWeight:o.axisLabelsFontWeight,maxPosition:o.yAxisMaxLabelPosition,minPosition:o.yAxisMinLabelPosition,paddingBottom:0,paddingLeft:n?0:o.yAxisLabelSpacing,paddingRight:n?o.yAxisLabelSpacing:0,paddingTop:0,textAlign:"start"}),s.grid.template.setAll({strokeOpacity:1,stroke:t.color(o.axisGridStroke)})}function V(t,i){if(W(t))return;const e=t.data??void 0,o=i.data??void 0;t.chart.get("cursor")?.set("forceHidden",!o?.refined);const n=e!==o,s=e?.effectiveUnits!==o?.effectiveUnits,a=e?.uniformScaling!==o?.uniformScaling;t.data=o,t.messages=i.messages,(n||s)&&(N(t),K(t)),a&&$(t),at(t)}function $(t){W(t)||(t.xAxis.zoom(0,1),t.yAxis.zoom(0,1))}function N(t){const{chart:i,data:e,xAxis:o,yAxis:n}=t,{minX:s,maxX:a,minY:l,maxY:r}=Z({data:e,pixelWidth:o.width(),pixelHeight:n.height()}),d=!!e?.uniformScaling,c=!!e?.refined;i.setAll({panX:!0,panY:d,pinchZoomX:c,pinchZoomY:c&&d,wheelX:"panX",wheelY:c?d?"zoomXY":"zoomX":"none"}),o.setAll({max:a,min:s,panX:!0,panY:!1,zoomX:!0,zoomY:d}),n.setAll({max:r,min:l,panX:!1,panY:d,zoomX:d,zoomY:d})}function Z({data:t,pixelWidth:i,pixelHeight:e}){if(null==t)return R;const o=t.statistics,n=0,s=o?.maxDistance;let a=o?.minElevation,l=o?.maxElevation;if(null==s||null==a||null==l)return R;const r=Math.max(s-n,w);let d=Math.max(l-a,w);const c=t.effectiveUnits;if(t.dynamicElevationRange){const t=f(r,c.distance,c.elevation);d=Math.max(d,t/h().maxChartRatio)}return a-=B*d,l=a+d+H*d,[a,l]=b(a,l,10),d=l-a,t.uniformScaling?q({data:t,bounds:{minX:n,maxX:s,minY:a,maxY:l},pixelWidth:i,pixelHeight:e,centered:!0}):{minX:n,maxX:n+r,minY:a,maxY:a+d}}function q({data:t,bounds:i,pixelWidth:e,pixelHeight:o,centered:n}){if(null==t)return i;let{minX:s,maxX:a,minY:l,maxY:r}=i;if(null==s||null==a||null==l||null==r)return R;const d=a-s,c=r-l,p=t.effectiveUnits,m=f(c,p.elevation,p.distance)/o/(d/e);return m>=1?[s,a]=J([s,a],m):[l,r]=J([l,r],1/m),{minX:s,maxX:a,minY:l,maxY:r}}function J([t,i],e,o){const n=(i-t)*e;{const e=(t+i)/2-n/2;return[e,e+n]}}function K(t){const{chart:i,data:e,seriesInfos:o,xAxis:n,yAxis:s}=t;if(null==e||0===e.lines.length)return void i.series.clear();const a=new Map,l=new Set(i.series.values),r=e.lines.length;for(let d=0;d<r;d++){const n=e.lines[d];let s=o.get(n.id);s?(s.fill&&l.delete(s.fill),l.delete(s.line)):(s=_(t,n),s.fill&&i.series.push(s.fill),i.series.push(s.line)),a.set(s.id,s);const c=r-d-1;s.fill?.set("layer",c),s.line.set("layer",r+c),Q(t,s,n)}t.seriesInfos=a;for(const d of l)i.series.removeValue(d);n.set("layer",r+1),s.set("layer",r+2)}function Q({theme:i},e,o){const n=t.color(o.color.toCss()),s=o.samples??[],a=s.length>0,{line:l,fill:r}=e;l.set("visible",a),l.set("stroke",n),r?.set("visible",a),r?.set("fill",t.Color.lighten(n,i.seriesFillLighten)),l.data.setAll(s),r?.data.setAll(s)}function _(t,i){const{id:e}=i,o=tt(t,`${z}-${e}`),n=it(t);o.setAll({dy:i.chartStrokeOffsetY,tooltip:n}),o.strokes.template.setAll({strokeWidth:i.chartStrokeWidth});let s=null;return i.chartFillEnabled&&(s=tt(t,`${k}-${e}`),s.fills.template.setAll({fillOpacity:1,visible:!0})),{id:e,line:o,fill:s}}function tt(t,i){return a.new(t.chart.root,{connect:!1,excludeFromTotal:!0,fill:void 0,id:i,stroke:void 0,valueXField:"distance",valueYField:"elevation",xAxis:t.xAxis,yAxis:t.yAxis})}function it({theme:i,chart:e,rtl:o}){const n=t.Tooltip.new(e.root,{autoTextColor:!1,forceHidden:!0,getFillFromSprite:!1,getLabelFillFromSprite:!1,pointerOrientation:"vertical",visible:!1}),s=i.seriesTooltipPaddingHorizontal,a=i.seriesTooltipPaddingVertical;return n.label.setAll({fill:t.color(i.seriesTooltipLabelColor),fontFamily:i.fontFamily,fontSize:i.seriesTooltipFontSize,paddingBottom:a,paddingLeft:s,paddingRight:s,paddingTop:a,textAlign:o?"end":"start",direction:"ltr"}),n.get("background")?.setAll({stroke:void 0,fill:t.color(i.seriesTooltipBackgroundColor)}),n.adapters.add("dy",t=>{const e=i.seriesTooltipSpacing,o=n.get("pointTo")?.y??0;return(t??0)+(n.y()>o?e:-e)}),n}function et(t,i){const{xAxis:e,yAxis:o}=t,n=()=>{i(ot(e),ot(o))},s=t=>[t.on("start",n),t.on("end",n)];return ft([...s(e),...s(o)])}function ot(t){const i=Math.abs((t.get("end")??0)-(t.get("start")??0)),e=0!==i?1/i:1;return Math.abs(1-e)<g()?1:e}function nt(t,i){const{chart:e,xAxis:o,yAxis:n}=t,s=e.get("cursor"),a=e.plotContainer.events,l=i=>{t.pointerIsOver=i,at(t)},r=()=>{l(!1),i(null,null)};return ft([s?.events.on("cursormoved",()=>{if(!t.pointerIsOver)return;at(t);let e=s?.getPrivate("positionX")??0,a=s?.getPrivate("positionY")??0;const l=t.data;if(null!=l?.statistics){const{maxDistance:t,minElevation:i,maxElevation:s}=l.statistics;let r,d;if(null!=t){1===ot(o)?(r=0,d=t):(r=ut(o),d=xt(o)),e=st(e,r,d,0,t)}if(null!=i&&null!=s){1===ot(n)?(r=i,d=s):(r=ut(n),d=xt(n)),a=st(a,r,d,i,s)}}i(e,a)}),a.on("pointerover",()=>l(!0)),a.on("pointerout",r),a.on("blur",r)])}function st(t,i,e,o,n){return(i+t*(e-i)-o)/(n-o)}function at(t){const i=lt(t);if(!i)return void t.seriesInfos.forEach(t=>{t.line.get("tooltip")?.set("forceHidden",!0)});t.seriesInfos.forEach(t=>{const e=t.line.get("tooltip");e.set("forceHidden",!1),e.label.set("text",i)});t.xAxis.getTooltip().setAll({tooltipText:ct(t)})}function lt(t){const{data:i}=t,e=i?.lines.map(i=>({line:i,y:mt(t,i)?.elevation})).sort(rt);return e&&0!==e.length&&null!=e[0].y?e.map(({y:i,line:e})=>dt(t,e,i)).join("\n"):null}function rt({y:t},{y:i}){return null==t?1:null==i?-1:i-t}function dt(t,i,e){const{data:o,messages:n}=t;if(null==o||null==n)return"";const s=`[${i.color.toHex()}]●[/]`,a="  ",l=h().formatPrecision,r=S(n.chartTooltip,{name:v(i,n),elevation:null!=e?x(n,e,o.effectiveUnits.elevation,l):A});return t.rtl?r+a+s:s+a+r}function ct(t){const{data:i,messages:e}=t;if(null==i||null==e)return"";const o=i.lines[0],n=o?mt(t,o):null,s=h().formatPrecision;return null!=n?x(e,n.distance,i.effectiveUnits.distance,s):"-"}function pt(i,e){const o=t.NumberFormatter.new(i.chart.root,{});return o.format=(t,o,n)=>{const{data:s,messages:a}=i;if(null==a||null==s||"string"==typeof t)return"";return`${F(t,{maximumFractionDigits:n})} ${u(a,s.effectiveUnits[e],"abbr")}`},o}function mt({chart:t,xAxis:i},e){const o=e.samples??[];if(0===o.length)return null;const n=t.get("cursor"),s=n?.getPrivate("positionX")??0,a=i.toAxisPosition(s),l=i.positionToValue(a);return y(o,l,t=>t.distance)}function ut(t){return t.positionToValue(t.get("start")??0)}function xt(t){return t.positionToValue(t.get("end")??1)}function ft(t){return d(t.map(gt))}function gt(t){return c(()=>{t?.dispose()})}export{O as createChart,Z as getAdjustedBounds};
