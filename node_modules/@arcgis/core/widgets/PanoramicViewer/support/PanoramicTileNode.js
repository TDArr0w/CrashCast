/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../../core/Error.js";import{throwIfAborted as t}from"../../../core/promiseUtils.js";import i from"../../../geometry/Mesh.js";import s from"../../../geometry/SpatialReference.js";import a from"../../../geometry/support/MeshMaterial.js";import r from"../../../geometry/support/MeshTexture.js";import{loadMeshDependencies as o}from"./importUtils.js";class c{constructor(i,c,l,n,h,m,w,u,p){this.level=i,this.row=c,this.column=l,this.horizontalFieldOfView=n,this.verticalFieldOfView=h,this.yaw=m,this.pitch=w,this.distance=u,this.getPixelBlock=p,this._cache=null,this.loadMesh=async i=>{const{level:c,row:l,column:n,horizontalFieldOfView:h,verticalFieldOfView:m,yaw:w,pitch:u,distance:p}=this,{Mesh:f,MeshComponent:d,MeshVertexAttributes:v,panoramicMeshManager:g}=await o(),{faces:M,...x}=await g.getFacesWithVertexAttributes({distance:p,yaw:w,horizontalFieldOfView:h,pitch:u,verticalFieldOfView:m});t(i);const y=await this.getPixelBlock(c,l,n,i);if(t(i),!y)throw new e("panoramic-viewer:missing-tile-data",`Tile data for level ${c}, row ${l}, column ${n} is missing`,{level:c,row:l,column:n});const V=await g.convertPixelBlockToImageData(y);t(i);const F=new f({vertexAttributes:new v(x),components:[new d({faces:M,trustSourceNormals:!0,material:new a({colorTexture:new r({data:V})})})],spatialReference:s.WebMercator});return await F.load(i),this._cache=F,this._cache},this.loadMeshAtDistance=async(e,t)=>{const i=this.distance;return this.distance=e,Math.abs(i-e)>1e-6&&this._cache?this._cache:await this.loadMesh(t)}}get loaded(){return null!==this._cache}get key(){return`${this.level}/${this.row}/${this.column}`}clone(){const{level:e,row:t,column:s,horizontalFieldOfView:a,verticalFieldOfView:r,yaw:o,pitch:l,distance:n,getPixelBlock:h}=this,m=new c(e,t,s,a,r,o,l,n,h);if(this._cache){const{vertexAttributes:e,components:t,spatialReference:s}=this._cache,a=t?.map(({material:e,faces:t,trustSourceNormals:i})=>({material:e,faces:t?.slice(),trustSourceNormals:i}));m._cache=new i({components:a,vertexAttributes:e.clone(),spatialReference:s})}return m}}export{c as default};
