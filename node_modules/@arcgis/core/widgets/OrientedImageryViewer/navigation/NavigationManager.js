/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import r from"../../../core/Accessor.js";import{throwIfAborted as t}from"../../../core/promiseUtils.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import s from"../../../geometry/Point.js";import{polygonCentroidPoint as n}from"../../../geometry/support/centroid.js";import{createCoveragePolygon as a}from"../../../layers/orientedImagery/core/coverageUtils.js";import l from"../../../layers/orientedImagery/core/ExposurePoint.js";import{InvalidDirectionError as c,FeatureSectorNotFoundError as d}from"./errors.js";import{queryNextLocationFeatures as u,querySequenceCount as g,queryAfterSequenceField as p,querySequenceFeaturesAroundPoint as w,queryOffsetSequenceFeatures as f}from"./queries.js";let h=class extends r{constructor(e){super(e),this.viewModel=null}get currentNode(){return this.viewModel.currentNode}get layer(){return this.viewModel.layer}get navigationNodes(){return this.viewModel.navigationNodes}async _queryAndHandleFeatureResponse(e,r,o,i){const{error:s,nextLocation:n,response:a}=await u(e,r,o,i);if(t(i),s)throw s;this.viewModel.selectedPoint=n,await this.viewModel.processFeatureResponse(a,n,{signal:i?.signal,loadBestImage:!1})}async afterNavigate(e,r,t){return await this.viewModel.selectBestFeature(r.id,t),r}async navigate(e,r){let t;if("direction"in r?t=await this.navigateInDirection(e,r):("step"in r||"goTo"in r)&&(t=await this.navigateInSequence(e,r)),!t)throw new Error("No next node found");return await this.afterNavigate(e,t,r)}async navigateBySkippingSteps(e,r){const{step:t}=r,{layer:o}=this,{floorFilterClause:i}=this.viewModel;if(!o)throw new Error("Layer is not defined");const c=e.attributes.sequenceOrder;if(0===await g(o,i,{signal:r.signal})||!c)throw new Error("No sequence found");const{response:d,error:u}=await p(o,c,t,1,i,{signal:r.signal});if(u)throw new Error("Error querying sequence features");const f=d?.features[0];if(!f)throw new Error("No next node found");const h=l.fromJSON({...f.toJSON(),layer:o}),{polygon:v}=a(h),y=s.fromJSON(n(v)),{response:m,error:N,nextLocation:M}=await w(o,y,i,{signal:r.signal});if(N)throw new Error("Error querying sequence features");const S=[...m.features];S.push(f),m.features=S,this.viewModel.selectedPoint=M;const E=f.attributes.objectId;return await this.viewModel.processFeatureResponse(m,M,{signal:r.signal,loadBestImage:!1}),this.viewModel.selectedPoint=M,this.viewModel.navigationNodes.find(e=>e.id===E)}async navigateInDirection(e,r){const{viewModel:t}=this,{layer:o,floorFilterClause:i}=t,{direction:s,signal:n}=r,a=e?.[s];if(!a)throw new c(s);const l=t.getFeatureSectorById(a.id);if(!l)throw new d(a);const[u,g]=l.split("_"),p=g??u,w=`NEAR_${p}`,f=`FAR_${p}`,h=t.getActiveSectors();return v(l,h.includes(w),h.includes(f),p,w,f)&&await this._queryAndHandleFeatureResponse(o,a,i,{signal:n}),a}async navigateInSequence(e,r){return"step"in r?this.navigateBySkippingSteps(e,r):this.navigateTo(r)}async navigateTo(e){const{goTo:r}=e,{layer:t}=this,{floorFilterClause:o}=this.viewModel;if(!t)throw new Error("Layer is not defined");const i="number"==typeof r?r:1,c=this.viewModel.navigationNodes.find(e=>e.id===i);if(c)return c;const{response:d,error:u}=await f(t,i,1,"end"===r?"DESC":"ASC",o,{signal:e.signal});if(u)throw new Error("Error querying sequence features");const g=d?.features[0];if(!g)throw new Error("No next node found");const p=l.fromJSON({...g.toJSON(),layer:t}),{polygon:h}=a(p),v=s.fromJSON(n(h)),{response:y,error:m,nextLocation:N}=await w(t,v,o,{signal:e.signal});if(m)throw new Error("Error querying sequence features");const M=[...y.features];M.push(g),y.features=M,this.viewModel.selectedPoint=N;const S=g.attributes.objectId;return await this.viewModel.processFeatureResponse(y,N,{signal:e.signal,loadBestImage:!1}),this.viewModel.selectedPoint=N,this.viewModel.navigationNodes.find(e=>e.id===S)}};function v(e,r,t,o,i,s){return e===s||e===i&&!t||e===o&&!r&&!t}e([o()],h.prototype,"currentNode",null),e([o()],h.prototype,"layer",null),e([o()],h.prototype,"navigationNodes",null),e([o({constructOnly:!0})],h.prototype,"viewModel",void 0),h=e([i("esri.widgets.OrientedImageryViewer.navigation.NavigationManager")],h);export{h as default};
