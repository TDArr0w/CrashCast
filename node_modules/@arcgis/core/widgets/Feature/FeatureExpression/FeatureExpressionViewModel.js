/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import e from"../../../Graphic.js";import o from"../../../core/Accessor.js";import{createTask as i}from"../../../core/asyncUtils.js";import{abortMaybe as s}from"../../../core/maybe.js";import{throwIfAborted as n}from"../../../core/promiseUtils.js";import{watch as r,when as a,initial as l}from"../../../core/reactiveUtils.js";import{throttle as p}from"../../../core/throttle.js";import{property as c}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as m}from"../../../core/accessorSupport/decorators/subclass.js";import h from"../../../geometry/Point.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import u from"../../../popup/content/FieldsContent.js";import d from"../../../popup/content/MediaContent.js";import"../../../popup/content/RelationshipContent.js";import f from"../../../popup/content/TextContent.js";import"../../../popup/content/UtilityNetworkAssociationsContent.js";import v from"../../../popup/ElementExpressionInfo.js";import _ from"../FeatureContent/FeatureContentViewModel.js";import y from"../FeatureFields/FeatureFieldsViewModel.js";import w from"../FeatureMedia/FeatureMediaViewModel.js";import{compileExpression as T}from"../support/arcadeFeatureUtils.js";const j=1;let k=class extends o{constructor(t){super(t),this._compileTask=null,this._evaluateTask=null,this.expressionInfo=null,this.graphic=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._createVM=()=>{const t=this.contentElement?.type;this.contentElementViewModel?.destroy();const e="fields"===t?new y:"media"===t?new w:"text"===t?new _:null;this._set("contentElementViewModel",e)},this._compileThrottled=p(this._startCompile,()=>this.notifyChange("state"),j,this),this._evaluateThrottled=p(this._startEvaluate,()=>this.notifyChange("state"),j,this),this.addHandles([r(()=>[this.expressionInfo,this.graphic],()=>this._compileThrottled(),l),r(()=>[this.contentElement],()=>this._createVM(),l),a(()=>{if(!this._compileTask?.finished)return null;const t=this._compileTask.value,e=t?.dependencies;return[t,this.spatialReference,this.map,this.view,e?.has("view-scale")?this.view?.scale:null,e?.has("view-time-extent")?this.view?.timeExtent?.start:null,e?.has("view-time-extent")?this.view?.timeExtent?.end:null]},([t])=>this._evaluateThrottled(t))])}initialize(){this.addHandles([this._compileThrottled,this._evaluateThrottled])}destroy(){this._compileTask=s(this._compileTask),this._evaluateTask=s(this._evaluateTask),this.contentElementViewModel?.destroy(),this._set("contentElementViewModel",null)}get contentElement(){return this._evaluateTask?.value}get spatialReference(){return this.view?.spatialReference??null}set spatialReference(t){this._override("spatialReference",t)}get state(){const{contentElement:t,contentElementViewModel:e}=this;return this._compileThrottled.hasPendingUpdates()||this._evaluateThrottled.hasPendingUpdates()||!this._compileTask?.finished||!this._evaluateTask?.finished?"loading":t||e?"ready":"disabled"}get map(){return this.view?.map??null}set map(t){this._override("map",t)}_startCompile(){this._evaluateTask=s(this._evaluateTask),this._compileTask=s(this._compileTask),this._compileTask=i(async t=>{const{expressionInfo:e,graphic:o}=this,i=e?.expression;if(!i||!o)return null;const s=await T({expression:i,graphic:o});return n(t),s})}_startEvaluate(t){this._evaluateTask=s(this._evaluateTask),this._evaluateTask=i(async e=>{const{graphic:o}=this;if(!t||!o)return null;const{interceptor:i,spatialReference:s,map:r,location:a,view:l}=this,p=await t.evaluate({graphic:o,interceptor:i,location:a,map:r,options:{signal:e},spatialReference:s,view:l});n(e);const c=p;if(!c||"esri.arcade.Dictionary"!==c.declaredClass)return null;const m=await c.castAsJsonAsync(e);n(e);const h=m?.type,v="media"===h?d.fromJSON(m):"text"===h?f.fromJSON(m):"fields"===h?u.fromJSON(m):null;return"media"===v.type&&!v.mediaInfos||"fields"===v.type&&!v.fieldInfos||"text"===v.type&&!v.text?null:v})}};t([c()],k.prototype,"_compileTask",void 0),t([c()],k.prototype,"_evaluateTask",void 0),t([c({type:v})],k.prototype,"expressionInfo",void 0),t([c({type:e})],k.prototype,"graphic",void 0),t([c({readOnly:!0})],k.prototype,"contentElement",null),t([c({readOnly:!0})],k.prototype,"contentElementViewModel",void 0),t([c()],k.prototype,"interceptor",void 0),t([c({type:h})],k.prototype,"location",void 0),t([c()],k.prototype,"spatialReference",null),t([c({readOnly:!0})],k.prototype,"state",null),t([c()],k.prototype,"map",null),t([c()],k.prototype,"view",void 0),k=t([m("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],k);export{k as default};
