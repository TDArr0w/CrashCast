/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import"../../intl.js";import e from"../../PopupTemplate.js";import{deprecateUnnecessaryViewModel as o}from"../../core/deprecate.js";import r from"../../core/Error.js";import a from"../../core/Logger.js";import{isAbortError as i}from"../../core/promiseUtils.js";import{property as l}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import{removeSelectedFeature as c}from"../Popup/actions.js";import p from"../support/GeolocationPositioning.js";import{getCurrentPosition as n}from"../support/geolocationUtils.js";import{onLocaleChange as d}from"../../intl/locale.js";import{fetchMessageBundle as u}from"../../intl/messages.js";async function m(){const t=await u("esri/widgets/Locate/t9n/Locate");return new e({title:t.currentLocation,fieldInfos:[{fieldName:"timestamp",label:t.timestamp,format:{dateFormat:"short-date-short-time"}},{fieldName:"latitude",label:t.latitude,format:{places:4,digitSeparator:!0}},{fieldName:"longitude",label:t.longitude,format:{places:4,digitSeparator:!0}},{fieldName:"accuracy",label:t.accuracy,format:{places:0,digitSeparator:!0}},{fieldName:"altitude",label:t.altitude,format:{places:0,digitSeparator:!0}},{fieldName:"altitudeAccuracy",label:t.altitudeAccuracy,format:{places:0,digitSeparator:!0}},{fieldName:"heading",label:t.heading,format:{places:0,digitSeparator:!0}},{fieldName:"speed",label:t.speed,format:{places:0,digitSeparator:!0}}],actions:[c.clone()],content:[{type:"fields"}]})}let h=class extends p{constructor(t){super(t),this._locateController=null,this.error=void 0,this.popupEnabled=!0,this.locate=this.locate.bind(this),t?.isDefaultViewModel||o(a.getLogger(this),"LocateViewModel","arcgis-locate",{version:"4.34"})}initialize(){this.addHandles([d(()=>{const{graphic:t,view:e}=this;if(!t)return;const o=e?.graphics?.includes(t);o&&this._updatePopupTemplate(t)})])}destroy(){this.cancelLocate()}get state(){return this._geolocationUsable?this.view?.ready?this._locateController?"locating":null!=this.error?"error":"ready":"disabled":"feature-unsupported"}async locate(){if(this.cancelLocate(),"disabled"===this.state)throw new r("locate:disabled-state","Cannot locate when disabled.");if("feature-unsupported"===this.state)throw new r("locate:feature-unsupported-state","Cannot locate in unsecure domain.");const t=new AbortController;this._locateController=t,this.error=void 0;try{const e=await n(this.geolocationOptions);if(await this.updatePosition(e,t),this._locateController!==t)return null;const{graphic:o}=this;return o&&await this._updatePopupTemplate(o),this._addGraphic(),this.emit("locate",{position:e}),this._locateController=null,e}catch(e){if(i(e))return null;throw t===this._locateController&&(this._locateController=null),this.error=e,this.emit("locate-error",{error:e}),e}}cancelLocate(){this._clearGraphic(),this._locateController&&this._locateController.abort(),this._locateController=null}async _updatePopupTemplate(t){if(!this.popupEnabled)return;const e=await m(),o=t!==this.graphic;this.destroyed||o||(t.popupTemplate=e)}};t([l()],h.prototype,"_locateController",void 0),t([l()],h.prototype,"error",void 0),t([l()],h.prototype,"popupEnabled",void 0),t([l({readOnly:!0})],h.prototype,"state",null),t([l()],h.prototype,"locate",null),t([l()],h.prototype,"cancelLocate",null),h=t([s("esri.widgets.Locate.LocateViewModel")],h);const f=h;export{f as default};
