/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import"../intl.js";import"../core/has.js";import{destroyMaybe as t}from"../core/maybe.js";import{watch as i,syncAndInitial as o}from"../core/reactiveUtils.js";import{convertTime as s}from"../core/timeUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../core/Logger.js";import"../core/RandomLCG.js";import{subclass as r}from"../core/accessorSupport/decorators/subclass.js";import{substitute as n}from"../intl/substitute.js";import a from"./Slider.js";import d from"./Widget.js";import{css as c}from"./ShadowCast/css.js";import m from"./ShadowCast/ShadowCastViewModel.js";import p from"./ShadowCast/ShadowCastVisibleElements.js";import{DiscreteConfigurator as h}from"./ShadowCast/components/DiscreteConfigurator.js";import{DurationConfigurator as u}from"./ShadowCast/components/DurationConfigurator.js";import{ShadowTooltip as v}from"./ShadowCast/components/ShadowTooltip.js";import{ThresholdConfigurator as g}from"./ShadowCast/components/ThresholdConfigurator.js";import{loadCalciteComponents as w}from"./support/componentsUtils.js";import{globalCss as f}from"./support/globalCss.js";import{Heading as b}from"./support/Heading.js";import{onPrimaryTickCreated as C,onSecondaryTickCreated as y,formatSliderLabel as _,adjustTimeSliderForLocale as S,timeStringFormattingOptions as k}from"./support/timeWidgetUtils.js";import{TimezonePicker as M}from"./support/TimezonePicker.js";import"./support/widgetUtils.js";import{messageBundle as j}from"./support/decorators/messageBundle.js";import{tsx as T}from"./support/jsxFactory.js";import"@arcgis/toolkit/dom";import{onLocaleChange as V}from"../intl/locale.js";import{formatDate as z}from"../intl/date.js";const D={labelFormatFunction:_,min:0,max:1439,steps:15,rangeLabelInputsEnabled:!1,visibleElements:{labels:!1,rangeLabels:!1},tickConfigs:[{mode:"position",values:[0,360,720,1080,1439],labelsVisible:!0,tickCreatedFunction:(e,t,i)=>C({tickElement:t,labelElement:i})},{mode:"position",values:[120,240,480,600,840,960,1200,1320],tickCreatedFunction:(e,t)=>y({tickElement:t})}]};let O=class extends d{constructor(e,t){super(e,t),this.viewModel=null,this.headingLevel=4,this.visibleElements=new p,this._defaultViewModel=null,this._timeSlider=new a({...D,container:document.createElement("div")}),this._tooltip=null,this._onTimezoneChange=e=>{this.viewModel.utcOffset=e},this._onDateChange=e=>{const t=e.currentTarget.valueAsDate;this.viewModel.date=Array.isArray(t)?t[0]:t},e?.viewModel||(this._defaultViewModel=new m({view:e?.view}),this.viewModel=this._defaultViewModel)}initialize(){this.addHandles([i(()=>({viewModel:this.viewModel,slider:this._timeSlider}),e=>this._connectTimeSlider(e),o),i(()=>({container:this.view?.surface,viewModel:this.viewModel,tooltipVisible:this.visibleElements.tooltip}),({container:e,viewModel:i,tooltipVisible:o})=>{this._tooltip=t(this._tooltip),null!=e&&o&&(this._tooltip=new v({viewModel:i,container:e}))},o),i(()=>({viewModel:this.viewModel,visible:this.visible}),({viewModel:e,visible:t})=>e.setRunning(t),o)])}destroy(){this._timeSlider=t(this._timeSlider),this._tooltip=t(this._tooltip),null!=this._defaultViewModel&&this.viewModel!==this._defaultViewModel&&this._defaultViewModel.destroy()}loadDependencies(){return w({"input-date-picker":()=>import("@esri/calcite-components/dist/components/calcite-input-date-picker"),option:()=>import("@esri/calcite-components/dist/components/calcite-option"),select:()=>import("@esri/calcite-components/dist/components/calcite-select")})}render(){const{visibleElements:e,viewModel:t}=this,i="disabled"===t.state;return T("div",{class:this.classes(c.base,f.widget,f.panel,{[f.widgetDisabled]:i}),key:this},this._renderTimeRangeSection(),e.visualizationOptions?this._renderVisualizationOptionsSection():null)}get view(){return this.viewModel?.view}set view(e){this.viewModel&&(this.viewModel.view=e)}get icon(){return"measure-building-height-shadow"}set icon(e){this._overrideIfSome("icon",e)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get testData(){}_connectTimeSlider({viewModel:e,slider:t}){if(this.removeHandles("slider"),null==t)return;const l=e=>s(e,"milliseconds","minutes"),r=e=>s(e,"minutes","milliseconds"),n=({index:t,value:i})=>{0===t?e.startTimeOfDay=r(i):e.endTimeOfDay=r(i)},a=()=>S(t.domNode);a(),this.addHandles([i(()=>[e.startTimeOfDay,e.endTimeOfDay],e=>{t.values=e.map(l)},o),t.on("thumb-change",n),t.on("thumb-drag",n),t.on("segment-drag",()=>{[e.startTimeOfDay,e.endTimeOfDay]=t.values.map(r)}),V(a)],"slider")}_renderTimeRangeSection(){const{visibleElements:e}=this;return e.timeRangeSlider||e.datePicker?T("section",{class:c.timeRange,key:"time-range"},T(b,{level:this.headingLevel},this.messages.timeLabel),e.timeRangeSlider?this._renderTimeRange():null,e.datePicker?this._renderDatePicker():null):null}_renderTimeRange(){const{messages:e,viewModel:t,visibleElements:i}=this,{startTimeOfDay:o,endTimeOfDay:s}=t,[l,r]=[o,s].map(e=>z(new Date(e),k));return[T("div",{class:c.timeRangeIndicator,key:"time-range-indicator"},n(e.timeRange,{start:l,end:r}),i.timezone?T(M,{disabled:this._timeSlider?.disabled,value:t.utcOffset,onChange:this._onTimezoneChange}):null),T("div",{afterCreate:this._timeSliderContainerAfterCreate,afterRemoved:this._timeSliderContainerAfterRemoved,bind:this,key:"time-slider-container"})]}_timeSliderContainerAfterCreate(e){const t=this._timeSlider?.container;t&&e.appendChild(t)}_timeSliderContainerAfterRemoved(e){const t=this._timeSlider?.container;t&&e.removeChild(t)}_renderDatePicker(){return T("div",{class:c.datePickerContainer,key:c.datePickerContainer},T("calcite-input-date-picker",{class:c.datePicker,"data-testid":"date-picker",key:c.datePicker,overlayPositioning:"fixed",placement:"bottom",scale:"s",valueAsDate:this.viewModel.date,onCalciteInputDatePickerChange:this._onDateChange}))}_renderVisualizationOptionsSection(){const{headingLevel:e,messages:t,viewModel:i,visibleElements:o}=this,{colorPicker:s,thresholdContext:l,thresholdContextToggle:r,thresholdContextTimeInterval:n,thresholdContextColor:a}=o,d=e=>this.classes(i.visualizationType===e?null:c.visualizationConfigHidden);return T("section",{class:c.visualization,key:"visualization"},T(b,{level:e},t.visualizationLabel),this._renderVisualizationSelect(),T("div",{class:d("threshold"),key:"threshold-configurator"},T(g,{colorPickerVisible:s,contextColorPickerVisible:a,contextTimeIntervalVisible:n,contextToggleVisible:r,contextVisible:l,options:i.thresholdOptions})),T("div",{class:d("duration"),key:"duration-configurator"},T(u,{colorPickerVisible:s,options:i.durationOptions})),T("div",{class:d("discrete"),key:"discrete-configurator"},T(h,{colorPickerVisible:s,options:i.discreteOptions})))}_renderVisualizationSelect(){const e=this.messages,t=this.viewModel.visualizationType;return T("calcite-select",{bind:this,class:c.visualizationSelect,key:"visualization-select",label:e.visualizationLabel,scale:"s",onCalciteSelectChange:this._onVisualizationTypeChange},[{type:"threshold",label:e.threshold.label},{type:"duration",label:e.duration.label},{type:"discrete",label:e.discrete.label}].map(({type:e,label:i})=>T("calcite-option",{selected:e===t,value:e},i)))}_onVisualizationTypeChange(e){const t=e.currentTarget.selectedOption?.value;this.viewModel.visualizationType=t??"threshold"}};e([l()],O.prototype,"viewModel",void 0),e([l()],O.prototype,"view",null),e([l()],O.prototype,"headingLevel",void 0),e([l()],O.prototype,"icon",null),e([l()],O.prototype,"label",null),e([l({type:p,nonNullable:!0})],O.prototype,"visibleElements",void 0),e([l(),j("esri/widgets/ShadowCast/t9n/ShadowCast")],O.prototype,"messages",void 0),e([l()],O.prototype,"_defaultViewModel",void 0),e([l()],O.prototype,"_timeSlider",void 0),e([l()],O.prototype,"_tooltip",void 0),O=e([r("esri.widgets.ShadowCast")],O);const P=O;export{P as default};
