/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import{id as r}from"../../kernel.js";import o from"../../core/Collection.js";import{Loadable as t}from"../../core/Loadable.js";import{normalize as s}from"../../core/urlUtils.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import a from"../../portal/Portal.js";import{hasUserTypeExtension as c}from"../../portal/support/utils.js";let l=class extends t{constructor(e){super(e),this.canCreateVersion=!0,this.canEditVersionedData=!0,this.layers=new o,this.lockType="none",this.tables=new o,this.versionInfo=null,this.versionService=null}load(e){return this.addResolvingPromise(this._load(e)),Promise.resolve(this)}get layersAndTables(){return new o([...this.layers.toArray(),...this.tables.toArray()])}updateLockType(){this.lockType=this.versionInfo?this.versionService.getLockType(this.versionInfo.versionIdentifier)??"none":"none"}get featureServiceVersion(){return this.featureService.sourceJSON?.currentVersion??0}async syncVersionInfo(){this.loaded&&await this._syncVersionInfo()}async _load(e){const{featureService:r}=this;await r.load(e);const o=await p(r.url),t=o?.user?.username;if(this.loggedInServiceUser=t??"",o&&t&&(this.hasAdvancedEditingUserTypeExtension=await c(o,t,"advediting")),r.versionManagementServiceUrl){const e=new(0,(await import("../../versionManagement/VersionManagementService.js")).default)({url:r.versionManagementServiceUrl});this.versionService=e,await e.load(),await this._syncVersionInfo()}}async _syncVersionInfo(){const{layersAndTables:e,versionService:r}=this;if(!r||0===e.length)return;const o=e.getItemAt(0)?.gdbVersion,t=o?await r.getVersionIdentifierFromName(o):r.defaultVersionIdentifier;this.versionInfo=await r.getVersionInfoExtended(t)}};async function p(e){const o=r?.findServerInfo(e??"");if(!o?.owningSystemUrl)return null;const t=`${o.owningSystemUrl}/sharing/rest`,i=a.getDefault();if(i?.loaded&&s(i.restUrl)===s(t))return i;return new a({authMode:"immediate",url:o.owningSystemUrl}).load()}e([i({constructOnly:!0})],l.prototype,"canCreateVersion",void 0),e([i({constructOnly:!0})],l.prototype,"canEditVersionedData",void 0),e([i({constructOnly:!0})],l.prototype,"featureService",void 0),e([i({constructOnly:!0})],l.prototype,"layers",void 0),e([i()],l.prototype,"layersAndTables",null),e([i()],l.prototype,"lockType",void 0),e([i({constructOnly:!0})],l.prototype,"tables",void 0),e([i()],l.prototype,"versionInfo",void 0),e([i()],l.prototype,"versionService",void 0),e([i()],l.prototype,"hasAdvancedEditingUserTypeExtension",void 0),e([i()],l.prototype,"loggedInServiceUser",void 0),e([i()],l.prototype,"featureServiceVersion",null),l=e([n("esri.undoredo.support.ServiceVersionInfo")],l);export{l as ServiceVersionInfo};
