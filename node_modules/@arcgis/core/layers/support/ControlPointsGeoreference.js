/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import o from"../../core/Error.js";import{JSONSupportMixin as e,JSONSupport as r}from"../../core/JSONSupport.js";import n from"../../core/Logger.js";import{transformProjective as i,getProjectiveTransform as s}from"../../core/perspectiveUtils.js";import{createScreenPoint as l}from"../../core/screenUtils.js";import{property as c}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{reader as a}from"../../core/accessorSupport/decorators/reader.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import{writer as u}from"../../core/accessorSupport/decorators/writer.js";import{invert as m}from"../../core/libs/gl-matrix-2/math/mat3.js";import{fromValues as f,create as P}from"../../core/libs/gl-matrix-2/factories/mat3f64.js";import{set as h,lerp as d,rotate as y}from"../../core/libs/gl-matrix-2/math/vec2.js";import{create as g,fromValues as w}from"../../core/libs/gl-matrix-2/factories/vec2f64.js";import j from"../../geometry/Point.js";import R from"../../geometry/Polygon.js";import{projectOrLoad as x}from"../../geometry/projectionUtils.js";import v from"../../geometry/SpatialReference.js";import b from"./ControlPoint.js";import S from"./GeoreferenceBase.js";const C=P(),N=g();let q=class extends r{};t([c({type:Number,json:{write:{isRequired:!0}}})],q.prototype,"x",void 0),t([c({type:Number,json:{write:{isRequired:!0}}})],q.prototype,"y",void 0),q=t([p("esri.layers.support.ControlPointsGeoreference.ControlPointJSONType")],q);let T=class extends(e(S)){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,o){const e=v.fromJSON(o.spatialReference),r=f(...o.coefficients,1);return t.map(t=>(h(N,t.x,t.y),i(N,N,r),{sourcePoint:t,mapPoint:new j({x:N[0],y:N[1],spatialReference:e})}))}writeControlPoints(t,e,r,i){if(null==this.transform){const t=new o("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration. Make sure the parent media element is loaded i.e. the ImageElement or VideoElement set as 'MediaLayer.source'.",{layer:i?.layer,georeference:this});return void(i?.messages?i.messages.push(t):n.getLogger(this).error(t.name,t.message))}null!=t&&O(t[0])&&(e.controlPoints=t.map(t=>{const o=t.sourcePoint;return{x:o.x,y:o.y}}),e.spatialReference=t[0].mapPoint.spatialReference.toJSON(),e.coefficients=this.transform.slice(0,8))}get coords(){if(null==this.controlPoints)return null;const t=this._updateTransform(C);if(null==t||!O(this.controlPoints[0]))return null;const o=this.controlPoints[0].mapPoint.spatialReference;return K(t,this.width,this.height,o)}set coords(t){if(null==this.controlPoints||!O(this.controlPoints[0]))return;const o=this.controlPoints[0].mapPoint.spatialReference;if(null==(t=this.projectOrWarn(t,o)))return;const{width:e,height:r}=this,{rings:[[n,s,c,a]]}=t,p=new b({sourcePoint:l(0,r),mapPoint:new j({x:n[0],y:n[1],spatialReference:o})}),u=new b({sourcePoint:l(0,0),mapPoint:new j({x:s[0],y:s[1],spatialReference:o})}),m=new b({sourcePoint:l(e,0),mapPoint:new j({x:c[0],y:c[1],spatialReference:o})}),f=new b({sourcePoint:l(e,r),mapPoint:new j({x:a[0],y:a[1],spatialReference:o})});O(p)&&O(u)&&O(m)&&O(f)&&(B(C,p,u,m,f),this.controlPoints=this.controlPoints.map(({sourcePoint:t})=>(h(N,t.x,t.y),i(N,N,C),{sourcePoint:t,mapPoint:new j({x:N[0],y:N[1],spatialReference:o})})))}get inverseTransform(){return null==this.transform?null:m(P(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(null==t||null==this.transform||null==this.controlPoints||!O(this.controlPoints[0]))return null;h(N,t.x,t.y);const o=this.controlPoints[0].mapPoint.spatialReference;return i(N,N,this.transform),new j({x:N[0],y:N[1],spatialReference:o})}toSource(t){if(null==t||null==this.inverseTransform||null==this.controlPoints||!O(this.controlPoints[0]))return null;const o=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),null==(t=x(t,o).geometry)?null:(h(N,t.x,t.y),i(N,N,this.inverseTransform),l(N[0],N[1]))}toSourceNormalized(t){const o=this.toSource(t);return null!=o&&(o.x/=this.width,o.y/=this.height),o}_updateTransform(t){const{controlPoints:o,width:e,height:r}=this;if(!(null!=o&&e>0&&r>0))return null;const[n,i,s,l]=o;if(!O(n))return null;const c=n.mapPoint.spatialReference,a=this._projectControlPoint(i,c),p=this._projectControlPoint(s,c),u=this._projectControlPoint(l,c);if(!a.valid||!p.valid||!u.valid)return null;if(!O(a.controlPoint))return null;null==t&&(t=P());let m=null;return m=O(p.controlPoint)&&O(u.controlPoint)?B(t,n,a.controlPoint,p.controlPoint,u.controlPoint):O(p.controlPoint)?k(t,n,a.controlPoint,p.controlPoint):V(t,n,a.controlPoint),m.every(t=>0===t)?null:m}_projectControlPoint(t,o){if(!O(t))return{valid:!0,controlPoint:t};const{sourcePoint:e,mapPoint:r}=t,{geometry:i,pending:s}=x(r,o);return s?{valid:!1,controlPoint:null}:s||i?{valid:!0,controlPoint:new b({sourcePoint:e,mapPoint:i})}:(n.getLogger(this).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:r.spatialReference,targetSpatialReference:o}),{valid:!1,controlPoint:null})}};function O(t){return null!=t?.sourcePoint&&null!=t.mapPoint}t([c({type:[b],json:{write:{allowNull:!1,isRequired:!0,target:{controlPoints:{type:[q],isRequired:!0},coefficients:{type:[Number],isRequired:!0},spatialReference:{type:v,isRequired:!0}}}}})],T.prototype,"controlPoints",void 0),t([a("controlPoints")],T.prototype,"readControlPoints",null),t([u("controlPoints")],T.prototype,"writeControlPoints",null),t([c({clonable:!1})],T.prototype,"coords",null),t([c({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],T.prototype,"height",void 0),t([c({readOnly:!0})],T.prototype,"inverseTransform",null),t([c({readOnly:!0})],T.prototype,"transform",null),t([c({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}})],T.prototype,"width",void 0),T=t([p("esri.layers.support.ControlPointsGeoreference")],T);const _=g(),M=g(),I=g(),L=g(),G=g(),J=g(),E=g(),U=g(),z=Math.PI/2;function A(t,o,e){h(t,e.sourcePoint.x,e.sourcePoint.y),h(o,e.mapPoint.x,e.mapPoint.y)}function V(t,o,e){return A(_,G,o),A(M,J,e),y(I,M,_,z),y(L,_,M,z),y(E,J,G,-z),y(U,G,J,-z),H(t,_,M,I,L,G,J,E,U)}function k(t,o,e,r){return A(_,G,o),A(M,J,e),A(I,E,r),d(L,_,M,.5),y(L,I,L,Math.PI),d(U,G,J,.5),y(U,E,U,Math.PI),H(t,_,M,I,L,G,J,E,U)}function B(t,o,e,r,n){return A(_,G,o),A(M,J,e),A(I,E,r),A(L,U,n),H(t,_,M,I,L,G,J,E,U)}const W=new Array(8).fill(0),D=new Array(8).fill(0);function F(t,o,e,r,n){return t[0]=o[0],t[1]=o[1],t[2]=e[0],t[3]=e[1],t[4]=r[0],t[5]=r[1],t[6]=n[0],t[7]=n[1],t}function H(t,o,e,r,n,i,l,c,a){return s(t,F(W,o,e,r,n),F(D,i,l,c,a))}function K(t,o,e,r){const n=w(0,e),s=w(0,0),l=w(o,0),c=w(o,e);return i(n,n,t),i(s,s,t),i(l,l,t),i(c,c,t),new R({rings:[[n,s,l,c,n]],spatialReference:r})}export{T as default};
