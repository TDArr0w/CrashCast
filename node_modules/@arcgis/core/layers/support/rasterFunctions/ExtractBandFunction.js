/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as t}from"tslib";import{property as n}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/has.js";import"../../../core/Logger.js";import"../../../core/RandomLCG.js";import{subclass as e}from"../../../core/accessorSupport/decorators/subclass.js";import{getBandMatrix3 as s}from"./bandIndexUtils.js";import r from"./BaseRasterFunction.js";import o from"./ExtractBandFunctionArguments.js";let i=class extends r{constructor(){super(...arguments),this.functionName="ExtractBand",this.functionArguments=null,this.rasterArgumentNames=["raster"]}_bindSourceRasters(){const{functionArguments:t,sourceRasterInfos:n}=this,e=n[0],{method:s,bandNames:r,bandWavelengths:o,bandIds:i,missingBandAction:a}=t,d=r?.length&&("name"===s||"id"!==s&&!i?.length),h=o?.length&&("wavelength"===s||"id"!==s&&!i?.length),m=1===a,g=d?l(e,r):h?c(e,o,this.functionArguments,m):u(e,i,m);if(null==g){return{success:!1,supportsGPU:!1,error:`extract-band-function: Invalid ${d?"band names":h?"band wavelengths":"band ids"} for the imagery data source`}}this.functionArguments.bandIds=g,this.functionArguments.method="id",this.outputPixelType=this._getOutputPixelType("f32");const p=e.clone();p.pixelType=this.outputPixelType,p.bandCount=g.length;const{statistics:f,histograms:I}=p;null!=f&&f.length&&(p.statistics=g.map(t=>f[t]||f[f.length-1])),null!=I&&I.length&&(p.histograms=g.map(t=>I[t]||I[I.length-1])),p.multidimensionalInfo&&p.multidimensionalInfo.variables.forEach(t=>{const{statistics:n,histograms:e}=t;null!=n&&n.length&&(t.statistics=g.map(t=>n[t]||n[n.length-1])),null!=e&&e.length&&(t.histograms=g.map(t=>e[t]||e[e.length-1]))});let b=p.keyProperties?.BandProperties;b?.length&&(b=g.map(t=>t>=b.length?b[b.length-1]:b[t]),p.keyProperties={...p.keyProperties,BandProperties:b}),this.rasterInfo=p;return{success:!0,supportsGPU:p.bandCount<=3}}_processPixels(t){const n=t.pixelBlocks?.[0];if(null==n)return null;let{bandIds:e}=this.functionArguments;if(this.rasterInfo.storageInfo.isBsqTile){const{rawInputBandIds:t}=this;e=e.map(n=>t.indexOf(n))}else{const t=n.pixels.length;e=e.map(n=>n>=t?t-1:n)}return n.extractBands(e)}_getWebGLParameters(){let t;if(this.isInputBandIdsSwizzled)t=this.swizzledBandSelection.length?this.swizzledBandSelection:[0,1,2];else{t=[...this.functionArguments.bandIds],0===t.length?t=[0,1,2]:t.length<3&&(t[1]=t[1]??t[0],t[2]=t[2]??t[1]);for(let n=0;n<3;n++)t[n]=Math.min(t[n],2)}return{bandIndexMat3:s(t)}}_getInputBandIds(t){const n=t.length;return this.functionArguments.bandIds.map(t=>t>=n?n-1:t).map(n=>t[n])}_swizzleBandIds(t){const n=this.functionArguments.bandIds.map(n=>t.indexOf(n));return this.isInputBandIdsSwizzled=!0,n[1]??=n[0],n[2]??=n[1],this.swizzledBandSelection=n,!1}};t([n({json:{write:!0,name:"rasterFunction"}})],i.prototype,"functionName",void 0),t([n({type:o,json:{write:!0,name:"rasterFunctionArguments"}})],i.prototype,"functionArguments",void 0),t([n()],i.prototype,"rasterArgumentNames",void 0),i=t([e("esri.layers.support.rasterFunctions.ExtractBandFunction")],i);const a=i;function l(t,n){const e=t.bandInfos.map(({name:t})=>t.toLowerCase()),s=[];for(let r=0;r<n.length;r++){const t=n[r].toLowerCase();let o=e.indexOf(t);if(-1===o&&"nearinfrared"===t&&(o=e.findIndex(t=>t.startsWith("nearinfrared_1")),-1===o&&(o=e.findIndex(t=>t.startsWith("nearinfrared")))),-1===o)return null;s.push(o)}return s}function u(t,n,e){const{bandCount:s}=t;return!n?.length||e&&n.some(t=>t<0||t>=s)?null:n}function c(t,n,{wavelengthMatchTolerance:e},s){const{bandInfos:r}=t,o=[];for(let a=0;a<r.length;a++){const{minWavelength:t,maxWavelength:n}=r[a];if(!t||!n)return null;o.push({minWavelength:t,maxWavelength:n})}const i=[];for(let a=0;a<n.length;a++){const t=n[a];let r=!1,l=-1,u=Number.MAX_VALUE;for(let n=0;n<o.length;n++){const e=o[n],s=t>=e.minWavelength&&t<=e.maxWavelength,i=Math.abs(t-(e.minWavelength+e.maxWavelength)/2);s?i<u&&(r=!0,l=n,u=i):!r&&i<u&&(l=n,u=i)}if(!r&&e&&u<e&&(r=!0),!r&&s)return null;i.push(l)}return i}export{a as default};
