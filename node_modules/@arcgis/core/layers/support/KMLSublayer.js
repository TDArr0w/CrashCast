/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import t from"../../core/Collection.js";import{EventedMixin as r}from"../../core/Evented.js";import{JSONSupportMixin as i}from"../../core/JSONSupport.js";import{Loadable as s}from"../../core/Loadable.js";import{on as o,watch as l,sync as a,whenOnce as n}from"../../core/reactiveUtils.js";import{stripHTML as p}from"../../core/string.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import{ensureType as h}from"../../core/accessorSupport/ensureType.js";import"../../core/has.js";import"../../core/RandomLCG.js";import{reader as y}from"../../core/accessorSupport/decorators/reader.js";import{subclass as c}from"../../core/accessorSupport/decorators/subclass.js";import m from"../../geometry/Extent.js";import f from"../../graphic/KMLGraphicOrigin.js";import{computeExtent as d,sublayersFromJSON as v,fetchService as b,parseKML as j}from"./kmlUtils.js";var S;let g=S=class extends(r(i(s))){constructor(...e){super(...e),this.description=null,this.fullExtent=null,this.id=null,this.networkLink=null,this.parent=null,this.sublayers=null,this.title=null,this.sourceJSON=null,this.layer=null,this.addHandles([o(()=>this.sublayers,"after-add",({item:e})=>{e.parent=this,e.layer=this.layer},a),o(()=>this.sublayers,"after-remove",({item:e})=>{e.layer=e.parent=null},a),l(()=>this.sublayers,(e,t)=>{if(t)for(const r of t)r.layer=r.parent=null;if(e)for(const r of e)r.parent=this,r.layer=this.layer},a),l(()=>this.layer,e=>{if(this.sublayers)for(const t of this.sublayers)t.layer=e},a)])}initialize(){n(()=>this.networkLink).then(()=>n(()=>!0===this.visible)).then(()=>this.load())}load(e){if(!this.networkLink)return;if(this.networkLink.viewFormat)return;const r=null!=e?e.signal:null,i=this._fetchService(this._get("networkLink")?.href??"",r).then(e=>{const r=d(e.sublayers);this.fullExtent=m.fromJSON(r),this.sourceJSON=e;const i=h(t.ofType(S),v(S,e));this.sublayers?this.sublayers.addMany(i):this.sublayers=i,this.layer?.emit("sublayer-update"),this.layer&&this.layer.notifyChange("visibleSublayers")});return this.addResolvingPromise(i),Promise.resolve(this)}get visible(){return this._get("visible")}set visible(e){this._get("visible")!==e&&(this._set("visible",e),this.layer&&this.layer.notifyChange("visibleSublayers"))}readVisible(e,t){return!!t.visibility}get origin(){return this.layer?new f(this.layer,this):null}_fetchService(e,t){return b(e,this.layer.outSpatialReference,this.layer.refreshInterval,t).then(e=>j(e.data))}};e([u()],g.prototype,"description",void 0),e([u({type:m})],g.prototype,"fullExtent",void 0),e([u()],g.prototype,"id",void 0),e([u({readOnly:!0,value:null})],g.prototype,"networkLink",void 0),e([u({json:{write:{allowNull:!0}}})],g.prototype,"parent",void 0),e([u({type:t.ofType(g),json:{write:{allowNull:!0}}})],g.prototype,"sublayers",void 0),e([u({value:null,json:{read:{source:"name",reader:e=>p(e)}}})],g.prototype,"title",void 0),e([u({value:!0})],g.prototype,"visible",null),e([y("visible",["visibility"])],g.prototype,"readVisible",null),e([u()],g.prototype,"sourceJSON",void 0),e([u()],g.prototype,"layer",void 0),e([u()],g.prototype,"origin",null),g=S=e([c("esri.layers.support.KMLSublayer")],g);export{g as default};
