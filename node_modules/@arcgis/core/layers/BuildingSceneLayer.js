/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import t from"../core/Collection.js";import r from"../core/CollectionFlattener.js";import i from"../core/Error.js";import{abortHandle as s}from"../core/handleUtils.js";import{clone as o}from"../core/lang.js";import{loadAll as l}from"../core/loadAll.js";import a from"../core/Logger.js";import{MultiOriginJSONMixin as n}from"../core/MultiOriginJSONSupport.js";import{throwIfAbortError as p,ignoreAbortErrors as u}from"../core/promiseUtils.js";import{whenOnce as y}from"../core/reactiveUtils.js";import{join as d}from"../core/urlUtils.js";import{property as c}from"../core/accessorSupport/decorators/property.js";import"../core/has.js";import{reader as m}from"../core/accessorSupport/decorators/reader.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import b from"../geometry/SpatialReference.js";import g from"./Layer.js";import f from"./buildingSublayers/BuildingComponentSublayer.js";import v from"./buildingSublayers/BuildingGroupSublayer.js";import{forEachBuildingSublayer as S}from"./buildingSublayers/utils.js";import{APIKeyMixin as j}from"./mixins/APIKeyMixin.js";import{ArcGISService as w}from"./mixins/ArcGISService.js";import{CustomParametersMixin as _}from"./mixins/CustomParametersMixin.js";import{OperationalLayer as I}from"./mixins/OperationalLayer.js";import{PortalLayer as L}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as O}from"./mixins/ScaleRangeLayer.js";import{SceneService as T}from"./mixins/SceneService.js";import{findAssociatedFeatureService as P}from"./support/associatedFeatureServiceUtils.js";import x from"./support/BuildingFilter.js";import F from"./support/BuildingSummaryStatistics.js";import{sceneLayerFullExtent as A,legendEnabled as B,readOnlyService as E,elevationInfo as K}from"./support/commonProperties.js";import{logInvalidElevationInfoWarning as C,elevationModeRequiredMessage as U,featureExpressionUnsupportedMessage as $}from"../support/elevationInfoUtils.js";const R=t.ofType(x),M=o(v.sublayersProperty),H=M.json?.origins;H&&(H["web-scene"]={type:[f],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}},H["portal-item"]={type:[f],write:{enabled:!0,overridePolicy:()=>({enabled:!1})}});let k=class extends(T(w(I(L(O(n(_(j(g))))))))){constructor(e){super(e),this.operationalLayerType="BuildingSceneLayer",this.allSublayers=new r({getCollections:()=>[this.sublayers],getChildrenFunction:e=>"building-group"===e.type?e.sublayers:null}),this.sublayers=null,this._allSublayerOverrides=null,this.filters=new R,this.activeFilterId=null,this.summaryStatistics=null,this.outFields=null,this.legendEnabled=!0,this.type="building-scene"}normalizeCtorArgs(e){return"string"==typeof e?{url:e}:e??{}}destroy(){this.allSublayers.destroy()}readSublayers(e,t,r){const i=v.readSublayers(e,t,r);return S(i,e=>e.layer=this),this._allSublayerOverrides&&(N(i,this._allSublayerOverrides),this._allSublayerOverrides=null),i}write(e,t){return e=super.write(e,t),!t||"web-scene"!==t.origin&&"portal-item"!==t.origin||(this.sublayers?z(this.sublayers,e,t):this._allSublayerOverrides&&J(this._allSublayerOverrides,e,t)),e}read(e,t){if(super.read(e,t),("web-scene"===t?.origin||"portal-item"===t?.origin)&&Array.isArray(e?.sublayers)){const r=W(e.sublayers,t);this.sublayers?G(this.sublayers,r):(this._allSublayerOverrides??=new Map,this._allSublayerOverrides.set(t.origin,r))}}readSummaryStatistics(e,t){if("string"==typeof t.statisticsHRef&&this.parsedUrl){const e=d(this.parsedUrl.path,t.statisticsHRef);return new F({url:e,apiKey:this.apiKey,customParameters:this.customParameters})}return null}set elevationInfo(e){null!=e&&"absolute-height"!==e.mode||this._set("elevationInfo",e),this._validateElevationInfo(e)}load(e){const t=null!=e?e.signal:null,r=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(p).then(()=>this._fetchService(t)).then(()=>this._fetchAssociatedFeatureService(t));return this.addResolvingPromise(r),Promise.resolve(this)}loadAll(){return l(this,e=>{S(this.sublayers,t=>{"building-group"!==t.type&&e(t)}),this.summaryStatistics&&e(this.summaryStatistics)})}async saveAs(e,t){return this._debouncedSaveOperations(1,{...t,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"building-scene"};return this._debouncedSaveOperations(0,e)}validateLayer(e){if(!e.layerType||"Building"!==e.layerType)throw new i("buildingscenelayer:layer-type-not-supported","BuildingSceneLayer does not support this layer type",{layerType:e.layerType})}_getTypeKeywords(){return["Building"]}async _fetchAssociatedFeatureService(e){try{const{portalItem:t}=await P(`${this.url}/layers/${this.layerId}`,{sceneLayerItem:this.portalItem,customParameters:this.customParameters,apiKey:this.apiKey,signal:e});this.associatedFeatureServiceItem=t}catch(t){u(this._logWarningOnPopupEnabled())}}async _logWarningOnPopupEnabled(){const e=new AbortController;this.addHandles(s(e)),await y(()=>this.allSublayers.filter(e=>"building-component"===e.type).some(e=>e.popupEnabled&&null!=e.popupTemplate),e.signal);const t=this.allSublayers.filter(e=>"building-component"===e.type).filter(e=>e.popupEnabled&&null!=e.popupTemplate),r=[],i=[];for(const s of t){const e=s.title??`untitled ${s.id}`;s.attributeStorageInfo?r.push(e):i.push(e)}const o="\n  ",l=r.length>0?`\nThe following sublayers will fall back to binary attributes for Popups:${o}${r.join(o)}`:"",n=i.length>0?`\nThe following sublayers have no binary attributes and will not work with Popups:${o}${i.join(o)}`:"";a.getLogger(this).warn(`Associated FeatureLayer could not be loaded for this BuildingSceneLayer: ${this.title}.`,l,n)}_validateElevationInfo(e){const t="Building scene layers";C(a.getLogger(this),U(t,"absolute-height",e)),C(a.getLogger(this),$(t,e))}};function N(e,t){t.forEach(t=>G(e,t))}function G(e,t){const{overrides:r,context:i}=t;S(e,e=>e.read(r.get(e.id),i))}function W(e,t){const r=new Map;for(const s of e)null!=s&&"object"==typeof s&&"number"==typeof s.id?r.set(s.id,s):t.messages?.push(new i("building-scene-layer:invalid-sublayer-override","Invalid value for sublayer override. Not an object or no id specified.",{value:s}));return{overrides:r,context:t}}function z(e,t,r){const i=[];S(e,e=>{const t=e.write({},r);Object.keys(t).length>1&&i.push(t)}),i.length>0&&(t.sublayers=i)}function J(e,t,r){const i=r?.origin&&e.get(r.origin);i&&(t.sublayers=[],i.overrides.forEach(e=>{t.sublayers.push(o(e))}))}e([c({type:["BuildingSceneLayer"]})],k.prototype,"operationalLayerType",void 0),e([c({readOnly:!0})],k.prototype,"allSublayers",void 0),e([c(M)],k.prototype,"sublayers",void 0),e([m("service","sublayers")],k.prototype,"readSublayers",null),e([c({type:R,nonNullable:!0,json:{write:!0}})],k.prototype,"filters",void 0),e([c({type:String,json:{write:!0}})],k.prototype,"activeFilterId",void 0),e([c({readOnly:!0,type:F})],k.prototype,"summaryStatistics",void 0),e([m("summaryStatistics",["statisticsHRef"])],k.prototype,"readSummaryStatistics",null),e([c({type:[String],json:{read:!1}})],k.prototype,"outFields",void 0),e([c(A)],k.prototype,"fullExtent",void 0),e([c(B)],k.prototype,"legendEnabled",void 0),e([c({type:["show","hide","hide-children"]})],k.prototype,"listMode",void 0),e([c(E(b))],k.prototype,"spatialReference",void 0),e([c(K)],k.prototype,"elevationInfo",null),e([c({json:{read:!1},readOnly:!0})],k.prototype,"type",void 0),e([c()],k.prototype,"associatedFeatureServiceItem",void 0),k=e([h("esri.layers.BuildingSceneLayer")],k);const q=k;export{q as default};
