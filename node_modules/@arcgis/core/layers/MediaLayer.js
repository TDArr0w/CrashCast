/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import r from"../core/Collection.js";import o from"../core/Error.js";import t from"../core/Logger.js";import{MultiOriginJSONMixin as s}from"../core/MultiOriginJSONSupport.js";import{debounce as i}from"../core/promiseUtils.js";import{property as a}from"../core/accessorSupport/decorators/property.js";import{cast as n}from"../core/accessorSupport/decorators/cast.js";import"../core/has.js";import"../core/RandomLCG.js";import{reader as c}from"../core/accessorSupport/decorators/reader.js";import{subclass as p}from"../core/accessorSupport/decorators/subclass.js";import{writer as l}from"../core/accessorSupport/decorators/writer.js";import u from"./Layer.js";import{BlendLayer as d}from"./mixins/BlendLayer.js";import{OperationalLayer as m}from"./mixins/OperationalLayer.js";import{PortalLayer as f}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as y}from"./mixins/ScaleRangeLayer.js";import h from"./support/ControlPointsGeoreference.js";import g from"./support/ImageElement.js";import S from"./support/LocalMediaElementSource.js";import{isWritingLayerFromItemToWebDocument as w}from"./support/mediaUtils.js";import v from"./support/VideoElement.js";import{isMediaElement as j}from"../support/mediaLayerUtils.js";let L=class extends(d(y(m(f(s(u)))))){constructor(e){super(e),this.effectiveSource=null,this.georeference=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this._debouncedSaveOperations=i(async(e,r,o)=>{const{save:t,saveAs:s}=await import("./save/mediaLayerUtils.js");switch(e){case 0:return t(this,r);case 1:return s(this,o,r)}}),this.source=new S}load(e){return this.addResolvingPromise(this._doLoad(e)),Promise.resolve(this)}async _doLoad(e){await this.loadFromPortal({supportedTypes:["Media Layer"]},e);let t=this.source;if(!t)throw new o("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer.");const s=this._getSourceOverride(t,this.georeference);s&&(this.setAtOrigin("source",s,"web-map"),this.setAtOrigin("source",s,"web-scene"),t=s);const i=j(t)?new S({elements:new r([t])}):t;this._set("effectiveSource",i),this.spatialReference&&(i.spatialReference=this.spatialReference),await i.load(e),this.spatialReference=i.spatialReference}destroy(){this.effectiveSource?.destroy(),this.effectiveSource!==this.source&&this.source?.destroy()}readGeoreference(e,r){return e&&"itemId"in r&&r.itemId?e:void 0}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}get loaded(){return super.loaded}get source(){return this._get("source")}set source(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("source",e):t.getLogger(this).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)?new S({elements:new r(e)}):e instanceof r?new S({elements:e}):e:null}readSource(e,r,o){if("itemId"in r&&r.itemId)return;const t=this._createSource(r);return t?.read(r,o),t}writeSource(e,r,t,s){if(e&&e instanceof S){const r=e.elements.length;if(1!==r)return void(s?.messages&&s.messages.push(new o("media-layer:unsupported-source",`local media element source can only be persisted if it contains exactly one ImageElement, but it has ${r}.`)));e=e.elements.at(0)}j(e)?e.write(r,s):s?.messages&&(e?s.messages.push(new o("media-layer:unsupported-source","only media elements of type 'ImageElement' or 'VideoElement' can be persisted")):s.messages.push(new o("media-layer:unsupported-source","the media layer is missing a source")))}async save(e){return this._debouncedSaveOperations(0,e)}async saveAs(e,r){return this._debouncedSaveOperations(1,r,e)}_createSource(e){if("mediaType"in e)switch(e.mediaType){case"image":return new g;case"video":return new v}return null}_getSourceOverride(e,r){if(j(e)&&3===this.originIdOf("source")&&r&&(5===this.originIdOf("georeference")||4===this.originIdOf("georeference"))){const o=e.toJSON(),t=this._createSource(o);return t.read({...o},{origin:"portal-item"}),t.read({georeference:r},{origin:"web-map"}),t.read({georeference:r},{origin:"web-scene"}),t}return null}};e([a({readOnly:!0})],L.prototype,"effectiveSource",void 0),e([a({readOnly:!0,json:{read:!1,write:!1,origins:{"web-document":{read:!0}}}})],L.prototype,"georeference",void 0),e([c("web-document","georeference")],L.prototype,"readGeoreference",null),e([a({type:String})],L.prototype,"copyright",void 0),e([a({readOnly:!0})],L.prototype,"fullExtent",null),e([a({type:["MediaLayer"]})],L.prototype,"operationalLayerType",void 0),e([a({type:["show","hide"]})],L.prototype,"listMode",void 0),e([a({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1,target:{url:{type:String},mediaType:{type:["image","video"]},georeference:{type:h}},overridePolicy(e,r,o){return{enabled:!0,allowNull:!1,ignoreOrigin:w(this,o?.origin)&&j(e)&&!!e.georeference&&e.originIdOf("georeference")>3}}}}})],L.prototype,"source",null),e([n("source")],L.prototype,"castSource",null),e([c("source",["url"])],L.prototype,"readSource",null),e([l("source")],L.prototype,"writeSource",null),e([a()],L.prototype,"spatialReference",void 0),e([a({readOnly:!0})],L.prototype,"type",void 0),L=e([p("esri.layers.MediaLayer")],L);const O=L;export{O as default};
