/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import t from"../Color.js";import r from"../request.js";import{deprecatedProperty as o}from"../core/deprecate.js";import i from"../core/Error.js";import s from"../core/Logger.js";import{clamp as l}from"../core/mathUtils.js";import{MultiOriginJSONMixin as n}from"../core/MultiOriginJSONSupport.js";import{throwIfAbortError as a}from"../core/promiseUtils.js";import{watch as p,initial as y,whenOnce as m}from"../core/reactiveUtils.js";import{property as u}from"../core/accessorSupport/decorators/property.js";import{Integer as d}from"../core/accessorSupport/ensureType.js";import"../core/has.js";import"../core/RandomLCG.js";import{reader as c}from"../core/accessorSupport/decorators/reader.js";import{subclass as h}from"../core/accessorSupport/decorators/subclass.js";import f from"../geometry/Extent.js";import v from"../geometry/Polyline.js";import g from"../geometry/SpatialReference.js";import S from"./Layer.js";import{ArcGISService as b}from"./mixins/ArcGISService.js";import{BlendLayer as O,effectProperty as j}from"./mixins/BlendLayer.js";import{CustomParametersMixin as T}from"./mixins/CustomParametersMixin.js";import{OperationalLayer as w}from"./mixins/OperationalLayer.js";import{PortalLayer as I}from"./mixins/PortalLayer.js";import{ScaleRangeLayer as L}from"./mixins/ScaleRangeLayer.js";import{titleFromUrlAndName as C}from"./support/arcgisLayerUrl.js";import{opacity as P,id as x}from"./support/commonProperties.js";import{normalizeParsedUrlObject as U,urlProperty as E}from"./support/multiLayerServiceUtils.js";import N from"./support/PlaybackInfo.js";import{getVideoLayerCapabilities as M}from"./support/serviceCapabilitiesUtils.js";import k from"./support/TelemetryData.js";import V from"./support/TelemetryDisplay.js";import F from"./support/VideoFrame.js";import G from"./support/VideoTimeExtent.js";import H from"./video/VideoController.js";import{getFrameHorizonPoints as J,getGroundControlPoints as R,getTelemetryData as _,getServiceLayersInfo as z,getStyledTelemetrySymbol as A,getSensorTrailPoints as q,readVideoTimeExtent as D}from"./video/videoUtils.js";import B from"../symbols/CIMSymbol.js";import W from"../symbols/PictureMarkerSymbol.js";import Q from"../symbols/SimpleFillSymbol.js";import $ from"../symbols/SimpleLineSymbol.js";import Z from"../symbols/SimpleMarkerSymbol.js";import K from"../symbols/Symbol.js";import{write as X}from"../symbols/support/jsonUtils.js";function Y(e,t){return{ignoreOrigin:this.originIdOf(t)<3}}const ee=new t([255,127,0]),te=new t([0,0,0,.05]),re=new Z({angle:0,color:ee,size:10,style:"cross"}),oe=new Q({color:te,outline:new $({color:ee,width:2})}),ie=new $({color:ee,width:1}),se=new Z({angle:0,color:ee,outline:{color:[255,255,255],width:1.33},size:10,style:"circle"}),le=new $({color:ee,width:1}),ne={types:{base:K,key:"type",typeMap:{"simple-marker":Z,"picture-marker":W,cim:B}},json:{name:"drawingInfo.sensorSymbol",write:{writer:X,overridePolicy:Y}}};function ae(e,t){return{type:t,json:{name:e,write:{overridePolicy:Y}}}}let pe=class extends(O(L(b(w(I(n(T(S)))))))){constructor(e){super(e),this._trailPoints=[],this.cameraInfo=null,this.capabilities=null,this.codecs=null,this.connectionInfo=null,this.controller=new H,this.copyright=null,this.created=null,this.customParameters=null,this.description=null,this.elevationSource=null,this.frame=null,this.frameCenterSymbol=re.clone(),this.frameCount=null,this.frameEffect=null,this.frameOpacity=1,this.frameOutlineSymbol=oe.clone(),this.fullExtent=null,this.fullTimeExtent=null,this.initialExtent=null,this.layerId=null,this.operationalLayerType="ArcGISVideoLayer",this.playbackInfo=null,this.posterUrl=null,this.qualities=null,this.sensorSymbolOrientation={source:"platformHeading",symbolOffset:0},this.sensorSymbol=se.clone(),this.sensorSightLineSymbol=ie.clone(),this.sensorTrailSymbol=le.clone(),this.serviceItemId=null,this.sourceJSON=null,this.sourceQuality=null,this.sourceType=null,this.spatialReference=g.WGS84,this.start=0,this.telemetryDisplay=new V,this.type="video",this.url=null,this.version=null,this.videoLayersInfo=null}initialize(){this.addHandles([p(()=>this.metadata,()=>{this.notifyChange("telemetry"),this.notifyChange("groundControlPoints"),this.notifyChange("frameHorizonPoints")}),p(()=>this.telemetry?.sensorLocation,e=>this._setSensorTrail(e),y)]),m(()=>this.loaded&&"can-play"===this.state&&this.duration>0).then(()=>{this.start>=0&&this.start<=this.duration&&this.setCurrentTime(this.start)})}destroy(){this.removeAllHandles(),this.controller&&this.controller.destroy()}load(e){const t=null!=e?e.signal:null,r=this.loadFromPortal({supportedTypes:["Video Service"],supportsData:!1},e).catch(a).then(()=>this._fetchService(t));return this.addResolvingPromise(r),Promise.resolve(this)}get autoplay(){return this.controller?.autoplay??!1}set autoplay(e){this.controller.autoplay=e}get buffered(){return this.controller.buffered}readCapabilitiesFromService(e,t){return M(t)}readConnectionInfo(e,t){const r=Object.values(t.connectionUrl);return r?.length&&(this.controller.playerUrl=r[0]),t.connectionUrl}get currentTime(){return this.controller.currentTime}get duration(){return this.controller.duration}get ended(){return this.controller.ended}get frameHorizonPoints(){return J(this.metadata)}get groundControlPoints(){return R(this.metadata)}get isLive(){return this.controller?.isLive??!1}get livestreamStatus(){return this.controller?.livestreamStatus}get loop(){return this.controller.loop}set loop(e){this.controller.loop=e}get metadata(){return this.controller?.currentMetadata}get mimeType(){return this.controller?.mimeType}get muted(){return this.controller.muted}set muted(e){this.controller.muted=e}get parsedUrl(){return U(this)}get playbackRate(){return this.controller.rate}set playbackRate(e){this.controller.rate=e}get playerUrl(){return this.controller.playerUrl}get playing(){return this.controller.playing}get started(){return this.controller?.started??!1}get state(){return this.controller.state}get telemetry(){return _(this.metadata)}readTitleFromService(e,{name:t}){return this.url?C(this.url,t):t}get videoElement(){return this.controller?.element}get videoHeight(){return this.controller?.videoHeight}readLayerInfosFromService(e,t){return z(t)}get videoTimeExtent(){return o(s.getLogger(this),"videoTimeExtent",{replacement:"fullTimeExtent",version:"4.33",warnOnce:!0}),this.fullTimeExtent}get videoWidth(){return this.controller?.videoWidth}get volume(){return this.controller?.volume??0}set volume(e){this.controller.volume=e}get waiting(){return this.controller.waiting}play(){this.controller.play()}pause(){this.controller.pause()}reset(){this._trailPoints=[],this.controller.reset()}setCurrentTime(e){if(this.duration<0)return;const t=l(e,0,this.duration);this.controller.setCurrentTime(t)}toGround(e,t){return this.controller?.sensorModel?.metadataSupportsTransforms?this.controller.sensorModel.transformImageToGeo(e,t):null}toVideo(e){if(!this.controller?.sensorModel?.metadataSupportsTransforms)return null;const t=this.controller.sensorModel.transformGeoToImage(e.x,e.y,e.z);return{x:t[0],y:t[1]}}updateTelemetryColor(e){this.frameCenterSymbol=A(this.frameCenterSymbol,e)??re,this.frameOutlineSymbol=A(this.frameOutlineSymbol,e,te)??oe,this.sensorSightLineSymbol=A(this.sensorSightLineSymbol,e)??ie,this.sensorTrailSymbol=A(this.sensorTrailSymbol,e)??le,this.sensorSymbol=A(this.sensorSymbol,e)??se}write(e,t){return null==this.layerId?(t?.messages?.push(new i("layer:unsupported",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' cannot be saved to a web map, web scene, or portal item. The ArcGIS server version must be greater than 11.2.`)),null):super.write(e,t)}async _fetchService(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:t,ssl:o}=await r(this.url,{query:{f:"json",...this.parsedUrl.query,...this.customParameters},signal:e});if(o&&(this.url=this.url.replace(/^http:/i,"https:")),!t?.currentVersion)return t.currentVersion="11.2",this.sourceJSON=t,void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});if(this.layerId??=t.layers?.[0]?.id??null,null==this.layerId)throw new i("arcgis-layers:url-mismatch","The url is not a valid arcgis resource");const{data:s}=await r(this.parsedUrl.path,{query:{f:"json",...this.customParameters},signal:e});this.sourceJSON={...t,...s},this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl})}_setSensorTrail(e){if(!e)return;const t=q(e,this._trailPoints);this._trailPoints=[...t];const r=this._trailPoints.map(e=>e.toArray()),o=new v({hasZ:e.hasZ,paths:[r]});this.telemetry.sensorTrail=o.clone()}};e([u({type:Boolean,json:{write:{ignoreOrigin:!0}}})],pe.prototype,"autoplay",null),e([u({readOnly:!0})],pe.prototype,"buffered",null),e([u({readOnly:!0})],pe.prototype,"cameraInfo",void 0),e([u({readOnly:!0,json:{read:!1}})],pe.prototype,"capabilities",void 0),e([c("service","capabilities",["supportsAppend","supportsCoverageQuery","supportsExportClip","supportsExportFrameset","supportsMensuration","supportsPreviews","supportsUpdate"])],pe.prototype,"readCapabilitiesFromService",null),e([u({readOnly:!0})],pe.prototype,"codecs",void 0),e([u({readOnly:!0})],pe.prototype,"connectionInfo",void 0),e([c("connectionInfo",["connectionUrl"])],pe.prototype,"readConnectionInfo",null),e([u()],pe.prototype,"controller",void 0),e([u({type:String})],pe.prototype,"copyright",void 0),e([u({readOnly:!0,type:Date})],pe.prototype,"created",void 0),e([u({type:Number})],pe.prototype,"currentTime",null),e([u({json:{write:!1}})],pe.prototype,"customParameters",void 0),e([u({type:String})],pe.prototype,"description",void 0),e([u({type:Number})],pe.prototype,"duration",null),e([u({readOnly:!0})],pe.prototype,"elevationSource",void 0),e([u({type:Boolean})],pe.prototype,"ended",null),e([u({type:F})],pe.prototype,"frame",void 0),e([u(ae("drawingInfo.frameCenterSymbol",Z))],pe.prototype,"frameCenterSymbol",void 0),e([u({readOnly:!0,type:d})],pe.prototype,"frameCount",void 0),e([u(j)],pe.prototype,"frameEffect",void 0),e([u(P)],pe.prototype,"frameOpacity",void 0),e([u(ae("drawingInfo.frameOutlineSymbol",Q))],pe.prototype,"frameOutlineSymbol",void 0),e([u({type:f})],pe.prototype,"fullExtent",void 0),e([u({readOnly:!0})],pe.prototype,"frameHorizonPoints",null),e([u({readOnly:!0,json:{read:{reader:D,source:"time"}},type:G})],pe.prototype,"fullTimeExtent",void 0),e([u({readOnly:!0})],pe.prototype,"groundControlPoints",null),e([u(x)],pe.prototype,"id",void 0),e([u({type:f})],pe.prototype,"initialExtent",void 0),e([u({readOnly:!0})],pe.prototype,"isLive",null),e([u({type:d,json:{read:!1,origins:{service:{read:{source:"id"}}}}})],pe.prototype,"layerId",void 0),e([u({readOnly:!0})],pe.prototype,"livestreamStatus",null),e([u({type:Boolean})],pe.prototype,"loop",null),e([u({readOnly:!0})],pe.prototype,"metadata",null),e([u({readOnly:!0})],pe.prototype,"mimeType",null),e([u({type:Boolean,json:{write:{ignoreOrigin:!0}}})],pe.prototype,"muted",null),e([u({type:["ArcGISVideoLayer"]})],pe.prototype,"operationalLayerType",void 0),e([u({readOnly:!0})],pe.prototype,"parsedUrl",null),e([u({type:N})],pe.prototype,"playbackInfo",void 0),e([u({type:Number})],pe.prototype,"playbackRate",null),e([u({readOnly:!0,type:String})],pe.prototype,"playerUrl",null),e([u({readOnly:!0})],pe.prototype,"playing",null),e([u({readOnly:!0,json:{read:{source:"poster"}}})],pe.prototype,"posterUrl",void 0),e([u({readOnly:!0})],pe.prototype,"qualities",void 0),e([u()],pe.prototype,"sensorSymbolOrientation",void 0),e([u(ne)],pe.prototype,"sensorSymbol",void 0),e([u(ae("drawingInfo.sensorSightLineSymbol",$))],pe.prototype,"sensorSightLineSymbol",void 0),e([u(ae("drawingInfo.sensorTrailSymbol",$))],pe.prototype,"sensorTrailSymbol",void 0),e([u({readOnly:!0})],pe.prototype,"serviceItemId",void 0),e([u()],pe.prototype,"sourceJSON",void 0),e([u({readOnly:!0})],pe.prototype,"sourceQuality",void 0),e([u({readOnly:!0,json:{name:"serviceType"}})],pe.prototype,"sourceType",void 0),e([u()],pe.prototype,"spatialReference",void 0),e([u({json:{write:!0}})],pe.prototype,"start",void 0),e([u({readOnly:!0})],pe.prototype,"started",null),e([u({readOnly:!0,type:String})],pe.prototype,"state",null),e([u({readOnly:!0,type:k})],pe.prototype,"telemetry",null),e([u({type:V,nonNullable:!0,json:{write:{ignoreOrigin:!0}}})],pe.prototype,"telemetryDisplay",void 0),e([c("service","title",["name"])],pe.prototype,"readTitleFromService",null),e([u({readOnly:!0})],pe.prototype,"type",void 0),e([u(E())],pe.prototype,"url",void 0),e([u({readOnly:!0,type:Number,json:{read:{source:"currentVersion"}}})],pe.prototype,"version",void 0),e([u({readOnly:!0})],pe.prototype,"videoElement",null),e([u({readOnly:!0})],pe.prototype,"videoHeight",null),e([u({readOnly:!0,json:{read:!1}})],pe.prototype,"videoLayersInfo",void 0),e([c("service","videoLayersInfo",["id","name","poster","serviceType","type"])],pe.prototype,"readLayerInfosFromService",null),e([u({type:G,readOnly:!0})],pe.prototype,"videoTimeExtent",null),e([u({readOnly:!0})],pe.prototype,"videoWidth",null),e([u()],pe.prototype,"volume",null),e([u({readOnly:!0})],pe.prototype,"waiting",null),pe=e([h("esri.layers.VideoLayer")],pe);const ye=pe;export{ye as default};
