/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import{__decorate as e}from"tslib";import{watch as r,sync as t}from"../../core/reactiveUtils.js";import{property as i}from"../../core/accessorSupport/decorators/property.js";import"../../core/has.js";import"../../core/Logger.js";import"../../core/RandomLCG.js";import{subclass as s}from"../../core/accessorSupport/decorators/subclass.js";import a from"../../graphic/AggregateGraphicOrigin.js";import o from"../support/AggregateField.js";import{featureReductionProperty as n}from"../support/featureReductionUtils.js";import u from"../../renderers/SimpleRenderer.js";import l from"../../renderers/visualVariables/SizeVariable.js";import c from"../../renderers/visualVariables/support/SizeStop.js";import{createInferredClusterRenderer as d}from"../../views/2d/layers/support/clusterUtils.js";const f=f=>{const p=f;let m=class extends p{constructor(...e){super(...e),this.aggregateGraphicOrigin=new a(this),this.addHandles(r(()=>this.renderer,()=>{if(this.featureReduction){const e=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",e)}},t))}set featureReduction(e){const r=this._normalizeFeatureReduction(e);this._set("featureReduction",r)}set renderer(e){}_withClusterVariable(e,r,t){const i=e.clone();if("visualVariables"in i){i.visualVariables||(i.visualVariables=[]);i.visualVariables.some(e=>"size"===e.type)||i.visualVariables.push(new l({field:"cluster_count",stops:[new c({value:1}),new c({useMinValue:!0,size:r}),new c({useMaxValue:!0,size:t})]}))}return i}_normalizeFeatureReduction(e){if("cluster"!==e?.type)return e;const r=e.clone(),t=[new o({name:"cluster_count",alias:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],i=(r.fields??[]).filter(e=>!e.isAutoGenerated),s=e.renderer&&!e.renderer.authoringInfo?.isAutoGenerated,{clusterMinSize:a,clusterMaxSize:n}=r;if(s){r.fields=[...t,...i];const e=this._withClusterVariable(r.renderer,a,n);return r.effectiveFeatureRenderer=e,r.effectiveClusterRenderer=e,r}if(e.symbol){if(r.fields=[...t,...i],r.renderer=null,!this.renderer)return r.effectiveFeatureRenderer=null,r.effectiveClusterRenderer=null,r;const s=d(t,this.renderer),o=this._withClusterVariable(s,a,n),l="visualVariables"in o&&o.visualVariables?o.visualVariables:[],c=new u({symbol:e.symbol,visualVariables:l});return r.fields=[...t,...i],r.effectiveFeatureRenderer=o,r.effectiveClusterRenderer=c,r}if(!this.renderer)return e;const l=d(t,this.renderer);r.fields=[...t,...i],r.renderer=l;const c=this._withClusterVariable(l,a,n);return r.effectiveFeatureRenderer=c,r.effectiveClusterRenderer=c,r}};return e([i({readOnly:!0,clonable:!1})],m.prototype,"aggregateGraphicOrigin",void 0),e([i(n)],m.prototype,"featureReduction",null),m=e([s("esri.layers.mixins.FeatureReductionLayer")],m),m};export{f as FeatureReductionLayer};
