/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.34/esri/copyright.txt for details.
*/
import e from"../../../Graphic.js";import t from"../../../core/Error.js";import r from"../../../core/Logger.js";import{getOrCreateMapValue as o}from"../../../core/MapUtils.js";import{isPromiseLike as s}from"../../../core/promiseUtils.js";import{generateBracedUUID as i}from"../../../core/uuid.js";import{isLoadedSharedTemplate as a,isSharedFeatureTemplate as l,isSharedGroupTemplate as n,isSharedPresetTemplate as u}from"../../templateUtils.js";import{createFeatureServiceEdit as p}from"./support/createFeatureServiceEdit.js";import{calculateExtent as c,groupEditsByLayer as m}from"./support/executorUtils.js";import{getBuilder as d}from"./support/getBuilder.js";import{isPoint as f}from"../../../geometry/support/jsonUtils.js";import{getAssociationsTableFields as y}from"../../../networks/support/networkFieldUtils.js";const T=()=>r.getLogger("esri.editing.sharedTemplates.executor.createTemplateExecutor"),h="globalid";async function g(e){if(!a(e))throw new t("template-executor:template-not-loaded","The template must be loaded before it can be executed.");if(l(e))return I(e);if(n(e))return w(e);if(u(e))return G(e);throw new t("template-executor:unsupported-template-type","The template type is not supported.")}function I(e){return t=>{const r=[],o=[];p({geometry:t,template:e,edits:r,relationships:o});const s=c(r);return{edits:m(r),relationships:o,primary:r[0]??null,featureExtent:s,rotationPoint:s?.center??null}}}async function w(e){const{definition:t}=e,r=await Promise.all(t.allParts.map(b));return(o,i)=>{const a=[],l=[],n=new Set,u=()=>{if(t.createUtilityNetworkAssociations&&"completion"===i){const{utilityNetwork:e,utilityNetworkAssociationsTable:r}=t;e&&r?k({associationGraphics:n,associationsTable:r,edits:a,relationships:l,utilityNetworkHelper:e}):T().warn("Unable to create utility network associations between group template features. The utility network or its associations table is unavailable.")}const e=c(a);return{associationGraphics:n,edits:m(a),relationships:l,primary:a[0]??null,featureExtent:e,rotationPoint:e?.center??null}};if(null==o)return T().warn("No geometry provided to group template executor. Result will be empty."),u();const p=r.map(t=>t({edits:a,mode:i,parentTemplate:e,relationships:l,shape:o})).filter(s);return 0===p.length?u():Promise.all(p).then(()=>u())}}async function b(e){const t=await d(e.builderType);return r=>t.execute({...r,templatePart:e})}async function G(e){const{createPresetServiceEdit:r}=await import("./support/createPresetServiceEdit.js");return(o,s,i=0)=>{if(!f(o))throw new t("template-executor:invalid-input-geometry","The input geometry for a preset template must be a point.");const a=[],l=[],n=r({geometry:o,template:e,edits:a,relationships:l,rotation:i,mode:s});return{edits:m(a),relationships:l,primary:a[0]??null,featureExtent:c(a),rotationPoint:n}}}function k(e){const{edits:t,utilityNetworkHelper:r}=e,s=new Map;for(const i of t)""!==i.tag&&r.layerIdToSourceIdLookup.has(i.id)&&o(s,i.tag,()=>[]).push(i);for(const o of s.values())if(!(o.length<2))for(let t=0;t<o.length;t++){const r=o[t];for(let s=t+1;s<o.length;s++){S(r,o[s],e)}}}function S(t,r,o){const{associationGraphics:s,associationsTable:a,edits:l,utilityNetworkHelper:n,relationships:u}=o,p=n.findAgat(t.graphic,t.layer),c=n.findAgat(r.graphic,r.layer);if(!p||!c)return;const m=n.findRules(p).map(e=>e.fromNetworkSource?.sourceId!==p.networkSourceId||e.fromAssetGroup?.assetGroupCode!==p.assetGroup||null!==e.fromAssetType?.assetTypeCode&&e.fromAssetType?.assetTypeCode!==p.assetType||e.toNetworkSource.sourceId!==c.networkSourceId||e.toAssetGroup?.assetGroupCode!==c.assetGroup||null!==e.toAssetType&&e.toAssetType?.assetTypeCode!==c.assetType?e.toNetworkSource.sourceId!==p.networkSourceId||e.toAssetGroup?.assetGroupCode!==p.assetGroup||null!==e.toAssetType&&e.toAssetType?.assetTypeCode!==p.assetType||e.fromNetworkSource.sourceId!==c.networkSourceId||e.fromAssetGroup?.assetGroupCode!==c.assetGroup||null!==e.fromAssetType?.assetTypeCode&&e.fromAssetType?.assetTypeCode!==c.assetType?null:{rule:e,from:{agat:c,item:r},to:{agat:p,item:t}}:{rule:e,from:{agat:p,item:t},to:{agat:c,item:r}}).filter(e=>4===e?.rule.ruleType||5===e?.rule.ruleType||2===e?.rule.ruleType?null:e).filter(e=>null!==e);if(0===m.length)return;const d=y(a),f=new Set;for(const y of m){const t={};t[d.fromNetworkSourceId]=y.rule.fromNetworkSource.sourceId,t[d.fromGlobalId]=y.from.item.graphic.attributes[y.from.item.layer.globalIdField??h],t[d.fromTerminalId]=null,y.rule.fromTerminal&&(t[d.fromTerminalId]=y.rule.fromTerminal.terminalId),t[d.toNetworkSourceId]=y.rule.toNetworkSource.sourceId,t[d.toGlobalId]=y.to.item.graphic.attributes[y.to.item.layer.globalIdField??h],t[d.toTerminalId]=null,y.rule.toTerminal&&(t[d.toTerminalId]=y.rule.toTerminal.terminalId),t[d.associationType]=y.rule.ruleType,t[d.percentAlong]=null,t[d.isContentVisible]=2===y.rule.ruleType?1:0,t[d.status]=0,t[d.globalId]=i();const r=`${t[d.fromNetworkSourceId]}-${t[d.fromGlobalId]}-${t[d.toNetworkSourceId]}-${t[d.toGlobalId]}-${t[d.associationType]}`;if(f.has(r))continue;f.add(r);const o=new e({attributes:t,sourceLayer:a});s.add(o),l.push({id:a.layerId,graphic:o,tag:"",layer:a}),u.push({sourceGraphic:y.to.item.graphic,sourceLayerId:y.to.item.layer.layerId,destinationGraphic:o,destinationLayerId:a.layerId,sourceField:y.to.item.layer.globalIdField??h,destinationField:d.toGlobalId??h}),u.push({sourceGraphic:y.from.item.graphic,sourceLayerId:y.from.item.layer.layerId,destinationGraphic:o,destinationLayerId:a.layerId,sourceField:y.from.item.layer.globalIdField??h,destinationField:d.fromGlobalId??h})}}export{g as createTemplateExecutor};
